# Story 2.8: Visualizar Métricas Simples

## Status: Draft

## Story

- As a Gerente de Restaurante
- I want visualizar métricas simples em um dashboard, como o total de pedidos por dia e os produtos mais vendidos
- so that eu possa entender o desempenho do meu restaurante rapidamente

## Acceptance Criteria (ACs)

### Backend & APIs

1. **AC 2.8.1:** Deve existir método `static Order.getMetrics(period: 'today' | 'last7days')` que retorna métricas agregadas: total de pedidos, receita total (usando campo `total` da tabela `orders`, já com desconto aplicado), média de pedidos por dia (quando período = 'last7days'). **Nota:** Período 'last7days' deve incluir os últimos 7 dias completos incluindo hoje (hoje + 6 dias anteriores). Cálculo deve considerar timezone UTC para consistência.
2. **AC 2.8.2:** Deve existir método `static Order.getTopProducts(period: 'today' | 'last7days', limit: number)` que retorna lista de produtos mais vendidos com: nome do produto, quantidade total vendida, receita total do produto. **Nota:** Apenas produtos ativos (`status = 'Ativo'`) devem ser incluídos na lista.
3. **AC 2.8.3:** O método `getTopProducts()` deve agregar vendas por `product_id` usando dados de `order_items`, ordenando por quantidade total vendida (mais vendidos primeiro). Em caso de empate completo (quantidade e receita iguais), ordenar por nome do produto (alfabética) para garantir ordem consistente.
4. **AC 2.8.4:** Devem existir rotas protegidas (role admin) em `/api/admin/metrics` (GET com query param `period`) e `/api/admin/metrics/top-products` (GET com query params `period` e `limit`).
5. **AC 2.8.5:** Todas operações devem ter timeout de 30 segundos e registrar logs estruturados com prefixo `admin-metrics`. Se timeout ocorrer, deve exibir toast de erro com mensagem padrão "Tempo de espera esgotado. Tente novamente.", exibir spinner durante operação, e permitir retry.
6. **AC 2.8.6:** As métricas devem considerar apenas pedidos com `status` diferente de cancelado (não há status cancelado no sistema atual, mas preparar para futuro). Por padrão, considerar todos os pedidos independente do status.

### Frontend

7. **AC 2.8.7:** Deve existir página `/admin` (Dashboard) como página principal do painel de administração, protegida por auth admin. Esta página deve ser acessível via link "Dashboard" na sidebar ou como rota padrão após login.
8. **AC 2.8.8:** O dashboard deve exibir cards de métricas principais:
   - Card "Total de Pedidos" com número grande e período selecionado
   - Card "Receita Total" com valor formatado em R$ e período selecionado
   - Card "Média Diária" (apenas quando período = 'last7days') com média de pedidos por dia
9. **AC 2.8.9:** Deve haver seletor de período (tabs ou botões) com opções: "Hoje" e "Últimos 7 dias". Período padrão deve ser "Hoje".
10. **AC 2.8.10:** Ao alterar período, os cards de métricas devem atualizar automaticamente (refetch de dados).
11. **AC 2.8.11:** Deve exibir seção "Produtos Mais Vendidos" com lista dos top 10 produtos (ou menos se houver menos produtos).
12. **AC 2.8.12:** Cada item da lista deve mostrar: Posição (1, 2, 3...), Nome do Produto, Quantidade Vendida, Receita do Produto (formatado em R$).
13. **AC 2.8.13:** A lista deve ser ordenada por quantidade vendida (mais vendidos primeiro). Em caso de empate, ordenar por receita total. Em caso de empate completo (quantidade e receita iguais), ordenar por nome do produto (alfabética).
14. **AC 2.8.14:** A página deve ter estados de loading independentes (skeleton para cards e lista separadamente), estado vazio quando não há pedidos no período, estado vazio específico para produtos quando não há produtos vendidos, e tratamento de erros com toast.
15. **AC 2.8.15:** Cards de métricas devem ter ícones visuais (ex: ícone de pedido, ícone de dinheiro) e cores distintas para melhor identificação visual.
16. **AC 2.8.16:** Deve exibir badge indicando período selecionado no topo da página (ex: "Métricas de Hoje" ou "Métricas dos Últimos 7 Dias").

### Infraestrutura

17. **AC 2.8.17:** As tabelas `orders` e `order_items` já possuem RLS configurado (Stories 2.6, 2.7). Verificar que admins podem ler todos os pedidos e itens para cálculo de métricas.
18. **AC 2.8.18:** As queries devem usar índices existentes (`created_at` em `orders`, `product_id` em `order_items`) para otimizar performance.
19. **AC 2.8.19:** Métricas devem ser calculadas em tempo real (não usar cache) para garantir dados sempre atualizados.
20. **AC 2.8.20:** A agregação de produtos mais vendidos deve ser feita via SQL usando GROUP BY na query do Supabase para garantir performance adequada, não em memória após buscar todos os order_items.
21. **AC 2.8.21:** O cálculo de períodos deve considerar timezone do servidor (UTC) para consistência. Período 'today' deve ser calculado como: início do dia atual em UTC (00:00:00 UTC) até agora em UTC. Período 'last7days' deve ser calculado como: 7 dias atrás em UTC até agora em UTC.
22. **AC 2.8.22:** A lista de produtos mais vendidos deve incluir apenas produtos ativos (`status = 'Ativo'`). Produtos com `status = 'Inativo'` não devem aparecer na lista, mesmo que tenham vendas históricas no período.
23. **AC 2.8.23:** O parâmetro `limit` deve ser validado: mínimo 1, máximo 50. Se valor inválido for passado, retornar erro de validação. Valor padrão deve ser 10 se não especificado.
24. **AC 2.8.24:** A média diária de pedidos deve ser exibida com 1 casa decimal (ex: '2.1 pedidos/dia'). Se média for exata, pode ser exibida sem decimais (ex: '2 pedidos/dia').
25. **AC 2.8.25:** Se não houver produtos vendidos no período (caso edge), a seção 'Produtos Mais Vendidos' deve exibir mensagem 'Nenhum produto vendido neste período.' ao invés de lista vazia.
26. **AC 2.8.26:** O dashboard deve ser acessível via teclado (Tab para navegar entre cards e lista, Enter para ativar seletor de período) e ter labels apropriados para screen readers (ex: 'Card Total de Pedidos: 50 pedidos').
27. **AC 2.8.27:** Cards de métricas e lista de produtos mais vendidos devem ter loading independente. Se métricas carregarem primeiro, exibir cards e manter skeleton na lista até produtos carregarem. Se produtos carregarem primeiro, exibir lista e manter skeleton nos cards até métricas carregarem.

## Tasks / Subtasks

- [ ] **Task 1: Estender entidade Order**
  - [ ] Subtask 1.1: Adicionar método `static getMetrics(period: 'today' | 'last7days')` que calcula métricas agregadas
  - [ ] Subtask 1.2: Criar tipo `MetricsSummary` com campos: totalOrders, totalRevenue, averageOrdersPerDay (opcional)
  - [ ] Subtask 1.3: Implementar cálculo de período: "today" = pedidos de hoje em UTC (00:00 UTC até agora UTC), "last7days" = últimos 7 dias incluindo hoje em UTC (7 dias atrás UTC até agora UTC) (AC 2.8.1, 2.8.21)
  - [ ] Subtask 1.4: Implementar timeout (30s), logs estruturados (`admin-metrics`), mensagens de erro
  - [ ] Subtask 1.5: Adicionar método `static getTopProducts(period: 'today' | 'last7days', limit: number)` que agrega por `product_id`
  - [ ] Subtask 1.6: Criar tipo `TopProduct` com campos: productId, productName, totalQuantity, totalRevenue, position
  - [ ] Subtask 1.7: Implementar agregação de `order_items` por `product_id` usando SQL GROUP BY com SUM de `quantity` e SUM de `total_price`, filtrando apenas produtos ativos (`status = 'Ativo'`) (AC 2.8.3, 2.8.20, 2.8.22)
  - [ ] Subtask 1.8: Implementar ordenação por quantidade vendida (DESC), depois por receita total (DESC), depois por nome do produto (alfabética) em caso de empate completo (AC 2.8.3, 2.8.13)
  - [ ] Subtask 1.9: Validar parâmetro `limit` (mínimo 1, máximo 50, padrão 10) (AC 2.8.23)

- [ ] **Task 2: Criar API Routes protegidas**
  - [ ] Subtask 2.1: `GET /api/admin/metrics?period={today|last7days}` para buscar métricas gerais
  - [ ] Subtask 2.2: `GET /api/admin/metrics/top-products?period={today|last7days}&limit={10}` para buscar produtos mais vendidos
  - [ ] Subtask 2.3: Adicionar verificação de role admin em todas as rotas
  - [ ] Subtask 2.4: Validar parâmetros de período (apenas 'today' ou 'last7days') e limit (1-50, padrão 10) (AC 2.8.23)
  - [ ] Subtask 2.5: Tratamento de erros (RLS, network, timeout, validação)
  - [ ] Subtask 2.6: Logs estruturados de sucesso/falha com contexto completo (period, limit, adminId)

- [ ] **Task 3: UI do Dashboard (`/admin`)**
  - [ ] Subtask 3.1: Criar página `app/admin/(protected)/page.tsx` (Dashboard principal)
  - [ ] Subtask 3.2: Implementar seletor de período com tabs/botões: "Hoje" e "Últimos 7 dias"
  - [ ] Subtask 3.3: Implementar badge de período no topo ("Métricas de Hoje" ou "Métricas dos Últimos 7 Dias")
  - [ ] Subtask 3.4: Implementar cards de métricas:
    - Card "Total de Pedidos" com número grande e ícone
    - Card "Receita Total" com valor formatado (R$ X.XXX,XX) e ícone
    - Card "Média Diária" (condicional, apenas para 'last7days')
  - [ ] Subtask 3.5: Implementar seção "Produtos Mais Vendidos" com lista dos top 10
  - [ ] Subtask 3.6: Cada item da lista: Posição (badge numérico), Nome, Quantidade Vendida, Receita (formatado)
  - [ ] Subtask 3.7: Estados de loading independentes (skeleton para cards e lista separadamente) (AC 2.8.27)
  - [ ] Subtask 3.8: Estado vazio quando não há pedidos no período e estado vazio específico para produtos (AC 2.8.25)
  - [ ] Subtask 3.9: Integração com `Toast` para feedback de erros
  - [ ] Subtask 3.10: Refetch automático ao alterar período
  - [ ] Subtask 3.11: Implementar acessibilidade do dashboard (teclado, screen readers) (AC 2.8.26)

- [ ] **Task 4: Estilização e UX**
  - [ ] Subtask 4.1: Cards de métricas com cores distintas e ícones visuais (lucide-react)
  - [ ] Subtask 4.2: Layout responsivo (grid de cards em desktop, coluna única em mobile)
  - [ ] Subtask 4.3: Lista de produtos com hover effects e separadores visuais
  - [ ] Subtask 4.4: Badge de posição com estilo destacado (ex: #1 em dourado, #2 em prata, #3 em bronze, outros em cinza)
  - [ ] Subtask 4.5: Formatação de valores monetários com `Intl.NumberFormat` (R$ X.XXX,XX)
  - [ ] Subtask 4.6: Formatação de números grandes (ex: 1.234 pedidos)
  - [ ] Subtask 4.7: Formatar média diária com 1 casa decimal (AC 2.8.24)

- [ ] **Task 5: Testes**
  - [ ] Subtask 5.1: Unit tests para `Order.getMetrics()` (período hoje, últimos 7 dias, cálculo correto)
  - [ ] Subtask 5.2: Unit tests para `Order.getTopProducts()` (agregação correta, ordenação, limite)
  - [ ] Subtask 5.3: Integration tests para APIs (buscar métricas, buscar top produtos, verificar RLS)
  - [ ] Subtask 5.4: Build passa sem erros TypeScript
  - [ ] Subtask 5.5: Documentação atualizada

## Dev Notes

### Contexto Técnico

**Tabelas Supabase:**
- **`orders`:** Campos relevantes: `id`, `status`, `total`, `created_at`
- **`order_items`:** Campos relevantes: `id`, `order_id`, `product_id`, `product_name`, `quantity`, `total_price`, `created_at`
- Relacionamento: `order_items.order_id` → `orders.id` (N:1)

**Classe Existente: `src/domain/entities/Order.ts`**
- Já possui: `getAll(filters)`, `findById()`, `findByPhone()`, `findByCustomer()`, `getCustomerOrders()`
- Precisa ser estendida com: `getMetrics()`, `getTopProducts()`

**Padrões de Implementação (baseado em Stories 2.2-2.7):**
- APIs protegidas com verificação de role admin via Supabase Auth
- Logs estruturados com prefixo específico (`admin-metrics`)
- Timeout de 30s em todas operações
- Toast notifications para feedback ao usuário
- Estados de loading e erro bem definidos

**Integrações:**
- **AdminSidebar:** Dashboard já deve estar como primeiro item ou página padrão após login
- **Story 2.6:** Métodos `Order.getAll()` podem ser reutilizados para buscar pedidos por período

### Cálculo de Métricas

**Timezone:**

Todos os cálculos de período devem usar UTC para consistência:
- Período "today": início do dia atual em UTC (00:00:00 UTC) até agora em UTC
- Período "last7days": 7 dias atrás em UTC até agora em UTC (incluindo hoje)

**Período "Hoje":**
- Data inicial: início do dia atual em UTC (00:00:00 UTC)
- Data final: agora em UTC
- Query: `created_at >= inicio_do_dia_utc AND created_at <= agora_utc`

**Período "Últimos 7 Dias":**
- Data inicial: 7 dias atrás em UTC (00:00:00 UTC)
- Data final: agora em UTC (incluindo hoje)
- Query: `created_at >= 7_dias_atras_utc AND created_at <= agora_utc`

**Métricas a Calcular:**
- `totalOrders`: COUNT de pedidos no período
- `totalRevenue`: SUM de `total` dos pedidos no período (campo `total` já inclui desconto de cupom aplicado)
- `averageOrdersPerDay`: `totalOrders / 7` (apenas para 'last7days'), formatado com 1 casa decimal

**Agregação via SQL GROUP BY:**

A agregação deve ser feita diretamente na query SQL para garantir performance:

```sql
SELECT 
  oi.product_id,
  MAX(oi.product_name) as product_name,
  SUM(oi.quantity) as total_quantity,
  SUM(oi.total_price) as total_revenue
FROM order_items oi
INNER JOIN orders o ON oi.order_id = o.id
INNER JOIN products p ON oi.product_id = p.id
WHERE o.created_at >= :start_date
  AND o.created_at <= :end_date
  AND p.status = 'Ativo'
GROUP BY oi.product_id
ORDER BY total_quantity DESC, total_revenue DESC, product_name ASC
LIMIT :limit
```

**Produtos Inativos:**

Apenas produtos ativos (`status = 'Ativo'`) devem aparecer na lista de produtos mais vendidos. Produtos com `status = 'Inativo'` não devem aparecer na lista, mesmo que tenham vendas históricas no período.

**Empate na Ordenação:**

Em caso de empate completo (quantidade e receita iguais), ordenar por nome do produto (alfabética) para garantir ordem consistente.

### UX / Acessibilidade

**Cards de Métricas:**
- Layout: Grid de 2-3 colunas em desktop, 1 coluna em mobile
- Estilo: Cards com sombra, padding, bordas arredondadas
- Ícones: Lucide-react (ShoppingBag para pedidos, DollarSign para receita, TrendingUp para média)
- Cores: Azul para pedidos, verde para receita, roxo para média

**Lista de Produtos Mais Vendidos:**
- Layout: Lista vertical com separadores
- Badge de posição: Números grandes e destacados (#1, #2, #3...)
- Hover: Efeito de elevação ao passar mouse
- Responsivo: Scroll horizontal em mobile se necessário

**Seletor de Período:**
- Tabs ou botões com estado ativo destacado
- Transição suave ao alterar período
- Loading durante refetch

### Performance

**Otimizações:**
- Usar índices existentes em `created_at` e `product_id`
- Limitar resultados de produtos mais vendidos (padrão 10)
- Calcular métricas em uma única query quando possível
- Considerar cache futuro (não obrigatório nesta story)

### Testing

Dev Note: Story Requires the following tests:

- [x] Jest Unit Tests: location: next to entity (`src/domain/entities/Order.test.ts`), coverage requirement: 80%
  - `getMetrics()` com período 'today' e 'last7days'
  - Cálculo correto de totalOrders, totalRevenue, averageOrdersPerDay
  - `getTopProducts()` com agregação correta por product_id
  - Ordenação por quantidade vendida e receita
  - Limite de resultados funcionando

- [x] Jest Integration Tests: location: `/tests/admin/metrics/` or next to API routes
  - `GET /api/admin/metrics?period={today|last7days}` (métricas corretas)
  - `GET /api/admin/metrics/top-products?period={today|last7days}&limit={10}` (top produtos)
  - RLS verification (admin only)
  - Timeout handling
  - Validação de parâmetros de período

- [x] Manual Testing: (Via UI)

Manual Test Steps:

1. Fazer login como admin → acessar `/admin` (Dashboard)
2. Verificar estado inicial:
   - ✅ Dashboard carrega sem erros
   - ✅ Período padrão é "Hoje"
   - ✅ Cards de métricas aparecem com valores
   - ✅ Lista de produtos mais vendidos aparece
3. Verificar cards de métricas para "Hoje":
   - ✅ Card "Total de Pedidos" mostra número correto de pedidos de hoje
   - ✅ Card "Receita Total" mostra soma correta formatada em R$
   - ✅ Card "Média Diária" não aparece (apenas para últimos 7 dias)
4. Alterar período para "Últimos 7 dias":
   - ✅ Cards atualizam automaticamente
   - ✅ Card "Média Diária" aparece com cálculo correto (total / 7)
   - ✅ Badge no topo muda para "Métricas dos Últimos 7 Dias"
5. Verificar lista de produtos mais vendidos:
   - ✅ Lista mostra até 10 produtos
   - ✅ Produtos ordenados por quantidade vendida (mais vendidos primeiro)
   - ✅ Cada item mostra: Posição (#1, #2...), Nome, Quantidade, Receita
   - ✅ Badges de posição têm cores distintas (#1 dourado, #2 prata, #3 bronze)
6. Alterar período e verificar que lista atualiza:
   - ✅ "Hoje" → produtos vendidos hoje
   - ✅ "Últimos 7 dias" → produtos vendidos nos últimos 7 dias
7. Simular timeout (forçar delay) → verificar toast "Tempo de espera esgotado. Tente novamente.", spinner desaparece, retry funciona
8. **Teste estado vazio:**
   - ✅ Criar período sem pedidos (ex: futuro) → mensagem "Nenhum pedido neste período"
   - ✅ Criar período com pedidos mas sem produtos vendidos → mensagem "Nenhum produto vendido neste período" na seção de produtos
9. **Teste produtos inativos:**
   - ✅ Criar produto, fazer pedidos, marcar produto como 'Inativo' → produto não aparece na lista de mais vendidos
10. **Teste validação de limit:**
    - ✅ Passar `limit=0` → erro de validação
    - ✅ Passar `limit=100` → erro de validação (máximo 50)
    - ✅ Passar `limit=10` → retorna 10 produtos
    - ✅ Não passar `limit` → retorna 10 produtos (padrão)
11. **Teste loading independente:**
    - ✅ Simular métricas rápidas e produtos lentos → cards aparecem primeiro, skeleton na lista
    - ✅ Simular produtos rápidos e métricas lentas → lista aparece primeiro, skeleton nos cards
12. **Teste acessibilidade:**
    - ✅ Navegar com Tab → foco move entre cards e lista
    - ✅ Pressionar Enter no seletor de período → período muda
    - ✅ Verificar labels ARIA → screen reader lê corretamente
13. **Teste formatação de média diária:**
    - ✅ 15 pedidos em 7 dias → exibe "2.1 pedidos/dia"
    - ✅ 14 pedidos em 7 dias → exibe "2 pedidos/dia"
14. **Teste RLS (sem autenticação):**
   - ✅ Abrir console do navegador → tentar `supabase.from('orders').select()` sem auth → erro "permission denied"
15. **Teste RLS (com autenticação não-admin):**
    - ✅ Criar usuário comum (não admin) → fazer login
    - ✅ Tentar acessar `/admin` → redirecionado para login ou erro 403
16. **Teste responsividade:**
    - ✅ Redimensionar janela → cards se reorganizam (grid → coluna única)
    - ✅ Lista de produtos permanece legível em mobile

## Dev Agent Record

### Agent Model Used: {{Agent Model Name/Version}}

### Debug Log References

[[LLM: (Dev Agent) If the debug is logged to during the current story progress, create a table with the debug log and the specific task section in the debug log - do not repeat all the details in the story]]

### Completion Notes List

[[LLM: (Dev Agent) Anything the SM needs to know that deviated from the story that might impact drafting the next story.]]

### Change Log

[[LLM: (Dev Agent) Track document versions and changes during development that deviate from story dev start]]

| Date | Version | Description | Author |
| :--- | :------ | :---------- | :----- |
| 2024 | v1.0 | Story inicial criada | SM |
| 2024 | v1.1 | Correções da PO Review aplicadas: AC 2.8.1 clarificado (receita usando campo `total`, período 'last7days' incluindo hoje, timezone UTC), AC 2.8.2 clarificado (apenas produtos ativos), AC 2.8.3 expandido (empate completo), ACs 2.8.20-2.8.27 adicionados (agregação SQL, timezone UTC, produtos deletados, validação limit, formatação média, estado vazio produtos, acessibilidade, loading independente). Tasks atualizadas (cálculo período UTC, agregação SQL GROUP BY, filtro produtos ativos, ordenação empate completo, validação limit, loading independente, estado vazio produtos, acessibilidade, formatação média). Dev Notes expandidos (agregação SQL GROUP BY com exemplo completo, timezone UTC, produtos deletados, empate completo). Manual tests expandidos (produtos deletados, validação limit, loading independente, acessibilidade, formatação média). | PO Review |

