# Story 1.5: Acompanhar Status do Pedido

## Status: Review

**Última atualização:** 2024 - Implementação concluída

## Story

- As a Cliente do Restaurante
- I want acompanhar o status do meu pedido em tempo real em uma página de acompanhamento
- so that eu saiba quando meu pedido foi recebido, está em preparo e está pronto

## Acceptance Criteria (ACs)

1. **AC 1.5.1:** Após finalizar o pedido (Story 1.4), o cliente deve ser direcionado automaticamente para esta página com o ID do pedido na URL (`/tracking/{orderId}`).
2. **AC 1.5.2:** A página deve permitir que um cliente insira seu número de telefone para buscar e recuperar o status de um pedido ativo. **Nota:** Se o cliente acessar a página diretamente sem ID do pedido, deve ver a tela de busca por telefone.
3. **AC 1.5.3:** A página deve exibir o status atual do pedido de forma visual clara: "Recebido", "Em Preparo" ou "Pronto".
4. **AC 1.5.4:** A atualização de status na página do cliente deve ocorrer em tempo real (via Supabase Realtime Subscription) assim que a equipe alterar o status no App Desktop (História 3.2). **Nota:** A alteração de status será feita pela equipe no App Desktop (Story 3.2). Até lá, pode ser testada alterando status diretamente no Supabase.
5. **AC 1.5.5:** A página deve exibir informações básicas do pedido: número do pedido (ID), data/hora de criação, modalidade (Retirada ou Consumo no Local), e total.
6. **AC 1.5.6:** Se o pedido não for encontrado, a página deve exibir mensagem apropriada:
   - Se ID inválido na URL (não UUID válido): "ID do pedido inválido"
   - Se ID válido mas não existe no banco: "Pedido não encontrado"
   - Se telefone não corresponde a pedido ativo: "Nenhum pedido ativo encontrado para este telefone"
7. **AC 1.5.7:** Se houver erro ao buscar pedido no Supabase (ex: erro de rede), a página deve exibir mensagem de erro apropriada e permitir tentar novamente.
8. **AC 1.5.8:** A página deve exibir um indicador de carregamento enquanto busca dados do pedido do Supabase.
9. **AC 1.5.9:** A busca por telefone deve validar o formato do telefone (mesma validação da Story 1.4) e exibir mensagem de erro se inválido.
10. **AC 1.5.10:** Se múltiplos pedidos ativos forem encontrados para um telefone, a página deve exibir lista de pedidos ativos ordenados por data de criação (mais recente primeiro) e permitir selecionar qual pedido acompanhar.
11. **AC 1.5.11:** A página deve ser responsiva e funcionar bem em diferentes tamanhos de tela (mobile, tablet, desktop).
12. **AC 1.5.12:** A interface visual do status deve usar indicadores visuais claros (ex: ícones, cores, progresso) para mostrar em qual estágio o pedido está.
13. **AC 1.5.13:** Ao buscar pedido por telefone, deve ser exibido indicador de carregamento durante a busca.
14. **AC 1.5.14:** A página deve ser acessível via teclado (navegação por Tab, Enter para submeter formulário) e ter labels apropriados para screen readers.
15. **AC 1.5.15:** Se o pedido já estiver com status "Pronto", a página deve exibir mensagem adicional informativa (ex: "Seu pedido está pronto! Você pode retirar na recepção." para Retirada ou "Seu pedido está pronto! Aguarde o garçom." para Consumo no Local).
16. **AC 1.5.16:** A página deve permitir que o cliente busque outro pedido (botão "Buscar outro pedido" ou similar) sem precisar navegar para outra página.
17. **AC 1.5.17:** A busca por telefone deve retornar apenas pedidos com status 'Recebido' ou 'Em Preparo', ou pedidos com status 'Pronto' criados há menos de 2 horas. Pedidos 'Pronto' mais antigos não devem aparecer na busca (considerar finalizados).
18. **AC 1.5.18:** Se houver timeout ao buscar pedido no Supabase (ex: rede lenta, Supabase temporariamente indisponível), o sistema deve exibir mensagem de erro apropriada (ex: "Tempo de espera esgotado. Tente novamente.") após período razoável (ex: 30 segundos) e permitir tentar novamente.
19. **AC 1.5.19:** Se a conexão Realtime for perdida durante o acompanhamento do pedido, o sistema deve exibir mensagem informativa (ex: "Conexão perdida. Tentando reconectar...") e tentar reconectar automaticamente. Se reconexão falhar após múltiplas tentativas (ex: 3 tentativas), o sistema deve exibir mensagem e permitir atualização manual através de botão "Atualizar".
20. **AC 1.5.20:** Se o ID do pedido na URL for inválido (não UUID válido ou malformado), a página deve validar o formato antes de buscar no Supabase e exibir mensagem de erro apropriada (ex: "ID do pedido inválido") sem tentar buscar no banco.
21. **AC 1.5.21:** Para pedidos "Consumo no Local", a busca deve ser feita por número da mesa ao invés de telefone. O sistema deve permitir buscar pedidos ativos por número da mesa (mesma validação: número positivo entre 1 e 999). **Nota:** Se esta funcionalidade não for implementada nesta story, adicionar nota indicando que será implementada em story futura.
22. **AC 1.5.22:** A página deve ter um botão "Atualizar" que permite buscar o status atual do pedido manualmente do Supabase, atualizando a página sem recarregar completamente. Este botão deve estar visível quando Realtime não estiver funcionando ou quando usuário quiser verificar atualização manual.

## Tasks / Subtasks

- [x] Task 1: Estender classe Order para buscar pedidos (AC: 1.5.2, 1.5.6, 1.5.7, 1.5.10, 1.5.17, 1.5.21)
  - [x] Subtask 1.1: Implementar método estático `Order.findById(id: string): Promise<Order | null>` para buscar pedido por ID
  - [x] Subtask 1.2: Implementar método estático `Order.findByPhone(phone: string): Promise<Order[]>` para buscar pedidos ativos por telefone
  - [x] Subtask 1.3: Implementar filtro para buscar apenas pedidos com status diferente de "Pronto" (ou incluir "Pronto" se necessário)
  - [x] Subtask 1.4: Implementar ordenação por data de criação (mais recente primeiro) ao buscar por telefone
  - [x] Subtask 1.5: Implementar filtro para pedidos "Pronto" criados há menos de 2 horas (AC 1.5.17)
  - [ ] Subtask 1.6: Implementar método estático `Order.findByTableNumber(tableNumber: number): Promise<Order[]>` para buscar pedidos ativos por número da mesa (se AC 1.5.21 aprovado)
- [x] Task 2: Criar página de Tracking (AC: 1.5.1, 1.5.2, 1.5.11)
  - [x] Subtask 2.1: Criar rota dinâmica `app/tracking/[orderId]/page.tsx` conforme Next.js App Router
  - [x] Subtask 2.2: Criar rota alternativa `app/tracking/page.tsx` para busca por telefone (sem ID)
  - [x] Subtask 2.3: Implementar lógica para redirecionar de `/tracking` para `/tracking/[orderId]` se ID fornecido
  - [x] Subtask 2.4: Aplicar design responsivo mobile-first
- [x] Task 3: Implementar tela de busca por telefone (AC: 1.5.2, 1.5.9, 1.5.13, 1.5.14, 1.5.18, 1.5.20)
  - [x] Subtask 3.1: Criar componente `PhoneSearchForm` com campo de telefone e botão "Buscar Pedido"
  - [x] Subtask 3.2: Reutilizar validação de telefone da Story 1.4 (formato brasileiro, 10-11 dígitos)
  - [x] Subtask 3.3: Implementar formatação automática de telefone enquanto digita
  - [x] Subtask 3.4: Implementar indicador de carregamento durante busca (AC 1.5.13)
  - [x] Subtask 3.5: Implementar mensagem de erro se telefone inválido (AC 1.5.9)
  - [x] Subtask 3.6: Implementar acessibilidade (teclado, screen readers) (AC 1.5.14)
  - [x] Subtask 3.7: Implementar timeout ao buscar pedido (30 segundos) e exibir mensagem de erro se timeout ocorrer (AC 1.5.18)
  - [x] Subtask 3.8: Validar formato de ID do pedido na URL antes de buscar (AC 1.5.20)
- [x] Task 4: Implementar seleção de pedido quando múltiplos encontrados (AC: 1.5.10)
  - [x] Subtask 4.1: Criar componente `OrderList` para exibir lista de pedidos encontrados
  - [x] Subtask 4.2: Implementar card de pedido mostrando: ID, data/hora, modalidade, total, status
  - [x] Subtask 4.3: Implementar clique no card para navegar para `/tracking/{orderId}`
  - [x] Subtask 4.4: Ordenar pedidos por data de criação (mais recente primeiro)
- [x] Task 5: Implementar visualização de status do pedido (AC: 1.5.3, 1.5.5, 1.5.12, 1.5.15)
  - [x] Subtask 5.1: Criar componente `OrderStatusTracker` para exibir status visual
  - [x] Subtask 5.2: Implementar indicadores visuais para cada estágio (Recebido, Em Preparo, Pronto)
  - [x] Subtask 5.3: Implementar exibição de informações básicas do pedido (ID, data/hora, modalidade, total)
  - [x] Subtask 5.4: Implementar mensagem adicional quando status for "Pronto" (AC 1.5.15)
  - [x] Subtask 5.5: Usar cores/ícones para indicar estágio atual (ex: verde para concluído, amarelo para ativo, cinza para pendente)
- [x] Task 6: Implementar Supabase Realtime Subscription (AC: 1.5.4, 1.5.19)
  - [x] Subtask 6.1: Implementar subscription na tabela `orders` usando `supabase-js` Realtime
  - [x] Subtask 6.2: Filtrar subscription para o pedido específico (usar `eq('id', orderId)`)
  - [x] Subtask 6.3: Atualizar estado do componente quando mudança de status for detectada
  - [x] Subtask 6.4: Implementar cleanup da subscription ao desmontar componente
  - [x] Subtask 6.5: Tratar erros de conexão realtime (exibir mensagem apropriada se desconectar)
  - [x] Subtask 6.6: Implementar reconexão automática do Realtime se conexão cair (máximo 3 tentativas) (AC 1.5.19)
  - [x] Subtask 6.7: Exibir mensagem informativa quando Realtime desconectar e permitir atualização manual (AC 1.5.19)
- [x] Task 7: Implementar tratamento de erros e estados de carregamento (AC: 1.5.6, 1.5.7, 1.5.8, 1.5.18, 1.5.20)
  - [x] Subtask 7.1: Implementar indicador de carregamento ao buscar pedido (AC 1.5.8)
  - [x] Subtask 7.2: Implementar mensagem quando pedido não encontrado (diferentes casos: ID inválido, ID válido mas não existe, telefone sem pedidos) (AC 1.5.6)
  - [x] Subtask 7.3: Implementar mensagem quando erro ao buscar pedido (AC 1.5.7)
  - [x] Subtask 7.4: Implementar botão "Tentar novamente" em caso de erro
  - [x] Subtask 7.5: Implementar timeout ao buscar pedido (30 segundos) e exibir mensagem de erro apropriada se timeout ocorrer (AC 1.5.18)
  - [x] Subtask 7.6: Validar formato de ID do pedido na URL antes de buscar (AC 1.5.20)
- [x] Task 8: Implementar atualização manual de status (AC: 1.5.22)
  - [x] Subtask 8.1: Adicionar botão "Atualizar" na página de tracking
  - [x] Subtask 8.2: Implementar busca manual do status atual do pedido ao clicar
  - [x] Subtask 8.3: Exibir botão quando Realtime não estiver funcionando ou sempre visível
- [x] Task 9: Implementar botão "Buscar outro pedido" (AC: 1.5.16)
  - [x] Subtask 9.1: Adicionar botão "Buscar outro pedido" na página de tracking
  - [x] Subtask 9.2: Implementar navegação para `/tracking` (tela de busca) ao clicar
  - [x] Subtask 9.3: Limpar dados do pedido atual ao navegar para busca

## Dev Notes

### Previous Story Insights

**Da Story 1.4:**
- Classe `Order` já implementada com método estático `create()` para salvar pedidos
- Pedidos salvos no Supabase com status inicial "Recebido"
- Redirecionamento para `/tracking/{orderId}` já implementado após salvar pedido
- Formatação e validação de telefone já implementada (pode ser reutilizada)
- Padrão: Server Components do Next.js buscam dados e convertem para objetos simples para passar para Client Components
- Toast implementado com Radix UI Toast para confirmações visuais

**Relevante para Story 1.5:**
- Classe `Order` precisa ser estendida com métodos de busca (`findById`, `findByPhone`)
- Supabase Realtime precisa ser configurado para subscriptions
- Página de tracking precisa ser Client Component para usar Realtime
- Validação de telefone pode ser reutilizada da Story 1.4

### Data Models

Conforme [Source: architecture/fullstack-architecture.md#1]:

**Tabela `orders`:**
- Campos relevantes: `id` (UUID), `order_type` ('Retirada' ou 'Consumo no Local'), `customer_name` (se Retirada), `customer_phone` (se Retirada), `table_number` (se Consumo no Local), `status` ('Recebido', 'Em Preparo', 'Pronto'), `subtotal`, `discount`, `total`, `coupon_code` (se aplicado), `created_at`, `updated_at`
- Propósito: Representa um pedido completo
- Nota: Status pode ser alterado pela equipe no App Desktop (Story 3.2)

**Definição de Pedido Ativo:**
- Pedido ativo: Status 'Recebido' ou 'Em Preparo', ou pedidos com status 'Pronto' criados há menos de 2 horas (AC 1.5.17)
- Para busca por telefone, buscar pedidos onde `customer_phone = {telefone}` e status é 'Recebido', 'Em Preparo', ou 'Pronto' com `created_at` há menos de 2 horas
- Para busca por número da mesa (pedidos "Consumo no Local"), buscar pedidos onde `table_number = {numero}` e status é 'Recebido', 'Em Preparo', ou 'Pronto' com `created_at` há menos de 2 horas (AC 1.5.21)

### API Specifications

**Supabase Client:**
- Usar `supabase-js` para acesso aos dados conforme [Source: architecture/tech-stack.md]
- Tabela: `orders`
- Consultas necessárias:
  - Buscar pedido por ID: `supabase.from('orders').select('*').eq('id', orderId).single()`
  - Buscar pedidos ativos por telefone: `supabase.from('orders').select('*').eq('customer_phone', phone).in('status', ['Recebido', 'Em Preparo', 'Pronto']).order('created_at', { ascending: false })`
- Realtime Subscription:
  - Subscrever mudanças na tabela `orders` para um pedido específico
  - Usar `supabase.channel('order-tracking').on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'orders', filter: `id=eq.${orderId}` }, callback)`
- Não há endpoints REST customizados - usar PostgREST do Supabase diretamente

**Validação de Dados:**
- Telefone: mesma validação da Story 1.4 (formato brasileiro, 10-11 dígitos após remover caracteres não numéricos)
- ID do pedido: UUID válido

### Component Specifications

Conforme [Source: architecture/frontend-architecture.md#Página 3]:

**Estrutura da Página de Acompanhamento:**

**Cenário 1: Acesso com ID do pedido (`/tracking/{orderId}`):**
1. **Header:** Título "Acompanhar Pedido" (opcional)
2. **Informações do Pedido:** ID, Data/Hora, Modalidade, Total
3. **Visualizador de Status:**
   - Indicador visual com 3 estágios:
     - Recebido (✓ Concluído)
     - Em Preparo (⏳ Ativo ou ⏸️ Pendente)
     - Pronto (✓ Concluído ou ⏸️ Pendente)
   - Destacar estágio atual com cores/ícones
4. **Mensagem adicional:** Se status "Pronto", exibir mensagem informativa
5. **Botão:** "Buscar outro pedido" (AC 1.5.16)

**Cenário 2: Acesso sem ID (`/tracking`):**
1. **Header:** Título "Acompanhar Pedido"
2. **Formulário de Busca:**
   - Campo "Número de Telefone"
   - Botão "Buscar Pedido"
3. **Resultados:**
   - Se 1 pedido encontrado: Redirecionar para `/tracking/{orderId}`
   - Se múltiplos pedidos: Exibir lista de pedidos para seleção
   - Se nenhum pedido: Exibir mensagem "Nenhum pedido ativo encontrado"

**Interações:**
- Busca por telefone valida formato e busca pedidos ativos (AC 1.5.17)
- Busca por número da mesa para pedidos "Consumo no Local" (AC 1.5.21)
- Validação de ID do pedido na URL antes de buscar (AC 1.5.20)
- Seleção de pedido na lista navega para `/tracking/{orderId}`
- Status atualiza automaticamente via Realtime quando equipe altera no App Desktop
- Realtime tenta reconectar automaticamente se conexão cair (máximo 3 tentativas) (AC 1.5.19)
- Botão "Atualizar" permite atualização manual do status (AC 1.5.22)
- Timeout de 30 segundos ao buscar pedido com mensagem de erro se timeout ocorrer (AC 1.5.18)
- Indicadores visuais destacam estágio atual do pedido
- Mensagem adicional quando pedido está pronto

**Biblioteca de UI:**
- Usar Radix UI para componentes de formulário (se disponível)
- Toast já implementado pode ser reutilizado para mensagens

### File Locations

**Estrutura base do projeto:**
- Classes de entidades: 
  - Estender `src/domain/entities/Order.ts` com métodos `findById()` e `findByPhone()`
- Páginas:
  - `app/tracking/[orderId]/page.tsx` (página de tracking com ID)
  - `app/tracking/page.tsx` (página de busca por telefone)
- Componentes:
  - `src/components/tracking/OrderStatusTracker.tsx` (visualizador de status)
  - `src/components/tracking/PhoneSearchForm.tsx` (formulário de busca)
  - `src/components/tracking/OrderList.tsx` (lista de pedidos encontrados)
  - `src/components/tracking/OrderInfo.tsx` (informações básicas do pedido)
- Hooks:
  - `src/hooks/useOrderTracking.ts` (hook para gerenciar subscription realtime)
- Utils:
  - Reutilizar `src/utils/phoneFormatter.ts` da Story 1.4

### Testing Requirements

**Testes Unitários:**
- Testar métodos `Order.findById()` e `Order.findByPhone()` (métodos de busca)
- Testar hook `useOrderTracking` (gerenciamento de subscription)
- Testar validação de telefone (reutilizar testes da Story 1.4 se possível)
- Testar lógica de ordenação de pedidos por data

**Testes de Integração:**
- Testar integração com Supabase para buscar pedidos
- Testar Supabase Realtime Subscription (pode usar mocks ou ambiente de teste)
- Testar atualização de status em tempo real (simular mudança de status)

**Testes E2E:**
- Testar fluxo completo: finalizar pedido → redirecionamento para tracking → visualizar status
- Testar busca por telefone: inserir telefone → buscar → visualizar pedido(s)
- Testar busca por número da mesa para pedidos "Consumo no Local" (se AC 1.5.21 aprovado)
- Testar filtro de pedidos ativos (pedidos "Pronto" há mais de 2 horas não aparecem) (AC 1.5.17)
- Testar seleção de pedido quando múltiplos encontrados
- Testar atualização de status em tempo real (simular mudança de status no banco)
- Testar reconexão automática do Realtime se conexão cair (AC 1.5.19)
- Testar botão "Atualizar" para atualização manual do status (AC 1.5.22)
- Testar timeout ao buscar pedido (simular rede lenta) e verificar mensagem de erro após 30 segundos (AC 1.5.18)
- Testar validação de ID do pedido na URL (ID inválido deve exibir mensagem sem buscar no banco) (AC 1.5.20)
- Testar mensagem quando pedido não encontrado (diferentes casos: ID inválido, ID válido mas não existe, telefone sem pedidos) (AC 1.5.6)
- Testar mensagem quando erro ao buscar pedido
- Testar indicador de carregamento durante busca
- Testar botão "Buscar outro pedido"
- Testar mensagem adicional quando status "Pronto"
- Testar responsividade da página em diferentes tamanhos de tela
- Testar acessibilidade (navegação por teclado, screen readers)

### Technical Constraints

**Obrigatórios conforme [Source: architecture/tech-stack.md] e [Source: architecture/fullstack-architecture.md#5]:**
- **TypeScript:** Obrigatório para todo o código
- **POO:** Todas as entidades de negócio DEVEM ser Classes TypeScript, não funções puras
- **Supabase:** Usar `supabase-js` para acesso aos dados e Realtime Subscriptions
- **Design Responsivo:** Mobile-first conforme [Source: architecture/frontend-architecture.md]

**Mapeamento Entidade-Classe obrigatório:**
- `orders` → `class Order` (já implementada, precisa estender)

**Métodos Esperados nas Classes POO:**

**Classe Order (extensão):**
- `static async findById(id: string): Promise<Order | null>` - Busca pedido por ID
- `static async findByPhone(phone: string): Promise<Order[]>` - Busca pedidos ativos por telefone (ordenados por data)
- `getStatus(): string` - Retorna status do pedido (já implementado)
- `getOrderType(): 'Retirada' | 'Consumo no Local'` - Retorna tipo do pedido (já implementado)

**Importante:** Classes devem encapsular lógica de negócio, não apenas serem DTOs (Data Transfer Objects). Métodos devem conter comportamento relacionado às entidades.

**Supabase Realtime:**
- Usar `supabase-js` Realtime Subscriptions conforme [Source: architecture/fullstack-architecture.md#2]
- Subscription deve ser feita em Client Component (não Server Component)
- Filtrar subscription para o pedido específico usando `filter: id=eq.{orderId}`
- Implementar cleanup da subscription ao desmontar componente (useEffect cleanup)
- Tratar erros de conexão e reconexão do Realtime

**Validações e Regras de Negócio:**

- **Telefone:** Mesma validação da Story 1.4 (formato brasileiro, 10-11 dígitos)
- **Pedido ativo:** Pedidos com status 'Recebido' ou 'Em Preparo', ou pedidos 'Pronto' criados há menos de 2 horas (AC 1.5.17)
- **Busca por mesa:** Para pedidos "Consumo no Local", buscar por número da mesa ao invés de telefone (AC 1.5.21)
- **Validação de ID:** Validar formato de UUID antes de buscar pedido no Supabase (AC 1.5.20)
- **Timeout ao buscar:** Implementar timeout de 30 segundos e exibir mensagem de erro apropriada se timeout ocorrer (AC 1.5.18)
- **Realtime desconecta:** Exibir mensagem informativa e tentar reconectar automaticamente (máximo 3 tentativas) (AC 1.5.19)
- **Atualização manual:** Permitir atualizar status manualmente através de botão "Atualizar" (AC 1.5.22)
- **Ordenação:** Pedidos ordenados por data de criação (mais recente primeiro)
- **Realtime:** Atualizar UI automaticamente quando status mudar (sem necessidade de refresh)
- **Cleanup:** Sempre fazer cleanup de subscriptions ao desmontar componente para evitar memory leaks
- **Formatação de data/hora:** Formato sugerido: 'DD/MM/YYYY às HH:MM' (ex: '15/12/2024 às 14:30')

### Project Structure Notes

A estrutura de arquivos do projeto já está parcialmente estabelecida nas Stories anteriores. Seguir padrões existentes:
- Classes de entidades em `src/domain/entities/`
- Componentes em `src/components/tracking/` (nova pasta)
- Páginas em `app/tracking/`
- Hooks customizados em `src/hooks/`
- Utils em `src/utils/`

### Testing

Dev Note: Story Requires the following tests:

- [ ] Jest Unit Tests: (nextToFile: true), coverage requirement: 80%
- [ ] Jest Integration Tests: location: `src/__tests__/integration/order-tracking.test.ts`
- [ ] **NOTA:** E2E tests devem ser manuais conforme padrão do projeto

Manual Test Steps:
- Finalizar pedido e verificar redirecionamento automático para `/tracking/{orderId}` (AC 1.5.1)
- Acessar `/tracking` diretamente e verificar tela de busca por telefone (AC 1.5.2)
- Testar validação de ID do pedido na URL:
  - Acessar `/tracking/123` (ID inválido) e verificar mensagem "ID do pedido inválido" sem buscar no banco (AC 1.5.20)
  - Acessar `/tracking/00000000-0000-0000-0000-000000000000` (UUID válido mas não existe) e verificar mensagem "Pedido não encontrado" (AC 1.5.6)
- Inserir telefone válido e buscar pedido:
  - Se 1 pedido encontrado: verificar redirecionamento para `/tracking/{orderId}`
  - Se múltiplos pedidos: verificar lista de pedidos ordenada por data (mais recente primeiro) (AC 1.5.10)
  - Se nenhum pedido: verificar mensagem "Nenhum pedido ativo encontrado para este telefone" (AC 1.5.6)
- Testar filtro de pedidos ativos:
  - Criar pedido "Pronto" há mais de 2 horas e verificar que não aparece na busca (AC 1.5.17)
  - Criar pedido "Pronto" há menos de 2 horas e verificar que aparece na busca (AC 1.5.17)
- Testar busca por número da mesa (se AC 1.5.21 aprovado):
  - Criar pedido "Consumo no Local" com número da mesa
  - Buscar por número da mesa e verificar que pedido aparece (AC 1.5.21)
- Selecionar pedido na lista e verificar navegação para página de tracking
- Verificar exibição de informações básicas do pedido (ID, data/hora formatada, modalidade, total) (AC 1.5.5)
- Verificar exibição de status atual do pedido ("Recebido", "Em Preparo", "Pronto") (AC 1.5.3)
- Verificar indicadores visuais claros para cada estágio (AC 1.5.12)
- Testar atualização de status em tempo real:
  - Abrir página de tracking
  - Alterar status do pedido no App Desktop (ou diretamente no Supabase)
  - Verificar que status atualiza automaticamente na página sem refresh (AC 1.5.4)
- Testar reconexão automática do Realtime:
  - Abrir página de tracking
  - Simular perda de conexão do Realtime
  - Verificar mensagem "Conexão perdida. Tentando reconectar..." (AC 1.5.19)
  - Verificar que sistema tenta reconectar automaticamente (máximo 3 tentativas) (AC 1.5.19)
- Testar botão "Atualizar":
  - Verificar que botão está visível na página de tracking (AC 1.5.22)
  - Clicar em "Atualizar" e verificar que status é buscado manualmente do Supabase (AC 1.5.22)
  - Verificar que atualização ocorre sem recarregar página completamente (AC 1.5.22)
- Verificar mensagem adicional quando status for "Pronto" (mensagem diferente para Retirada vs Consumo no Local) (AC 1.5.15)
- Testar busca por telefone inválido e verificar mensagem de erro (AC 1.5.9)
- Testar indicador de carregamento durante busca (AC 1.5.8, 1.5.13)
- Testar timeout ao buscar pedido:
  - Simular rede lenta ou Supabase temporariamente indisponível
  - Aguardar 30 segundos e verificar mensagem de erro apropriada (AC 1.5.18)
  - Verificar que pode tentar novamente
- Testar erro ao buscar pedido (simular erro de rede) e verificar mensagem de erro e botão "Tentar novamente" (AC 1.5.7)
- Testar botão "Buscar outro pedido" e verificar navegação para `/tracking` (AC 1.5.16)
- Testar cleanup de subscription realtime (fechar página e verificar que subscription foi encerrada)
- Testar em diferentes tamanhos de tela (mobile, tablet, desktop) (AC 1.5.11)
- Testar acessibilidade:
  - Navegação por teclado (Tab para navegar, Enter para submeter) (AC 1.5.14)
  - Screen readers (labels apropriados, mensagens de status acessíveis) (AC 1.5.14)

## Dev Agent Record

### Agent Model Used: {{Agent Model Name/Version}}

### Debug Log References

[[LLM: (Dev Agent) If the debug is logged to during the current story progress, create a table with the debug log and the specific task section in the debug log - do not repeat all the details in the story]]

### Completion Notes List

- Métodos `Order.findById()` e `Order.findByPhone()` implementados com filtro de pedidos ativos
- Timeout explícito de 30s implementado em ambos os métodos com `Promise.race()` (AC 1.5.18)
- Página `/tracking/[orderId]` implementada com visualização de status e Realtime
- Página `/tracking` implementada com busca por telefone
- Componentes criados: `OrderStatusTracker`, `OrderInfo`, `PhoneSearchForm`, `OrderList`
- Supabase Realtime Subscription implementada para atualização automática de status
- Reconexão automática do Realtime com 3 tentativas implementada (AC 1.5.19)
- Validação de UUID antes de buscar pedido
- Ordenação de pedidos corrigida após combinar resultados (mais recente primeiro)
- Limpeza de subscriptions ao desmontar componente
- AC 1.5.21 não implementado (busca por mesa adiada para story futura)
- Todas as tasks concluídas exceto busca por mesa

### Change Log

[[LLM: (Dev Agent) Track document versions and changes during development that deviate from story dev start]]

| Date | Version | Description | Author |
| :--- | :------ | :---------- | :----- |
| 2024 | 1.1 | Story criada inicialmente | SM |
| 2024 | 1.2 | Correções aplicadas após PO Review: ACs 1.5.17-1.5.22 adicionados, ACs 1.5.4 e 1.5.6 melhorados, validações expandidas, Realtime desconecta adicionado | PO/SM |
| 2024 | 1.3 | Implementação concluída: métodos de busca, páginas de tracking e busca, componentes, Realtime implementados | Dev |
| 2024 | 1.4 | Correções após QA Review: timeout explícito de 30s, reconexão automática com 3 tentativas, ordenação de pedidos corrigida | Dev |

