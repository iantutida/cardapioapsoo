# Story 1.4: Finalizar Pedido (Checkout)

## Status: Review

**Última atualização:** 2024 - Implementação concluída

## Story

- As a Cliente do Restaurante
- I want finalizar meu pedido selecionando a modalidade (Retirada ou Consumo no Local) e fornecendo minha identificação (nome/telefone ou número da mesa)
- so that eu possa enviar meu pedido para a cozinha

## Acceptance Criteria (ACs)

1. **AC 1.4.1:** Ao acessar a página de checkout (via botão "Finalizar Pedido" do carrinho), o cliente deve escolher a **Modalidade**: "Retirada" ou "Consumo no Local" através de botões de rádio.
2. **AC 1.4.2:** Se "Retirada" for selecionado, o sistema deve solicitar **Nome** (obrigatório, mínimo 2 caracteres, máximo 100 caracteres) e **Número de Telefone** (obrigatório, formato brasileiro válido, aceitar: (11) 98765-4321, 11987654321, ou formato internacional - validar 10-11 dígitos após remover caracteres não numéricos).
3. **AC 1.4.3:** Se "Consumo no Local" for selecionado, o sistema deve solicitar o **Número da Mesa** (obrigatório, número positivo entre 1 e 999).
4. **AC 1.4.4:** O cliente deve ver um resumo final do pedido exibindo: lista de itens (nome, quantidade, preço), subtotal, desconto (se houver cupom aplicado) e total antes de confirmar.
5. **AC 1.4.5:** O botão "Confirmar Pedido" deve estar desabilitado se:
   - O carrinho estiver vazio
   - A modalidade não estiver selecionada
   - Os campos obrigatórios não estiverem preenchidos ou inválidos
6. **AC 1.4.6:** Ao clicar em "Confirmar Pedido", o sistema deve:
   - Salvar o pedido no Supabase (tabelas `orders`, `order_items`, `order_item_options`) em transação garantindo integridade
   - Limpar o carrinho e cupom aplicado
   - Exibir indicador de carregamento durante o processo
   - **Nota:** A notificação no App Desktop (Story 3.1) será acionada automaticamente via Supabase Realtime quando pedido for salvo, ou será implementada em Story 3.1.
7. **AC 1.4.7:** Após salvar o pedido com sucesso, o cliente deve ser redirecionado para a página de Acompanhamento (História 1.5) passando o ID do pedido como parâmetro.
8. **AC 1.4.8:** Se houver erro ao salvar o pedido no Supabase, o sistema deve exibir mensagem de erro apropriada (ex: "Erro ao finalizar pedido. Tente novamente.") e não redirecionar.
9. **AC 1.4.9:** Se o usuário acessar a página de checkout sem itens no carrinho, deve ser redirecionado de volta para a página do cardápio com mensagem informativa.
10. **AC 1.4.10:** A página de checkout deve ser responsiva e funcionar bem em diferentes tamanhos de tela (mobile, tablet, desktop).
11. **AC 1.4.11:** Todos os campos obrigatórios devem ter validação visual (ex: borda vermelha se inválido) e mensagens de erro apropriadas.
12. **AC 1.4.12:** O número de telefone deve ser formatado automaticamente enquanto o usuário digita (ex: "(11) 98765-4321").
13. **AC 1.4.13:** O status inicial do pedido salvo deve ser "Recebido" (conforme usado na História 3.1).
14. **AC 1.4.14:** O pedido salvo deve incluir data/hora de criação e ser associado à modalidade escolhida (Retirada ou Consumo no Local).
15. **AC 1.4.15:** Ao mudar a modalidade selecionada, os campos da modalidade anterior devem ser limpos e a validação deve ser resetada.
16. **AC 1.4.16:** O sistema deve aceitar telefone em diferentes formatos (com ou sem máscara, com ou sem código de área) mas validar que é um número brasileiro válido (10-11 dígitos após remover caracteres não numéricos).
17. **AC 1.4.17:** Se houver timeout ao salvar pedido no Supabase (ex: rede lenta, Supabase temporariamente indisponível), o sistema deve exibir mensagem de erro apropriada (ex: "Tempo de espera esgotado. Tente novamente.") após período razoável (ex: 30 segundos) e permitir tentar novamente sem perder dados preenchidos.
18. **AC 1.4.18:** Se houver erro ao salvar `order_items` ou `order_item_options` após salvar `orders`, o sistema deve fazer rollback completo (deletar pedido criado) e exibir mensagem de erro, garantindo que não haja pedidos órfãos no banco de dados.
19. **AC 1.4.19:** A validação visual dos campos deve ocorrer em tempo real (ao sair do campo ou após usuário digitar alguns caracteres) e também ao tentar confirmar pedido.
20. **AC 1.4.20:** A página de checkout deve ser acessível via teclado (navegação por Tab, Enter para submeter formulário) e ter labels apropriados para screen readers. Campos devem ter mensagens de erro acessíveis.
21. **AC 1.4.21:** Após salvar pedido com sucesso, deve ser exibida mensagem de confirmação (ex: toast "Pedido confirmado com sucesso!") antes ou durante redirecionamento para página de acompanhamento.

## Tasks / Subtasks

- [x] Task 1: Criar classes TypeScript para Pedido (AC: 1.4.6, 1.4.13, 1.4.14)
  - [x] Subtask 1.1: Criar classe `Order` conforme [Source: architecture/fullstack-architecture.md#5]
  - [x] Subtask 1.2: Criar classe `OrderItem` conforme [Source: architecture/fullstack-architecture.md#5]
  - [x] Subtask 1.3: Criar classe `OrderItemOption` conforme [Source: architecture/fullstack-architecture.md#5]
  - [x] Subtask 1.4: Implementar método estático `Order.create(cartItems, customerInfo, orderType, appliedCoupon): Promise<Order>` para criar e salvar pedido
  - [x] Subtask 1.5: Implementar métodos para salvar `order_items` e `order_item_options` associados ao pedido
- [x] Task 2: Criar página de Checkout (AC: 1.4.1, 1.4.9, 1.4.10, 1.4.20)
  - [x] Subtask 2.1: Criar rota `app/checkout/page.tsx` conforme Next.js App Router
  - [x] Subtask 2.2: Verificar se carrinho tem itens ao acessar página (redirecionar se vazio) (AC 1.4.9)
  - [x] Subtask 2.3: Implementar layout conforme wireframe [Source: architecture/frontend-architecture.md#Página 2]
  - [x] Subtask 2.4: Aplicar design responsivo mobile-first
  - [x] Subtask 2.5: Implementar acessibilidade da página (teclado, screen readers, labels) (AC 1.4.20)
- [x] Task 3: Implementar seleção de modalidade (AC: 1.4.1, 1.4.2, 1.4.3, 1.4.15)
  - [x] Subtask 3.1: Criar componente `OrderTypeSelector` com radio buttons "Retirada" e "Consumo no Local"
  - [x] Subtask 3.2: Implementar estado para modalidade selecionada
  - [x] Subtask 3.3: Implementar campos condicionais baseados na modalidade selecionada
  - [x] Subtask 3.4: Implementar limpeza de campos ao mudar modalidade (limpar campos da modalidade anterior) (AC 1.4.15)
- [x] Task 4: Implementar campos de formulário para Retirada (AC: 1.4.2, 1.4.11, 1.4.12, 1.4.16, 1.4.19)
  - [x] Subtask 4.1: Criar componente `CustomerNameField` com validação (mínimo 2 caracteres, máximo 100)
  - [x] Subtask 4.2: Criar componente `CustomerPhoneField` com formatação automática e validação de formato brasileiro
  - [x] Subtask 4.3: Implementar validação visual (borda vermelha se inválido)
  - [x] Subtask 4.4: Implementar mensagens de erro apropriadas
  - [x] Subtask 4.5: Formatar telefone automaticamente enquanto usuário digita (ex: "(11) 98765-4321")
  - [x] Subtask 4.6: Implementar validação em tempo real (onChange/onBlur) além de validação ao submeter (AC 1.4.19)
  - [x] Subtask 4.7: Aceitar telefone em diferentes formatos mas validar 10-11 dígitos (AC 1.4.16)
- [x] Task 5: Implementar campo de formulário para Consumo no Local (AC: 1.4.3, 1.4.11, 1.4.19)
  - [x] Subtask 5.1: Criar componente `TableNumberField` com validação (número positivo entre 1 e 999 obrigatório)
  - [x] Subtask 5.2: Implementar validação visual (borda vermelha se inválido)
  - [x] Subtask 5.3: Implementar mensagens de erro apropriadas
  - [x] Subtask 5.4: Implementar validação em tempo real (onChange/onBlur) além de validação ao submeter (AC 1.4.19)
- [x] Task 6: Implementar resumo do pedido (AC: 1.4.4)
  - [x] Subtask 6.1: Criar componente `OrderSummary` para exibir resumo
  - [x] Subtask 6.2: Exibir lista de itens do carrinho (nome, quantidade, preço formatado)
  - [x] Subtask 6.3: Exibir subtotal usando `getCartTotal()` do CartContext
  - [x] Subtask 6.4: Exibir desconto (se cupom aplicado) usando `getDiscount()` do CartContext
  - [x] Subtask 6.5: Exibir total usando `getTotal()` do CartContext
  - [x] Subtask 6.6: Formatizar todos os valores monetários usando `Intl.NumberFormat`
- [x] Task 7: Implementar validação e botão "Confirmar Pedido" (AC: 1.4.5, 1.4.6, 1.4.8, 1.4.17, 1.4.18, 1.4.21)
  - [x] Subtask 7.1: Criar função de validação de formulário completa
  - [x] Subtask 7.2: Desabilitar botão se validação falhar (AC 1.4.5)
  - [x] Subtask 7.3: Implementar handler para "Confirmar Pedido"
  - [x] Subtask 7.4: Implementar indicador de carregamento durante salvamento
  - [x] Subtask 7.5: Integrar com `Order.create()` para salvar pedido no Supabase em transação
  - [x] Subtask 7.6: Integrar com `clearCart()` do CartContext após sucesso (garantir que também limpe cupom)
  - [x] Subtask 7.7: Implementar tratamento de erro com mensagem apropriada (AC 1.4.8)
  - [x] Subtask 7.8: Implementar timeout ao salvar pedido (30 segundos) e exibir mensagem de erro apropriada se timeout ocorrer (AC 1.4.17)
  - [x] Subtask 7.9: Implementar rollback completo se houver erro parcial ao salvar (deletar orders se order_items falhar) (AC 1.4.18)
  - [x] Subtask 7.10: Garantir que `clearCart()` também limpe cupom aplicado, ou chamar `removeCoupon()` explicitamente
  - [x] Subtask 7.11: Exibir mensagem de sucesso (toast) antes ou durante redirecionamento (AC 1.4.21)
- [x] Task 8: Implementar redirecionamento após sucesso (AC: 1.4.7)
  - [x] Subtask 8.1: Implementar navegação para `/tracking/{orderId}` após salvar pedido
  - [x] Subtask 8.2: Passar ID do pedido como parâmetro na URL
- [x] Task 9: Integrar com CartContext (AC: 1.4.4, 1.4.6, 1.4.9)
  - [x] Subtask 9.1: Usar `getCartItems()` do CartContext para listar itens
  - [x] Subtask 9.2: Usar `appliedCoupon` do CartContext para resumo financeiro
  - [x] Subtask 9.3: Verificar se carrinho está vazio ao montar componente
  - [x] Subtask 9.4: Usar `clearCart()` após salvar pedido com sucesso

## Dev Notes

### Previous Story Insights

**Da Story 1.3:**
- `CartContext` já implementado com todas as funções necessárias: `getCartItems()`, `getCartTotal()`, `getDiscount()`, `getTotal()`, `clearCart()`, `appliedCoupon`
- Estrutura de dados `CartItem` já definida em `src/types/cart.ts`
- Padrão: Server Components do Next.js buscam dados e convertem para objetos simples para passar para Client Components
- Toast implementado com Radix UI Toast para confirmações visuais
- Navegação para checkout já implementada em `CartModal.tsx` com `router.push('/checkout')`

**Relevante para Story 1.4:**
- Carrinho e cupom já persistem no localStorage, então checkout pode acessar dados do carrinho
- Padrão de toast já estabelecido pode ser reutilizado para mensagens de erro/sucesso
- Next.js Router já disponível para navegação
- Supabase Client já configurado em `lib/supabase/client.ts` e `lib/supabase/server.ts`

### Data Models

Conforme [Source: architecture/fullstack-architecture.md#1]:

**Tabela `orders`:**
- Campos relevantes: `id` (UUID), `order_type` ('Retirada' ou 'Consumo no Local'), `customer_name` (se Retirada), `customer_phone` (se Retirada), `table_number` (se Consumo no Local), `status` ('Recebido', 'Em Preparo', 'Pronto'), `subtotal`, `discount`, `total`, `coupon_code` (se aplicado), `created_at`, `updated_at`
- Propósito: Representa um pedido completo
- Nota: Status inicial deve ser 'Recebido' (AC 1.4.13)

**Tabela `order_items`:**
- Campos relevantes: `id` (UUID), `order_id`, `product_id`, `product_name`, `product_price`, `quantity`, `notes`, `total_price`, `created_at`
- Propósito: Representa um item dentro de um pedido
- Relacionamento: N:1 com `orders` (muitos itens por pedido)

**Tabela `order_item_options`:**
- Campos relevantes: `id` (UUID), `order_item_id`, `option_group_id`, `option_group_name`, `option_id`, `option_name`, `additional_price`, `created_at`
- Propósito: Representa um opcional selecionado em um item do pedido
- Relacionamento: N:1 com `order_items` (muitos opcionais por item)

**Estrutura de Dados do Pedido:**
```typescript
interface OrderData {
  orderType: 'Retirada' | 'Consumo no Local'
  customerInfo: {
    name?: string // se Retirada
    phone?: string // se Retirada
    tableNumber?: number // se Consumo no Local
  }
  items: CartItem[]
  subtotal: number
  discount: number
  total: number
  couponCode: string | null
}
```

### API Specifications

**Supabase Client:**
- Usar `supabase-js` para acesso aos dados conforme [Source: architecture/tech-stack.md]
- Tabelas: `orders`, `order_items`, `order_item_options`
- Operações necessárias:
  - Inserir pedido na tabela `orders`
  - Inserir itens na tabela `order_items` (relacionados ao pedido)
  - Inserir opcionais na tabela `order_item_options` (relacionados aos itens)
- Usar transação ou inserções em sequência garantindo integridade
- Nota: Pode usar PostgREST do Supabase diretamente ou criar API route do Next.js para melhor controle

**Validação de Dados:**
- Nome: obrigatório, mínimo 2 caracteres, máximo 100 caracteres
- Telefone: obrigatório se Retirada, formato brasileiro válido (ex: (11) 98765-4321, 11987654321, etc.)
- Número da Mesa: obrigatório se Consumo no Local, número positivo (1-999)
- Modalidade: obrigatória

### Component Specifications

Conforme [Source: architecture/frontend-architecture.md#Página 2]:

**Estrutura da Página de Checkout:**
1. **Header:** Título "Finalizar Pedido" (opcional)
2. **Resumo do Pedido:** 
   - Lista de itens (nome, quantidade, preço)
   - Subtotal
   - Desconto (se aplicado)
   - Total
3. **Seleção de Modalidade:** Radio buttons "Retirada" ou "Consumo no Local"
4. **Campos Condicionais:**
   - Se "Retirada": Campo Nome e Campo Telefone
   - Se "Consumo no Local": Campo Número da Mesa
5. **Botão de Ação:** "Confirmar e Enviar Pedido" (desabilitado se validação falhar)

**Interações:**
- Seleção de modalidade atualiza campos exibidos
- Mudança de modalidade limpa campos da modalidade anterior e reseta validação (AC 1.4.15)
- Validação em tempo real dos campos (onChange/onBlur) e ao submeter (borda vermelha se inválido) (AC 1.4.19)
- Formatação automática do telefone enquanto digita (aceitar diferentes formatos, validar 10-11 dígitos) (AC 1.4.16)
- Indicador de carregamento durante salvamento
- Timeout de 30 segundos ao salvar com mensagem de erro se timeout ocorrer (AC 1.4.17)
- Rollback completo se houver erro parcial ao salvar (AC 1.4.18)
- Mensagem de erro se salvamento falhar
- Mensagem de sucesso (toast) antes ou durante redirecionamento (AC 1.4.21)
- Redirecionamento após sucesso
- Acessibilidade via teclado e screen readers (AC 1.4.20)

**Biblioteca de UI:**
- Usar Radix UI para componentes de formulário (se disponível)
- Toast já implementado pode ser reutilizado

### File Locations

**Estrutura base do projeto:**
- Classes de entidades: 
  - `src/domain/entities/Order.ts`
  - `src/domain/entities/OrderItem.ts`
  - `src/domain/entities/OrderItemOption.ts`
- Páginas:
  - `app/checkout/page.tsx` (página de checkout)
- Componentes:
  - `src/components/checkout/OrderTypeSelector.tsx` (seleção de modalidade)
  - `src/components/checkout/CustomerNameField.tsx` (campo nome)
  - `src/components/checkout/CustomerPhoneField.tsx` (campo telefone com formatação)
  - `src/components/checkout/TableNumberField.tsx` (campo número da mesa)
  - `src/components/checkout/OrderSummary.tsx` (resumo do pedido)
- Tipos:
  - `src/types/order.ts` (tipos TypeScript para pedidos, se necessário)
- Utils:
  - `src/utils/phoneFormatter.ts` (função para formatar telefone brasileiro)

### Testing Requirements

**Testes Unitários:**
- Testar classes `Order`, `OrderItem`, `OrderItemOption` (métodos de criação, salvamento)
- Testar método `Order.create()` com diferentes cenários
- Testar função de formatação de telefone
- Testar validações de formulário (nome, telefone, número da mesa)
- Testar cálculo de totais ao criar pedido

**Testes de Integração:**
- Testar integração com Supabase para salvar pedido completo (orders + order_items + order_item_options)
- Testar transação/rollback se houver erro ao salvar
- Testar limpeza do carrinho após salvar pedido
- Testar redirecionamento após sucesso

**Testes E2E:**
- Testar fluxo completo: carrinho com itens → checkout → preencher formulário → confirmar pedido → redirecionamento
- Testar validação de campos obrigatórios
- Testar seleção de modalidade e campos condicionais
- Testar mudança de modalidade limpa campos da modalidade anterior e reseta validação (AC 1.4.15)
- Testar formatação automática de telefone e aceitar diferentes formatos (AC 1.4.16)
- Testar validação em tempo real (onChange/onBlur) e ao submeter (AC 1.4.19)
- Testar salvamento de pedido com cupom aplicado
- Testar salvamento de pedido sem cupom
- Testar salvamento de pedido com itens que têm opcionais
- Testar salvamento de pedido com itens que têm observações
- Testar timeout ao salvar pedido (simular rede lenta) e verificar mensagem de erro após 30 segundos (AC 1.4.17)
- Testar rollback completo se erro parcial ao salvar (simular erro ao salvar order_items após orders) (AC 1.4.18)
- Testar limpeza de cupom junto com carrinho após sucesso
- Testar mensagem de sucesso (toast) antes ou durante redirecionamento (AC 1.4.21)
- Testar redirecionamento quando carrinho está vazio
- Testar tratamento de erro ao salvar pedido
- Testar limpeza do carrinho após sucesso
- Testar responsividade da página em diferentes tamanhos de tela
- Testar acessibilidade (navegação por teclado, screen readers, labels) (AC 1.4.20)

### Technical Constraints

**Obrigatórios conforme [Source: architecture/tech-stack.md] e [Source: architecture/fullstack-architecture.md#5]:**
- **TypeScript:** Obrigatório para todo o código
- **POO:** Todas as entidades de negócio DEVEM ser Classes TypeScript, não funções puras
- **Supabase:** Usar `supabase-js` para acesso aos dados
- **Design Responsivo:** Mobile-first conforme [Source: architecture/frontend-architecture.md]

**Mapeamento Entidade-Classe obrigatório:**
- `orders` → `class Order`
- `order_items` → `class OrderItem`
- `order_item_options` → `class OrderItemOption`

**Métodos Esperados nas Classes POO:**

**Classe Order:**
- `static async create(cartItems: CartItem[], customerInfo: CustomerInfo, orderType: 'Retirada' | 'Consumo no Local', appliedCoupon: AppliedCoupon | null): Promise<Order>` - Cria e salva pedido completo no Supabase
- `getStatus(): string` - Retorna status do pedido
- `getTotal(): number` - Retorna total do pedido
- `getOrderType(): 'Retirada' | 'Consumo no Local'` - Retorna tipo do pedido

**Classe OrderItem:**
- `getTotalPrice(): number` - Retorna preço total do item
- `getNotes(): string | null` - Retorna observações do item

**Classe OrderItemOption:**
- `getAdditionalPrice(): number` - Retorna preço adicional do opcional

**Importante:** Classes devem encapsular lógica de negócio, não apenas serem DTOs (Data Transfer Objects). Métodos devem conter comportamento relacionado às entidades.

**Validações e Regras de Negócio:**

- **Nome:** Obrigatório se Retirada, mínimo 2 caracteres, máximo 100 caracteres
- **Telefone:** Obrigatório se Retirada, aceitar diferentes formatos (com ou sem máscara) mas validar 10-11 dígitos brasileiros após remover caracteres não numéricos
- **Número da Mesa:** Obrigatório se Consumo no Local, número positivo entre 1 e 999
- **Modalidade:** Obrigatória (Retirada ou Consumo no Local)
- **Mudança de modalidade:** Limpar campos e resetar validação ao mudar modalidade selecionada (AC 1.4.15)
- **Validação em tempo real:** Validar campos em tempo real (onChange/onBlur) e ao submeter (AC 1.4.19)
- **Status inicial:** Sempre 'Recebido' ao criar pedido (AC 1.4.13)
- **Integridade transacional:** Garantir que todos os `order_items` e `order_item_options` sejam salvos com sucesso ou fazer rollback completo (deletar orders se falhar) (AC 1.4.18)
- **Timeout ao salvar:** Implementar timeout de 30 segundos e exibir mensagem de erro apropriada se timeout ocorrer (AC 1.4.17)
- **Limpeza de cupom:** Garantir que cupom seja limpo junto com carrinho após salvar pedido
- **Carrinho vazio:** Redirecionar para cardápio se acessar checkout sem itens (AC 1.4.9)
- **Notificação Desktop:** A notificação no App Desktop (Story 3.1) será acionada automaticamente via Supabase Realtime quando pedido for salvo

### Project Structure Notes

A estrutura de arquivos do projeto já está parcialmente estabelecida nas Stories anteriores. Seguir padrões existentes:
- Classes de entidades em `src/domain/entities/`
- Componentes em `src/components/checkout/` (nova pasta)
- Páginas em `app/checkout/`
- Utils em `src/utils/`
- Tipos em `src/types/`

### Testing

Dev Note: Story Requires the following tests:

- [ ] Jest Unit Tests: (nextToFile: true), coverage requirement: 80%
- [ ] Jest Integration Tests: location: `src/__tests__/integration/checkout.test.ts`
- [ ] **NOTA:** E2E tests devem ser manuais conforme padrão do projeto

Manual Test Steps:
- Acessar página de checkout com carrinho vazio e verificar redirecionamento para cardápio (AC 1.4.9)
- Verificar resumo do pedido exibe todos os itens, subtotal, desconto (se houver) e total corretamente (AC 1.4.4)
- Selecionar modalidade "Retirada" e verificar que campos Nome e Telefone aparecem (AC 1.4.2)
- Selecionar modalidade "Consumo no Local" e verificar que campo Número da Mesa aparece (AC 1.4.3)
- Testar mudança de modalidade:
  - Preencher campos de "Retirada" (nome e telefone)
  - Mudar para "Consumo no Local"
  - Verificar que campos de "Retirada" foram limpos (AC 1.4.15)
  - Verificar que validação foi resetada
- Testar validação de campos obrigatórios:
  - Tentar confirmar sem selecionar modalidade (botão desabilitado)
  - Tentar confirmar sem preencher nome/telefone (se Retirada) (botão desabilitado)
  - Tentar confirmar sem preencher número da mesa (se Consumo no Local) (botão desabilitado)
  - Preencher nome com menos de 2 caracteres e verificar validação visual em tempo real (AC 1.4.11, 1.4.19)
  - Preencher nome com mais de 100 caracteres e verificar validação
  - Preencher telefone inválido (menos de 10 dígitos) e verificar validação visual em tempo real (AC 1.4.11, 1.4.19)
  - Preencher telefone em diferentes formatos (com máscara, sem máscara) e verificar que todos são aceitos se válidos (AC 1.4.16)
  - Preencher número da mesa negativo ou zero e verificar validação visual (AC 1.4.11)
  - Preencher número da mesa acima de 999 e verificar validação visual
- Testar formatação automática de telefone enquanto digita (AC 1.4.12)
- Testar validação em tempo real: sair de campo inválido e verificar validação antes de submeter (AC 1.4.19)
- Preencher formulário completo e clicar em "Confirmar Pedido":
  - Verificar indicador de carregamento durante salvamento (AC 1.4.6)
  - Verificar pedido salvo no Supabase com todos os dados corretos (orders + order_items + order_item_options)
  - Verificar status inicial do pedido é "Recebido" (AC 1.4.13)
  - Verificar carrinho e cupom foram limpos após sucesso (AC 1.4.6)
  - Verificar mensagem de sucesso (toast) exibida antes ou durante redirecionamento (AC 1.4.21)
  - Verificar redirecionamento para página de acompanhamento com ID do pedido (AC 1.4.7)
- Testar salvamento de pedido com cupom aplicado e verificar que cupom foi limpo
- Testar salvamento de pedido sem cupom
- Testar salvamento de pedido com itens que têm opcionais
- Testar salvamento de pedido com itens que têm observações
- Testar timeout ao salvar pedido:
  - Simular rede lenta ou Supabase temporariamente indisponível
  - Aguardar 30 segundos e verificar mensagem de erro apropriada (AC 1.4.17)
  - Verificar que dados preenchidos não foram perdidos e pode tentar novamente
- Testar rollback completo:
  - Simular erro ao salvar order_items após orders ter sido salvo
  - Verificar que orders foi deletado (rollback) e mensagem de erro exibida (AC 1.4.18)
- Simular erro ao salvar pedido (ex: desligar Supabase) e verificar mensagem de erro apropriada (AC 1.4.8)
- Testar em diferentes tamanhos de tela (mobile, tablet, desktop) (AC 1.4.10)
- Testar acessibilidade:
  - Navegação por teclado (Tab para navegar, Enter para submeter) (AC 1.4.20)
  - Screen readers (labels apropriados, mensagens de erro acessíveis) (AC 1.4.20)

## Dev Agent Record

### Agent Model Used: {{Agent Model Name/Version}}

### Debug Log References

[[LLM: (Dev Agent) If the debug is logged to during the current story progress, create a table with the debug log and the specific task section in the debug log - do not repeat all the details in the story]]

### Completion Notes List

- Tabelas `orders`, `order_items` e `order_item_options` criadas no Supabase via MCP
- Classe POO `Order` implementada com método estático `create()` para salvar pedido completo
- Rollback implementado: se falhar ao salvar order_items ou order_item_options, deleta orders
- Timeout explícito de 30s implementado com mensagem específica de erro (AC 1.4.17)
- Página de checkout implementada com layout responsivo
- Componentes criados: `OrderTypeSelector`, `CustomerNameField`, `CustomerPhoneField`, `TableNumberField`, `OrderSummary`
- Validação em tempo real implementada com feedback visual
- Formatação automática de telefone enquanto usuário digita
- Todos os 21 ACs implementados completamente
- Redirecionamento para `/tracking/{orderId}` após sucesso
- Todas as tasks concluídas - implementação completa

### Change Log

[[LLM: (Dev Agent) Track document versions and changes during development that deviate from story dev start]]

| Date | Version | Description | Author |
| :--- | :------ | :---------- | :----- |
| 2024 | 1.1 | Story criada inicialmente | SM |
| 2024 | 1.2 | Correções aplicadas após PO Review: ACs 1.4.15-1.4.21 adicionados, ACs 1.4.2, 1.4.3 e 1.4.6 melhorados, validações expandidas, acessibilidade adicionada | PO/SM |
| 2024 | 1.3 | Implementação concluída: todas tasks completadas, todos componentes criados e integrados, rollback implementado | Dev |
| 2024 | 1.4 | Implementação de timeout de 30s completada após QA Review (AC 1.4.17) | Dev |

