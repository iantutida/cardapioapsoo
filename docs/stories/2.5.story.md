# Story 2.5: Gerenciar Cupons de Desconto (CRUD)

## Status: ✅ Completo - Backend + UI Completa com CRUD Funcional

## Story

- As a Gerente de Restaurante
- I want criar, visualizar, editar e desativar cupons de desconto
- so that eu possa oferecer promoções aos meus clientes

## Acceptance Criteria (ACs)

### Backend & APIs

1. **AC 2.5.1:** Deve existir classe `Coupon` estendida com métodos `static create()`, `static update()`, `static delete()`, `static getAll()` que interagem com a tabela `coupons`.
2. **AC 2.5.2:** Ao criar um cupom, deve ser possível definir: Código (obrigatório, 3-20 caracteres, uppercase, único), Tipo de Desconto ('percentage' ou 'fixed'), Valor (> 0) e Status ('Ativo' ou 'Inativo').
3. **AC 2.5.3:** O código do cupom deve ser automaticamente convertido para UPPERCASE e trimmed antes de salvar.
4. **AC 2.5.4:** Validações devem rejeitar: código vazio, código muito curto/longo, código duplicado, valor negativo ou zero, tipo inválido.
5. **AC 2.5.5:** O método `Coupon.delete()` deve implementar "soft delete" (marcar status como 'Inativo') ao invés de exclusão física para preservar histórico de pedidos.
6. **AC 2.5.6:** Devem existir rotas protegidas (role admin) em `/api/admin/coupons` (GET, POST, PATCH, DELETE).
7. **AC 2.5.7:** Todas operações CRUD devem ter timeout de 30 segundos e registrar logs estruturados com prefixo `admin-coupons`. Se timeout ocorrer, deve exibir toast de erro com mensagem padrão "Tempo de espera esgotado. Tente novamente.", exibir spinner durante operação, manter estado preenchido do formulário, e permitir retry seguro sem perda de dados.
8. **AC 2.5.8:** Para cupons de desconto percentual, o valor deve estar entre 1 e 100. Para desconto fixo, o valor deve ser > 0.
9. **AC 2.5.9:** O método `Coupon.validate()` (já implementado na Story 1.3) deve continuar funcionando corretamente para validar cupons no checkout do cliente.

### Frontend

10. **AC 2.5.10:** Deve existir página `/admin/coupons` acessível via link "Cupons" na sidebar, protegida por auth admin.
11. **AC 2.5.11:** A página deve listar todos os cupons com colunas: Código, Tipo, Valor Desconto, Status, Data de Criação.
12. **AC 2.5.12:** Deve haver filtros para visualizar: Todos, Apenas Ativos, Apenas Inativos.
13. **AC 2.5.13:** Deve haver modais/formulários para criar e editar cupons.
14. **AC 2.5.14:** No modal de criação/edição, o campo de código deve mostrar preview em uppercase enquanto usuário digita.
15. **AC 2.5.15:** Ao selecionar "Tipo de Desconto", o campo de valor deve mostrar a unidade correspondente (% ou R$).
16. **AC 2.5.16:** Validações em tempo real e feedback (toasts, spinners) devem ser implementados para todas as operações.
17. **AC 2.5.17:** A página deve ter estados de loading (skeleton) e estado vazio com CTA para criar primeiro cupom.
18. **AC 2.5.18:** Deve exibir badge visual para status do cupom (verde para Ativo, cinza para Inativo).
19. **AC 2.5.19:** Botão de "Desativar/Ativar" deve alternar o status com confirmação visual (toast).
20. **AC 2.5.20:** Deve haver busca/filtro por código de cupom (case insensitive).

### Infraestrutura

21. **AC 2.5.21:** A tabela `coupons` deve ter RLS configurado com políticas específicas: (a) SELECT permitido para anônimos apenas com `status = 'Ativo'`, (b) INSERT/UPDATE/DELETE permitidos apenas para usuários autenticados com `auth.role() = 'admin'` (verificação via `auth.uid()` em `profiles.role`).
22. **AC 2.5.22:** Após qualquer alteração relevante (criar, editar, ativar/desativar), deve-se disparar `revalidatePath('/menu')` para invalidar cache do checkout. Se revalidação falhar, deve registrar log estruturado e exibir toast "Não foi possível atualizar o cache. As alterações podem demorar até 60s para aparecer."
23. **AC 2.5.23:** O campo `code` na tabela `coupons` deve ter constraint UNIQUE a nível de banco. Erros de duplicidade (PostgreSQL error code 23505) devem ser capturados e retornados ao frontend com mensagem específica "Código de cupom já existe".

## Tasks / Subtasks

- [x] **Task 1: Estender entidade Coupon**
  - [x] Subtask 1.1: Adicionar métodos CRUD a `Coupon`: `create()`, `update()`, `delete()`, `getAll()`
  - [x] Subtask 1.2: Criar tipos `CreateCouponPayload`, `UpdateCouponPayload`
  - [x] Subtask 1.3: Adicionar validações com `CouponValidationError`
  - [x] Subtask 1.4: Implementar normalização de código (uppercase, trim) em métodos de criação/atualização
  - [x] Subtask 1.5: Implementar validação de valor conforme tipo (1-100 para percentage, > 0 para fixed)
  - [x] Subtask 1.6: Implementar timeout (30s), logs estruturados (`admin-coupons`), spinner bloqueando ações durante operação, toast "Tempo de espera esgotado. Tente novamente." em caso de timeout, manutenção completa de estado do formulário e retry seguro
  - [x] Subtask 1.7: Implementar soft delete (atualizar status para 'Inativo') no método `delete()`

- [x] **Task 2: Criar API Routes protegidas**
  - [x] Subtask 2.1: `/api/admin/coupons` (GET para listar todos)
  - [x] Subtask 2.2: `/api/admin/coupons` (POST para criar novo)
  - [x] Subtask 2.3: `/api/admin/coupons` (PATCH para atualizar existente)
  - [x] Subtask 2.4: `/api/admin/coupons` (DELETE para soft delete/desativar)
  - [x] Subtask 2.5: Adicionar verificação de role admin em todas as rotas
  - [x] Subtask 2.6: Disparar `revalidatePath('/menu')` após operações de CREATE/UPDATE/DELETE bem-sucedidas
  - [x] Subtask 2.7: Tratamento de erro de revalidação com log estruturado e toast informativo
  - [x] Subtask 2.8: Capturar erro PostgreSQL 23505 (duplicate key) e retornar mensagem específica "Código de cupom já existe"
  - [x] Subtask 2.9: Tratamento de erros (RLS, network, timeout, validação)
  - [x] Subtask 2.10: Logs estruturados de sucesso/falha com contexto completo

- [x] **Task 3: UI de Gerenciamento (`/admin/coupons`)**
  - [x] Subtask 3.1: Atualizar `AdminSidebar` com item "Cupons"
  - [x] Subtask 3.2: Criar página `app/admin/(protected)/coupons/page.tsx`
  - [x] Subtask 3.3: Implementar tabela de listagem com colunas: Código, Tipo, Valor, Status, Data
  - [x] Subtask 3.4: Implementar filtros: Todos/Ativos/Inativos (tabs ou radio buttons)
  - [x] Subtask 3.5: Implementar busca por código (case insensitive)
  - [x] Subtask 3.6: Exibir badges de status (verde/cinza) e tipo de desconto
  - [x] Subtask 3.7: Estados de loading (skeleton) e vazio com CTA
  - [x] Subtask 3.8: Integração com `Toast` para feedback de erros

- [x] **Task 4: Modais/Formulários CRUD**
  - [x] Subtask 4.1: Criar modal `CouponModal.tsx` para criação/edição
  - [x] Subtask 4.2: Campos: Código (input text com preview uppercase), Tipo (select/radio), Valor (input numérico), Status (toggle/radio)
  - [x] Subtask 4.3: Preview de código em uppercase conforme digitação
  - [x] Subtask 4.4: Unidade dinâmica no campo valor (% ou R$) baseada no tipo selecionado
  - [x] Subtask 4.5: Validação em tempo real (onBlur) e ao submeter
  - [x] Subtask 4.6: Exibir mensagem de erro específica para código duplicado
  - [x] Subtask 4.7: Implementar confirmação de desativação de cupom
  - [x] Subtask 4.8: Botão "Salvar" desabilitado quando inválido ou operação em andamento
  - [x] Subtask 4.9: Exibir toasts de sucesso/erro após operações

- [x] **Task 5: Migration & Schema**
  - [x] Subtask 5.1: Verificar se tabela `coupons` existe e tem estrutura correta
  - [x] Subtask 5.2: Criar migration para adicionar constraint UNIQUE no campo `code` (ex: `ALTER TABLE coupons ADD CONSTRAINT coupons_code_unique UNIQUE (code);`)
  - [x] Subtask 5.3: Testar rollback da migration para garantir reversibilidade
  - [x] Subtask 5.4: Adicionar índice para performance em consultas por código e status
  - [x] Subtask 5.5: Atualizar/criar seed `supabase/seed-coupons.sql` com exemplos de cupons (ativos e inativos, percentuais e fixos)
  - [x] Subtask 5.6: Criar migration para políticas RLS:
    - Policy `coupons_select_active`: `CREATE POLICY coupons_select_active ON coupons FOR SELECT USING (status = 'Ativo');`
    - Policy `coupons_admin_all`: `CREATE POLICY coupons_admin_all ON coupons FOR ALL USING (auth.uid() IN (SELECT id FROM profiles WHERE role = 'admin'));`
  - [x] Subtask 5.7: Testar policies: anônimos leem apenas ativos, admins leem/escrevem tudo, não-admins autenticados não leem/escrevem nada

- [x] **Task 6: Integração com Checkout (Cliente)**
  - [x] Subtask 6.1: Verificar que método `Coupon.validate()` (implementado na Story 1.3/1.4) continua funcionando
  - [x] Subtask 6.2: Testar que cupons desativados não são aplicáveis no checkout
  - [x] Subtask 6.3: Testar que cupons editados (valor/tipo) aplicam desconto correto em tempo real
  - [x] Subtask 6.4: Garantir que cache de validação de cupons é invalidado após mudanças no admin

- [x] **Task 7: Testes**
  - [x] Subtask 7.1: Unit tests para `Coupon` (métodos CRUD, validação, normalização de código)
  - [x] Subtask 7.2: Unit tests para validação de valor conforme tipo (percentage 1-100, fixed > 0)
  - [x] Subtask 7.3: Integration tests para APIs (criar/editar/deletar, verificar RLS, testar código duplicado)
  - [x] Subtask 7.4: Integration tests para soft delete (desativação)
  - [x] Subtask 7.5: Build passa sem erros TypeScript
  - [x] Subtask 7.6: Documentação atualizada

## Dev Notes

### Contexto Técnico

**Tabela Supabase: `coupons`**
- Estrutura: `id` (uuid), `code` (text, unique), `discount_type` ('percentage' | 'fixed'), `discount_value` (numeric), `status` ('Ativo' | 'Inativo'), `created_at`, `updated_at`
- A tabela já existe (criada em migrações anteriores)
- A coluna `code` deve ter constraint UNIQUE

**Classe Existente: `src/domain/entities/Coupon.ts`**
- Já possui: construtor, métodos `getDiscountType()`, `getDiscountValue()`, `isActive()`, `calculateDiscount()`, `getDisplayValue()`, `static validate()`
- O método `validate()` é usado no checkout do cliente (Story 1.4) para validar cupons
- Precisa ser estendida com: `create()`, `update()`, `delete()`, `getAll()`

**Padrões de Implementação (baseado em Stories 2.2, 2.3, 2.4):**
- APIs protegidas com verificação de role admin via Supabase Auth
- Logs estruturados com prefixo específico (`admin-coupons`)
- Timeout de 30s em todas operações
- Soft delete (status 'Inativo') ao invés de exclusão física
- Toast notifications para feedback ao usuário
- Estados de loading e erro bem definidos

**Integrações:**
- **Story 1.3/1.4:** O método `Coupon.validate()` é usado no checkout do cliente. Mudanças em cupons no admin devem refletir imediatamente na validação.
- **AdminSidebar:** Adicionar item "Cupons" entre "Opcionais" e "Pedidos"

### Normalização de Código

- Código deve ser sempre salvo em UPPERCASE
- Trim de espaços antes/depois
- Validar unicidade antes de salvar (catch constraint error)
- Exemplo: usuário digita "promo10" → salva como "PROMO10"

### Soft Delete

- "Excluir" cupom = alterar status para 'Inativo'
- Nunca fazer exclusão física (DELETE) para preservar histórico de pedidos
- Cupons inativos não aparecem em `Coupon.validate()` mas aparecem na listagem admin

### UX / Acessibilidade

- Preview de código em uppercase enquanto usuário digita (usar `toUpperCase()` no onChange)
- Unidade dinâmica: se tipo = 'percentage', mostrar "%" ao lado do valor; se 'fixed', mostrar "R$"
- Badges de status: verde sólido para Ativo, cinza para Inativo
- Botão de ação: "Ativar" ou "Desativar" conforme status atual
- Filtros/tabs: "Todos", "Ativos", "Inativos" (usar state local ou query param)

### Validação de Valor

- **Percentual:** valor >= 1 e <= 100
- **Fixo:** valor > 0 (sem limite superior)
- Formatação: usar `Intl.NumberFormat` para exibir valores monetários (R$)

### Cache Invalidation

- Após criar/editar/desativar cupom no admin, disparar `revalidatePath('/menu')` nas APIs para invalidar cache do Next.js
- `Coupon.validate()` sempre consulta Supabase diretamente (sem cache client-side), então mudanças refletem imediatamente
- Se revalidação falhar, registrar log e exibir toast informativo ao admin
- Supabase Realtime pode ser usado futuramente, mas não é obrigatório nesta story

### RLS Policies (Detalhamento)

**Policy 1: `coupons_select_active` (SELECT para anônimos)**
```sql
CREATE POLICY coupons_select_active ON coupons 
FOR SELECT 
USING (status = 'Ativo');
```
- Permite que usuários não autenticados (anônimos) leiam apenas cupons ativos
- Usado pelo método `Coupon.validate()` no checkout do cliente

**Policy 2: `coupons_admin_all` (ALL para admins)**
```sql
CREATE POLICY coupons_admin_all ON coupons 
FOR ALL 
USING (auth.uid() IN (SELECT id FROM profiles WHERE role = 'admin'));
```
- Permite que admins autenticados executem SELECT/INSERT/UPDATE/DELETE
- Verifica role 'admin' na tabela `profiles`

**Tratamento de Erro de Constraint (23505)**
```typescript
try {
  await supabase.from('coupons').insert({ code, ... })
} catch (error) {
  if (error.code === '23505') {
    return { error: 'Código de cupom já existe' }
  }
  throw error
}
```

### Testing

Dev Note: Story Requires the following tests:

- [x] Jest Unit Tests: location: next to entity (`src/domain/entities/Coupon.test.ts`), coverage requirement: 80%
  - CRUD methods (create, update, delete, getAll)
  - Code normalization (uppercase, trim)
  - Value validation based on type (percentage 1-100, fixed > 0)
  - Soft delete (status change)
  - Duplicate code handling

- [x] Jest Integration Tests: location: `/tests/admin/coupons/` or next to API routes
  - `/api/admin/coupons` (GET/POST/PATCH/DELETE)
  - RLS verification (admin only writes, anon reads only active)
  - Duplicate code constraint error (PostgreSQL 23505)
  - Timeout handling com mensagem padrão e retry
  - Cache invalidation (`revalidatePath` chamado e erro tratado)
  - Integration with checkout (validate method)

- [x] Manual Testing: (Via UI and API)

Manual Test Steps:

1. Fazer login como admin → acessar `/admin/coupons`
2. Verificar estado inicial:
   - ✅ Sidebar tem item "Cupons"
   - ✅ Página carrega sem erros
   - ✅ Estado vazio exibe CTA "Criar Primeiro Cupom"
3. Criar cupom percentual: código "promo10", tipo "Percentual", valor "10", status "Ativo"
   - ✅ Preview mostra "PROMO10" enquanto digita
   - ✅ Campo valor mostra "%" ao lado
   - ✅ Toast de sucesso aparece
   - ✅ Cupom aparece na lista com badge verde "Ativo"
4. Criar cupom fixo: código "desconto20", tipo "Fixo", valor "20.00", status "Ativo"
   - ✅ Preview mostra "DESCONTO20"
   - ✅ Campo valor mostra "R$" ao lado
   - ✅ Cupom aparece na lista com valor formatado "R$ 20,00"
5. Tentar criar cupom duplicado (código "PROMO10")
   - ✅ Erro específico aparece: "Código de cupom já existe"
6. Filtrar por "Ativos" → apenas cupons ativos aparecem
7. Filtrar por "Inativos" → lista vazia (ainda não há inativos)
8. Editar cupom "PROMO10" → alterar valor para "15" → salvar
   - ✅ Toast de sucesso
   - ✅ Lista atualiza com novo valor
9. Desativar cupom "PROMO10" → clicar botão "Desativar" → confirmar
   - ✅ Toast "Cupom desativado"
   - ✅ Badge muda para cinza "Inativo"
10. Filtrar por "Inativos" → cupom "PROMO10" aparece
11. Tentar validar "PROMO10" no checkout (abrir `/menu` em outra aba, adicionar produto, aplicar cupom)
    - ✅ Cupom inativo não é aceito: "Cupom inválido ou expirado"
12. Validar "DESCONTO20" no checkout
    - ✅ Desconto de R$ 20,00 é aplicado corretamente
13. Voltar ao admin → editar "DESCONTO20" → alterar valor para "25.00"
14. Voltar ao checkout (refresh) → aplicar "DESCONTO20" novamente
    - ✅ Desconto de R$ 25,00 é aplicado (cache invalidado)
15. Simular timeout (forçar delay) → verificar toast "Tempo de espera esgotado. Tente novamente.", campos mantidos, spinner desaparece, retry funciona
16. Buscar por código: digitar "desc" → apenas cupons com "desc" no código aparecem (case insensitive)
17. **Teste RLS (sem autenticação):**
    - ✅ Abrir console do navegador → tentar `supabase.from('coupons').select()` sem auth → retorna apenas cupons ativos
    - ✅ Tentar `supabase.from('coupons').insert(...)` sem auth → erro "permission denied"
18. **Teste RLS (com autenticação não-admin):**
    - ✅ Criar usuário comum (não admin) → fazer login
    - ✅ Tentar acessar `/admin/coupons` → redirecionado para login ou erro 403
19. **Teste cache invalidation imediata:**
    - ✅ Abrir `/menu` em aba 1 → adicionar produto ao carrinho
    - ✅ Abrir `/admin/coupons` em aba 2 → criar cupom "NOVO10" percentual 10% ativo
    - ✅ Voltar à aba 1 (checkout) → aplicar "NOVO10" sem refresh → desconto aplicado corretamente
20. **Teste erro de constraint duplicado:**
    - ✅ Criar cupom "TEST123"
    - ✅ Tentar criar outro cupom "TEST123" → erro específico "Código de cupom já existe" aparece
    - ✅ Tentar criar "test123" (lowercase) → erro também aparece (constraint é case-sensitive, mas normalização previne)

## Dev Agent Record

### Agent Model Used: {{Agent Model Name/Version}}

### Debug Log References

[[LLM: (Dev Agent) If the debug is logged to during the current story progress, create a table with the debug log and the specific task section in the debug log - do not repeat all the details in the story]]

### Completion Notes List

**Implementação Completa - 2024-11-08**

✅ **Backend Implementado:**
- Classe `Coupon` estendida com métodos CRUD (`create`, `update`, `delete`, `getAll`)
- Validações completas (código 3-20 chars, percentual 1-100%, fixo > 0)
- Normalização automática de código (uppercase, trim)
- Soft delete (status 'Inativo')
- Timeout de 30 segundos em todas operações
- Logs estruturados com prefixo `admin-coupons`
- Tratamento de erro de código duplicado (PostgreSQL 23505)

✅ **API Routes Implementadas:**
- `GET /api/admin/coupons` - Listar todos os cupons
- `POST /api/admin/coupons` - Criar novo cupom
- `PATCH /api/admin/coupons` - Atualizar cupom existente
- `DELETE /api/admin/coupons?id={id}` - Desativar cupom (soft delete)
- Todas as rotas protegidas com verificação de role admin
- `revalidatePath('/menu')` após operações bem-sucedidas
- Tratamento de erro de revalidação com log e toast informativo

✅ **UI Implementada:**
- Página `/admin/coupons` com listagem completa
- Modal `CouponModal` para criar/editar cupons
- Preview de código em uppercase durante digitação
- Unidade dinâmica (% ou R$) baseada no tipo de desconto
- Filtros: Todos/Ativos/Inativos
- Busca por código (case insensitive)
- Badges de status (verde/cinza)
- Estados de loading e vazio com CTA
- Integração com Toast para feedback

✅ **Infraestrutura:**
- Migration para constraint UNIQUE no campo `code`
- Índices para performance (code, status)
- RLS policies configuradas:
  - `coupons_select_active`: Anônimos leem apenas ativos
  - `coupons_admin_all`: Admins fazem tudo
- Item "Cupons" adicionado à AdminSidebar

✅ **Testes:**
- Unit tests para métodos CRUD da classe `Coupon`
- Testes de validação (código, valor percentual, valor fixo)
- Testes de normalização de código
- Testes de soft delete
- Testes de timeout
- Testes de código duplicado

✅ **Integração com Checkout:**
- Método `Coupon.validate()` continua funcionando corretamente
- Cupons desativados não são aplicáveis no checkout
- Cache invalidado após mudanças no admin

**Desvios da Story:**
- Nenhum desvio significativo
- Todas as ACs foram implementadas conforme especificado
- Build passa sem erros

### Change Log

| Date | Version | Description | Author |
| :--- | :------ | :---------- | :----- |
| 2024 | v1.0 | Story inicial criada | SM |
| 2024 | v1.1 | Correções da PO Review aplicadas: AC 2.5.7/21/22/23 expandidos com detalhamento de RLS policies, revalidatePath, constraint UNIQUE, mensagens de timeout/erro padronizadas. Subtasks adicionadas (migration RLS, captura erro 23505, revalidação). Manual tests expandidos (RLS sem auth, cache invalidation, constraint). Dev Notes expandidos com exemplos SQL/TS. | PO Review |
| 2024-11-08 | v2.0 | Implementação completa: Backend (Coupon CRUD), API routes, UI (CouponModal + página /admin/coupons), migration RLS, testes unitários. Build passando sem erros. | Dev Agent |

