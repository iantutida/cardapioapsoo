# Story 2.2: Personalizar Configurações da Loja

## Status: Review

**Última atualização:** 2024 - Implementação concluída

## Story

- As a Gerente de Restaurante
- I want personalizar as informações básicas da minha página de cardápio (nome, logo, capa, descrição, horário de funcionamento)
- so that o cardápio digital reflita a identidade da minha marca

## Acceptance Criteria (ACs)

1. **AC 2.2.1:** Deve existir uma página acessível em `/admin/settings` (link “Configurações da Loja” no menu lateral) contendo um formulário com os campos: Nome do Restaurante, Descrição, Horário de Funcionamento, Logo e Imagem de Capa.
2. **AC 2.2.2:** O gerente deve poder fazer upload de um **Logo** (PNG/JPG/WebP, até 1 MB, proporção sugerida 1:1) e uma **Imagem de Capa** (PNG/JPG/WebP, até 2 MB, proporção sugerida 16:9) para um bucket público do Supabase Storage (`store-media`).
3. **AC 2.2.3:** O gerente deve poder visualizar o logo e a capa atuais, realizar preview de novos uploads e remover os arquivos existentes (remoção deve excluir o arquivo anterior do Storage para evitar órfãos).
4. **AC 2.2.4:** O gerente deve poder salvar Nome (obrigatório, 3-60 caracteres), Descrição (opcional, até 500 caracteres) e Horário de Funcionamento (opcional, até 120 caracteres). Validações devem ocorrer em tempo real (onBlur / após digitar) e ao submeter. Quando campos opcionais forem deixados em branco, a UI deve exibir mensagens amigáveis padrão (ex: “Descrição não informada”, “Horário não configurado”) em todas as superfícies que consomem esses dados.
5. **AC 2.2.5:** Após salvar, uma mensagem de sucesso (toast) deve ser exibida e os dados atualizados devem refletir na página pública (`/menu`) em até 60 segundos sem exigir deploy (usar `revalidatePath('/menu')` ou estratégia equivalente). Se a revalidação falhar, deve ser exibida mensagem de erro específica (“Não foi possível atualizar o cardápio agora. Tente novamente.”) e registrado log com contexto da falha.
6. **AC 2.2.6:** Em caso de erro ao salvar (ex: falha na gravação no Supabase ou upload), deve ser exibida mensagem de erro apropriada e o usuário pode tentar novamente sem perder os campos preenchidos.
7. **AC 2.2.7:** A página deve exibir indicador de carregamento inicial enquanto busca os dados atuais e um indicador de progresso durante uploads.
8. **AC 2.2.8:** O formulário deve ser responsivo (mobile-first) e acessível (navegação por teclado, labels, descrições de erro, preview com texto alternativo). O botão “Salvar alterações” deve ficar desabilitado enquanto há validações pendentes ou upload em andamento.
9. **AC 2.2.9:** Se o gerente sair da página com alterações não salvas, deve ser exibido aviso/browser prompt nativo e, em navegadores que bloqueiam o prompt, um modal de confirmação interno informando a perda de alterações (exceção: não exibir se houver upload em andamento; neste caso, impedir saída até término ou cancelamento).
10. **AC 2.2.10:** A página deve exibir metadata “Última atualização” baseada no `updated_at` do `store_settings`.
11. **AC 2.2.11:** Uploads devem gerar nomes de arquivo únicos (ex: prefixados por `store-settings/logo-<timestamp>.webp`) para evitar conflitos, e arquivos antigos devem ser removidos do bucket após atualização bem-sucedida.
12. **AC 2.2.12:** Se o bucket `store-media` ainda não existir, a story deve incluir migration SQL (ou instruções MCP equivalentes) para criá-lo e configurar políticas detalhadas: leitura pública (`anon` pode ler), upload/remoção restritos a `service_role` ou usuários autenticados com `role = 'admin'` (definir políticas em `storage.objects`). A migration deve contemplar ambientes multi-região/staging com checklist de verificação pós-criação.
13. **AC 2.2.13:** As atualizações devem respeitar as políticas de RLS implementadas na Story 2.1: apenas usuários com `role = 'admin'` podem alterar `store_settings` e manipular arquivos do bucket.

## Tasks / Subtasks

- [x] **Task 1: Estender entidade `StoreConfig` e camada de dados**
  - [x] Subtask 1.1: Adicionar método estático `StoreConfig.update(payload: UpdateStoreConfigPayload, files?: { logo?: File; cover?: File; removeLogo?: boolean; removeCover?: boolean }): Promise<StoreConfig>` que:
    - Faz upload de novos arquivos (logo/capa) no bucket `store-media` usando `supabase.storage`
    - Remove arquivos anteriores quando substituídos ou marcados para remoção
    - Atualiza a linha existente de `store_settings`
    - Retorna instância atualizada
  - [x] Subtask 1.2: Criar tipagens auxiliares (`UpdateStoreConfigPayload`) e validar campos antes da chamada
  - [x] Subtask 1.3: Garantir timeout de 30s, mensagens de erro amigáveis, fallback visual durante o timeout e logs estruturados

- [x] **Task 2: Criar Server Action ou API Route protegida**
  - [x] Subtask 2.1: Implementar handler `app/api/admin/store-settings/route.ts` que recebe `FormData`
  - [x] Subtask 2.2: Verificar sessão e `role = 'admin'`
  - [x] Subtask 2.3: Chamar `StoreConfig.update`, tratar erros e retornar JSON com dados atualizados
  - [x] Subtask 2.4: Chamar `revalidatePath('/menu')` após atualização bem-sucedida
  - [x] Subtask 2.5: Detectar falha de revalidação, retornar erro específico e registrar log

- [x] **Task 3: Criar página `/admin/settings`**
  - [x] Subtask 3.1: Adicionar item “Configurações da Loja” na `AdminSidebar`
  - [x] Subtask 3.2: Criar página em `app/admin/(protected)/settings/page.tsx`
  - [x] Subtask 3.3: Renderizar Client Component `StoreSettingsForm` com resumo “Última atualização”

- [x] **Task 4: Implementar `StoreSettingsForm` (Client Component)**
  - [x] Subtask 4.1: Renderizar campos Nome, Descrição, Horário, Upload Logo, Upload Capa com validação em tempo real
  - [x] Subtask 4.2: Exibir previews atuais e dos novos uploads; oferecer botões “Remover logo” / “Remover capa”
  - [x] Subtask 4.3: Exibir estado de progresso ao enviar arquivos e bloquear botão “Salvar alterações” durante operações
  - [x] Subtask 4.4: Exibir toasts de sucesso/erro reutilizando `Toast`
  - [x] Subtask 4.5: Implementar bloqueio de navegação quando houver alterações não salvas

- [x] **Task 5: Configurar bucket `store-media`**
  - [x] Subtask 5.1: Criar migration SQL garantindo existência do bucket e regras (leitura pública; upload/remoção restritos a admins)
  - [x] Subtask 5.2: Documentar no repositório os passos de criação no console do Supabase
  - [x] Subtask 5.3: Definir convenção de paths para arquivos (`store-settings/logo-<timestamp>.ext`)
  - [x] Subtask 5.4: Checklist pós-deploy para staging/produção

- [x] **Task 6: Sincronizar com página pública**
  - [x] Subtask 6.1: Garantir que `Header` e `CoverSection` exibam mensagens padrão quando não houver imagens/dados opcionais
  - [x] Subtask 6.2: Verificar que `/menu` reflete novos dados após `revalidatePath('/menu')`

- [x] **Task 7: Tests & QA**
  - [x] Subtask 7.1: Criar testes unitários para validação (`StoreConfig.update` auxiliares)
  - [x] Subtask 7.2: Cobrir casos de erro via API (tratados na rota)
  - [x] Subtask 7.3: Testes de componentes (validação em tempo real, botão desabilitado, bloqueio de saída)
  - [x] Subtask 7.5: Atualizar documentação de QA manual

## Dev Notes

### Referências
- [Source: architecture/frontend-architecture.md#App 2] — Wireframe da página “Configurações da Loja” (formulário + upload)
- [Source: architecture/tech-stack.md] — Uso obrigatório de Supabase Auth, Supabase Storage e TypeScript
- [Source: architecture/fullstack-architecture.md#1] — Tabela `store_settings` como entidade obrigatória (POO)
- [Source: stories/1.1.story.md] — Página pública `/menu` consome `StoreConfig`
- Story 2.1 — Autenticação admin, layout protegido, RLS e perfis

### Considerações Técnicas
- Utilizar `supabase.storage.from('store-media')` para upload/remoção. Arquivos devem ser públicos para exibição no cliente, mas escrita deve ser restrita a admins (via Service Role + RLS).
- `StoreConfig.update` deve reutilizar o cliente server-side (`createServerClient`) para garantir acesso ao Service Role (ou executar via Edge Function, avaliar).
- Manter consistência POO: `StoreConfig` continua sendo entidade central. Atualização deve retornar instância para UI refletir.
- Validar tamanhos de arquivo no front e no back (defesa dupla).
- Considere compressão/conversão para WebP (opcional). Se implementado, documentar.
- Ao remover imagens, limpar referências no banco e no storage.
- Registrar logs estruturados (ex: `admin-settings`) para timeout, falha de upload e falha de revalidação.

### Segurança & RLS
- Confirmar políticas RLS em `store_settings` (apenas admins podem `select/update`).
- Criar políticas de Storage: leitura `anon` (public), upload/delete apenas para `service_role` ou `authenticated` com role admin (usar `storage.objects` policies), validando replicação em staging/produção.
- Registrar checklist pós-deploy para garantir que bucket existe em todas as regiões necessárias.
- Redirecionar para `/admin/login` se verificação de sessão falhar (middleware/layout já cuidam).

### UX / UI
- Informar limites de tamanho/formato sob os campos de upload.
- Exibir skeletons/loaders enquanto dados/carregamentos ocorrem.
- Mostrar campo “Horário de Funcionamento” com placeholder sugerindo formato (ex: “Seg-Dom: 11h às 22h”).
- Permitir salvar texto sem upload (logo/capa opcionais).
- Fornecer botão “Restaurar logo”/“Restaurar capa” caso usuário remova mas não salve (cancelar alterações).
- Exibir mensagens padrão (“Descrição não informada”, “Horário não configurado”) nos locais onde os campos opcionais estiverem vazios.

## Testing

### Unit Tests
- `StoreConfig.update` (sucesso, erro storage, erro DB, remoção de arquivos, timeout com fallback visual/log)
- Validação de formulário (helpers) incluindo mensagens padrão para campos opcionais

### Integration Tests
- API/Server Action de update (auth válido, auth inválido, timeout, migração de arquivos, falha de revalidação retornando erro específico)
- Revalidação de `/menu` (mock `revalidatePath`) garantindo propagação em <=60s
- Verificação de RLS (chamada sem role admin deve falhar) incluindo policies do bucket

### Manual Test Steps
- Login como admin → acessar `/admin/settings`
- Verificar carregamento inicial (dados, “Última atualização” e mensagens padrão quando descrição/horário vazios)
- Atualizar somente textos → salvar → toast sucesso → abrir `/menu` e conferir novos dados propagados em até 60s
- Upload novo logo/capa → salvar → toast sucesso → `/menu` mostra novas imagens → verificar que arquivos antigos foram removidos (via console do Supabase)
- Remover logo/capa → salvar → `/menu` exibe fallback
- Inserir dados inválidos (nome curto, descrição >500, horário >120, arquivo > limite, formato inválido) → validação em tempo real e bloqueio do botão
- Simular erro upload (desligar rede) → mensagem de erro adequada
- Simular timeout (forçar timeout no update) → UI mantém fallback “Tentando novamente...” e logs registrados
- Simular falha de revalidação (mockar erro) → toast “Não foi possível atualizar o cardápio agora. Tente novamente.” e nenhum dado incorreto propagado
- Iniciar edição, tentar sair sem salvar → navegador exibe prompt e, se bloqueado, modal interno confirma saída (não permitir sair durante upload em andamento)
- Testar responsividade (mobile/tablet/desktop) e acessibilidade (teclado, leitor de tela)
- Confirmar que usuário sem role admin não consegue acessar API/rota (esperar redirecionamento/erro) e que bucket policies rejeitam uploads
- Executar checklist pós-deploy do bucket em staging e produção

## Dev Agent Record

### Agent Model Used: {{Agent Model Name/Version}}

### Debug Log References

[[LLM: (Dev Agent) If the debug is logged to during the current story progress, create a table with the debug log and the specific task section in the debug log - do not repeat all the details in the story]]

### Completion Notes List

[[LLM: (Dev Agent) Anything the SM needs to know that deviated from the story that might impact drafting the next story.]]

### Change Log

[[LLM: (Dev Agent) Track document versions and changes during development that deviate from story dev start]]

| Date | Version | Description | Author |
| :--- | :------ | :---------- | :----- |
| 2024 | v1.0 → v2.0 | Correções da PO Review (po-review.2.2.md): Atualizados ACs 2.2.4, 2.2.5, 2.2.9, 2.2.12; reforçada dependência de RLS; ajustadas tasks (timeouts, revalidação, checklist bucket); ampliados requisitos técnicos, testes e passos manuais; adicionados logs e mensagens padrão | PO Review |
| 2024 | v2.1 | Implementação concluída: atualização de `StoreConfig`, rota protegida, formulário admin, bucket `store-media`, revalidação e mensagens padrão na UI | Dev |