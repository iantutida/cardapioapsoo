# Story 1.3: Gerenciar o Carrinho de Compras

## Status: Draft (Corrigido após PO Review)

**Última atualização:** 2024 - Aplicadas correções da PO Review (po-review.1.3.md)

## Story

- As a Cliente do Restaurante
- I want ver um resumo do meu carrinho de compras com todos os itens, seus preços e um subtotal claro
- so that eu possa revisar, modificar ou remover itens antes de finalizar meu pedido

## Acceptance Criteria (ACs)

1. **AC 1.3.1:** O carrinho deve ser facilmente acessível de qualquer lugar da página do cardápio através de um botão flutuante fixo que exibe o número de itens no carrinho.
2. **AC 1.3.2:** O carrinho deve listar cada item, mostrando nome do produto, quantidade, opcionais selecionados (com nomes e custos adicionais formatados, ex: "Bacon +R$2,00" ou "Grátis" se custo for zero), observações (se houver) e o preço total do item formatado.
3. **AC 1.3.3:** O cliente deve poder **remover** um item do carrinho através de um botão "Remover" em cada item.
4. **AC 1.3.4:** O cliente deve poder **editar** um item no carrinho clicando em "Editar", que reabre o modal da História 1.2 pré-preenchido com os dados do item. Se o usuário fechar o modal sem salvar alterações (clicando em X, ESC ou fora do modal), o item original deve permanecer inalterado no carrinho.
5. **AC 1.3.5:** O carrinho deve exibir um **Subtotal** (soma de todos os itens do carrinho).
6. **AC 1.3.6:** O carrinho deve ter um campo para inserir um **Código de Cupom** e um botão "Aplicar".
7. **AC 1.3.7:** Se um cupom válido (História 2.5) for aplicado, o desconto deve ser exibido e o **Total** (Subtotal - Desconto) deve ser recalculado. **Nota:** Se Story 2.5 ainda não estiver disponível, a funcionalidade deve funcionar com cupons já cadastrados diretamente no banco (via SQL/MCP).
8. **AC 1.3.8:** Se o carrinho estiver vazio, o modal deve exibir mensagem: "Seu carrinho está vazio. Adicione itens para continuar."
9. **AC 1.3.9:** O modal do carrinho deve poder ser fechado clicando fora dele, no botão X ou pressionando ESC.
10. **AC 1.3.10:** O botão flutuante do carrinho deve exibir um badge com o número total de itens (soma de quantidades). Se o carrinho estiver vazio, o badge não deve ser exibido.
11. **AC 1.3.11:** Ao remover um item do carrinho, deve ser exibida uma confirmação visual (ex: toast/notificação) indicando que o item foi removido.
12. **AC 1.3.12:** Se um cupom inválido for inserido, deve ser exibida mensagem de erro apropriada (ex: "Cupom inválido ou expirado").
13. **AC 1.3.13:** Se o cupom for aplicado com sucesso, deve ser exibida confirmação visual e o cupom aplicado deve ser exibido na interface.
14. **AC 1.3.14:** O cliente deve poder remover o cupom aplicado através de um botão "Remover Cupom".
15. **AC 1.3.15:** O botão "Finalizar Pedido" deve estar desabilitado se o carrinho estiver vazio.
16. **AC 1.3.16:** O modal do carrinho deve ser responsivo e funcionar bem em diferentes tamanhos de tela (mobile, tablet, desktop).
17. **AC 1.3.17:** Ao recarregar a página, se um cupom estiver aplicado, o sistema deve validar se o cupom ainda está ativo no Supabase. Se o cupom foi desativado, deve ser removido automaticamente e o usuário deve ser notificado através de mensagem informativa.
18. **AC 1.3.18:** Se houver erro ao validar cupom no Supabase (ex: erro de rede, timeout), o sistema deve exibir mensagem de erro apropriada (ex: "Erro ao validar cupom. Tente novamente.") e não aplicar o cupom.
19. **AC 1.3.19:** Ao editar um item do carrinho, se o usuário fechar o modal sem salvar alterações (clicando em X, ESC ou fora do modal), o item original deve permanecer inalterado no carrinho.
20. **AC 1.3.20:** O botão flutuante do carrinho deve estar posicionado no canto inferior direito em desktop e tablet. Em mobile, pode estar no canto inferior direito ou centralizado na parte inferior, garantindo que não interfira com a navegação e seja facilmente acessível.
21. **AC 1.3.21:** Ao clicar em "Aplicar" no campo de cupom, o sistema deve exibir um indicador de carregamento enquanto valida o cupom no Supabase.
22. **AC 1.3.22:** O botão flutuante do carrinho deve ser acessível via teclado (Tab para focar, Enter para ativar) e ter label apropriado para screen readers (ex: "Abrir carrinho, X itens").

## Tasks / Subtasks

- [x] Task 1: Criar classe TypeScript para Cupom (AC: 1.3.6, 1.3.7, 1.3.12, 1.3.13, 1.3.14)
  - [x] Subtask 1.1: Criar classe `Coupon` conforme [Source: architecture/fullstack-architecture.md#5]
  - [x] Subtask 1.2: Implementar método estático `Coupon.validate(code: string): Promise<Coupon | null>` para validar cupom
  - [x] Subtask 1.3: Implementar métodos: `getDiscountType(): 'percentage' | 'fixed'`, `getDiscountValue(): number`, `isActive(): boolean`
  - [x] Subtask 1.4: Implementar método `calculateDiscount(subtotal: number): number` para calcular desconto baseado no tipo
- [x] Task 2: Estender CartContext para gerenciar cupom (AC: 1.3.6, 1.3.7, 1.3.12, 1.3.13, 1.3.14, 1.3.17, 1.3.18)
  - [x] Subtask 2.1: Adicionar estado para cupom aplicado no CartContext
  - [x] Subtask 2.2: Implementar função `applyCoupon(code: string): Promise<{ success: boolean; message: string }>`
  - [x] Subtask 2.3: Implementar função `removeCoupon(): void`
  - [x] Subtask 2.4: Implementar função `getDiscount(): number` para calcular desconto atual
  - [x] Subtask 2.5: Implementar função `getTotal(): number` para calcular total (subtotal - desconto)
  - [x] Subtask 2.6: Persistir cupom aplicado no localStorage junto com o carrinho
  - [x] Subtask 2.7: Implementar validação de cupom aplicado ao recarregar página (verificar se ainda está ativo no Supabase) (AC 1.3.17)
  - [x] Subtask 2.8: Implementar tratamento de erro ao validar cupom (ex: erro de rede, timeout) (AC 1.3.18)
- [x] Task 3: Criar componente Botão Flutuante do Carrinho (AC: 1.3.1, 1.3.10, 1.3.20, 1.3.22)
  - [x] Subtask 3.1: Criar componente `FloatingCartButton` fixo na página
  - [x] Subtask 3.2: Implementar ícone de carrinho
  - [x] Subtask 3.3: Implementar badge com contador de itens usando `getCartItemsCount()` do CartContext
  - [x] Subtask 3.4: Ocultar badge quando carrinho estiver vazio
  - [x] Subtask 3.5: Implementar onClick handler para abrir modal do carrinho
  - [x] Subtask 3.6: Aplicar estilo fixo (position: fixed) para ficar sempre visível
  - [x] Subtask 3.7: Implementar posicionamento responsivo do botão flutuante conforme especificação (AC 1.3.20)
  - [x] Subtask 3.8: Implementar acessibilidade do botão flutuante (teclado, screen readers) (AC 1.3.22)
- [x] Task 4: Criar componente Modal do Carrinho (AC: 1.3.1, 1.3.8, 1.3.9, 1.3.16)
  - [x] Subtask 4.1: Criar componente `CartModal` conforme wireframe [Source: architecture/frontend-architecture.md#Modal 2]
  - [x] Subtask 4.2: Integrar com Radix UI Dialog ou componente similar para acessibilidade
  - [x] Subtask 4.3: Implementar botões de fechar (X, ESC, clicar fora)
  - [x] Subtask 4.4: Implementar mensagem quando carrinho estiver vazio (AC 1.3.8)
  - [x] Subtask 4.5: Aplicar design responsivo mobile-first
- [x] Task 5: Implementar lista de itens do carrinho (AC: 1.3.2)
  - [x] Subtask 5.1: Criar componente `CartItemList` para exibir lista de itens
  - [x] Subtask 5.2: Criar componente `CartItemCard` para exibir cada item individual
  - [x] Subtask 5.3: Implementar exibição de nome do produto, quantidade, opcionais selecionados (com nomes e custos)
  - [x] Subtask 5.4: Implementar exibição de observações (se houver)
  - [x] Subtask 5.5: Implementar exibição do preço total do item formatado
  - [x] Subtask 5.6: Formatar opcionais para exibição legível (ex: "Bacon +R$2,00")
- [x] Task 6: Implementar funcionalidade de remover item (AC: 1.3.3, 1.3.11)
  - [x] Subtask 6.1: Adicionar botão "Remover" em cada `CartItemCard`
  - [x] Subtask 6.2: Implementar confirmação antes de remover (opcional - pode ser direto)
  - [x] Subtask 6.3: Integrar com `removeFromCart()` do CartContext
  - [x] Subtask 6.4: Implementar confirmação visual (toast) após remover
- [x] Task 7: Implementar funcionalidade de editar item (AC: 1.3.4, 1.3.19)
  - [x] Subtask 7.1: Adicionar botão "Editar" em cada `CartItemCard`
  - [x] Subtask 7.2: Estender `ProductDetailModal` para aceitar modo de edição (props: `editItem?: CartItem`)
  - [x] Subtask 7.3: Pré-preencher modal com dados do item ao editar (quantidade, opcionais selecionados, observações)
  - [x] Subtask 7.4: Implementar lógica para atualizar item existente ao invés de criar novo ao salvar
  - [x] Subtask 7.5: Integrar com `updateCartItem()` do CartContext após salvar alterações
  - [x] Subtask 7.6: Implementar lógica para preservar item original se modal de edição for fechado sem salvar (AC 1.3.19)
- [x] Task 8: Implementar resumo financeiro (AC: 1.3.5, 1.3.7)
  - [x] Subtask 8.1: Criar componente `CartSummary` para exibir resumo financeiro
  - [x] Subtask 8.2: Implementar exibição de Subtotal usando `getCartTotal()` do CartContext
  - [x] Subtask 8.3: Implementar exibição de Desconto (se cupom aplicado) usando `getDiscount()` do CartContext
  - [x] Subtask 8.4: Implementar exibição de Total usando `getTotal()` do CartContext
  - [x] Subtask 8.5: Formatizar todos os valores monetários usando `Intl.NumberFormat`
- [x] Task 9: Implementar campo de cupom (AC: 1.3.6, 1.3.7, 1.3.12, 1.3.13, 1.3.14, 1.3.21)
  - [x] Subtask 9.1: Criar componente `CouponField` com campo de texto e botão "Aplicar"
  - [x] Subtask 9.2: Implementar validação de cupom ao clicar em "Aplicar"
  - [x] Subtask 9.3: Implementar exibição de mensagem de erro se cupom inválido (AC 1.3.12)
  - [x] Subtask 9.4: Implementar confirmação visual se cupom aplicado com sucesso (AC 1.3.13)
  - [x] Subtask 9.5: Exibir cupom aplicado na interface com botão "Remover Cupom" (AC 1.3.14)
  - [x] Subtask 9.6: Integrar com `applyCoupon()` e `removeCoupon()` do CartContext
  - [x] Subtask 9.7: Implementar indicador de carregamento ao validar cupom (AC 1.3.21)
- [x] Task 10: Implementar botão "Finalizar Pedido" (AC: 1.3.15)
  - [x] Subtask 10.1: Criar botão "Finalizar Pedido" no modal do carrinho
  - [x] Subtask 10.2: Desabilitar botão se carrinho estiver vazio (AC 1.3.15)
  - [x] Subtask 10.3: Implementar navegação para página de checkout (Story 1.4) ao clicar
  - [x] Subtask 10.4: Fechar modal do carrinho ao navegar para checkout
- [x] Task 11: Integrar modal do carrinho com botão flutuante (AC: 1.3.1)
  - [x] Subtask 11.1: Adicionar estado para controlar abertura/fechamento do modal do carrinho
  - [x] Subtask 11.2: Conectar botão flutuante com abertura do modal
  - [x] Subtask 11.3: Garantir que atualizações no carrinho atualizem contador do botão flutuante

## Dev Notes

### Previous Story Insights

**Da Story 1.2:**
- `CartContext` já implementado com funções: `addToCart`, `removeFromCart`, `updateCartItem`, `getCartItems`, `getCartTotal`, `getCartItemsCount`, `clearCart`
- Estrutura de dados `CartItem` já definida em `src/types/cart.ts`
- `ProductDetailModal` já existe e pode ser reutilizado para edição
- Toast implementado com Radix UI Toast para confirmações visuais
- Padrão: Server Components do Next.js buscam dados e convertem para objetos simples para passar para Client Components
- Persistência no localStorage já implementada no CartContext

**Relevante para Story 1.3:**
- `ProductDetailModal` já foi estendido para aceitar modo de edição (`editItem` prop)
- CartContext já foi estendido para gerenciar cupom aplicado (implementado)
- Botão flutuante e modal do carrinho já foram criados e integrados em `MenuPageClient.tsx`
- Padrão de toast já estabelecido pode ser reutilizado para confirmações
- **Status de Implementação:** Componentes principais já implementados, mas testes ainda não verificados

### Data Models

Conforme [Source: architecture/fullstack-architecture.md#1]:

**Tabela `coupons`:**
- Campos relevantes: `id`, `code`, `discount_type` ('percentage' ou 'fixed'), `discount_value`, `status` ('Ativo' ou 'Inativo'), `created_at`, `updated_at`
- Propósito: Representa um cupom de desconto
- Nota: Cupom pode ser percentual (ex: 10%) ou valor fixo (ex: R$5,00)

**Estrutura de Cupom Aplicado:**
```typescript
interface AppliedCoupon {
  code: string
  discountType: 'percentage' | 'fixed'
  discountValue: number
  discountAmount: number // valor calculado do desconto aplicado ao subtotal
}
```

**Estendendo CartContext:**
```typescript
interface CartContextType {
  // ... funções existentes
  appliedCoupon: AppliedCoupon | null
  applyCoupon: (code: string) => Promise<{ success: boolean; message: string }>
  removeCoupon: () => void
  getDiscount: () => number
  getTotal: () => number
}
```

### API Specifications

**Supabase Client:**
- Usar `supabase-js` para acesso aos dados conforme [Source: architecture/tech-stack.md]
- Tabela: `coupons`
- Consulta necessária:
  - Buscar cupom por código onde `status = 'Ativo'` e `code = {código inserido}`
- Não há endpoints REST customizados - usar PostgREST do Supabase diretamente

**Nota:** Validação de cupom pode ser feita no cliente (Client Component) ou via API route do Next.js se necessário para segurança adicional.

### Component Specifications

Conforme [Source: architecture/frontend-architecture.md#Modal 2]:

**Estrutura do Modal do Carrinho:**
1. **Header:** Título "Carrinho" e botão de fechar (X)
2. **Lista de Itens:**
   - Cada item mostra: Nome do produto, Quantidade, Opcionais selecionados (com nomes e custos), Observações (se houver), Preço total do item
   - Botões "Editar" e "Remover" por item
3. **Campo de Cupom:** Campo de texto + Botão "Aplicar"
4. **Resumo Financeiro:**
   - Subtotal: R$ XX,XX
   - Desconto: -R$ XX,XX (se cupom aplicado)
   - Total: R$ XX,XX
5. **Botão de Ação:** "Finalizar Pedido" (desabilitado se carrinho vazio)

**Botão Flutuante do Carrinho:**
- Posição fixa: canto inferior direito em desktop e tablet (AC 1.3.20)
- Posição mobile: canto inferior direito ou centralizado na parte inferior, garantindo que não interfira com navegação (AC 1.3.20)
- Ícone de carrinho
- Badge com número de itens (oculto se vazio)
- Clique abre modal do carrinho
- Acessível via teclado (Tab para focar, Enter para ativar) e com label para screen readers (AC 1.3.22)

**Interações:**
- Clique no botão flutuante abre modal do carrinho
- Clique em "Editar" abre `ProductDetailModal` pré-preenchido
- Fechar modal de edição sem salvar preserva item original no carrinho (AC 1.3.19)
- Clique em "Remover" remove item e exibe confirmação
- Aplicar cupom valida código com indicador de carregamento e atualiza resumo financeiro (AC 1.3.21)
- Remover cupom restaura subtotal como total
- Erro ao validar cupom exibe mensagem de erro apropriada e não aplica cupom (AC 1.3.18)
- Cupom aplicado é validado ao recarregar página e removido se desativado (AC 1.3.17)
- Clique em "Finalizar Pedido" navega para Story 1.4

**Biblioteca de UI:**
- Usar Radix UI Dialog para modal (já usado em ProductDetailModal)
- Toast já implementado pode ser reutilizado

### File Locations

**Estrutura base do projeto:**
- Classes de entidades: 
  - `src/domain/entities/Coupon.ts`
- Context/Estado:
  - Estender `src/contexts/CartContext.tsx` para gerenciar cupom
- Componentes:
  - `src/components/menu/FloatingCartButton.tsx` (botão flutuante)
  - `src/components/menu/CartModal.tsx` (modal principal)
  - `src/components/menu/CartItemList.tsx` (lista de itens)
  - `src/components/menu/CartItemCard.tsx` (card de item individual)
  - `src/components/menu/CartSummary.tsx` (resumo financeiro)
  - `src/components/menu/CouponField.tsx` (campo de cupom)
  - Estender `src/components/menu/ProductDetailModal.tsx` para aceitar modo de edição
- Tipos:
  - `src/types/cart.ts` (pode estender com tipos de cupom se necessário)

### Testing Requirements

**Testes Unitários:**
- Testar classe `Coupon` (métodos de validação, cálculo de desconto)
- Testar funções do CartContext: `applyCoupon`, `removeCoupon`, `getDiscount`, `getTotal`
- Testar cálculo de desconto percentual vs valor fixo
- Testar validação de cupom inválido/expirado

**Testes de Integração:**
- Testar integração com Supabase para validar cupom
- Testar persistência de cupom aplicado no localStorage
- Testar atualização de resumo financeiro ao aplicar/remover cupom

**Testes E2E:**
- Testar fluxo completo: adicionar itens → abrir carrinho → remover item → editar item → aplicar cupom → finalizar pedido
- Testar exibição de itens do carrinho com opcionais e observações formatados corretamente
- Testar remoção de item do carrinho
- Testar edição de item (abrir modal pré-preenchido e salvar alterações)
- Testar cancelar edição de item (fechar modal sem salvar e verificar que item original permanece inalterado) (AC 1.3.19)
- Testar aplicação de cupom válido com indicador de carregamento (AC 1.3.21)
- Testar aplicação de cupom inválido (mensagem de erro)
- Testar erro ao validar cupom (ex: erro de rede) e verificar mensagem de erro (AC 1.3.18)
- Testar remoção de cupom aplicado
- Testar validação de cupom ao recarregar página (cupom desativado deve ser removido) (AC 1.3.17)
- Testar cálculo correto de subtotal, desconto e total
- Testar botão flutuante com contador de itens e posicionamento responsivo (AC 1.3.20)
- Testar acessibilidade do botão flutuante (teclado, screen readers) (AC 1.3.22)
- Testar modal do carrinho vazio (mensagem apropriada)
- Testar botão "Finalizar Pedido" desabilitado quando carrinho vazio
- Testar responsividade do modal em diferentes tamanhos de tela
- Testar acessibilidade (navegação por teclado, screen readers)
- Testar scroll interno na lista de itens quando há muitos itens

### Technical Constraints

**Obrigatórios conforme [Source: architecture/tech-stack.md] e [Source: architecture/fullstack-architecture.md#5]:**
- **TypeScript:** Obrigatório para todo o código
- **POO:** Todas as entidades de negócio DEVEM ser Classes TypeScript, não funções puras
- **Supabase:** Usar `supabase-js` para acesso aos dados
- **Design Responsivo:** Mobile-first conforme [Source: architecture/frontend-architecture.md]

**Mapeamento Entidade-Classe obrigatório:**
- `coupons` → `class Coupon`

**Métodos Esperados nas Classes POO:**

**Classe Coupon:**
- `static async validate(code: string): Promise<Coupon | null>` - Busca e valida cupom por código (retorna null se inválido/inativo)
- `getDiscountType(): 'percentage' | 'fixed'` - Retorna tipo de desconto
- `getDiscountValue(): number` - Retorna valor do desconto (percentual ou fixo)
- `isActive(): boolean` - Verifica se cupom está ativo
- `calculateDiscount(subtotal: number): number` - Calcula valor do desconto aplicado ao subtotal
- `getDisplayValue(): string` - Retorna valor formatado para exibição (ex: "10%" ou "R$ 5,00")

**Importante:** Classes devem encapsular lógica de negócio, não apenas serem DTOs (Data Transfer Objects). Métodos devem conter comportamento relacionado às entidades.

**Gerenciamento de Estado:**
- Estender CartContext existente para gerenciar cupom aplicado
- Persistir cupom aplicado no localStorage junto com o carrinho
- Cupom aplicado deve ser validado ao recarregar página (verificar se ainda está ativo no Supabase)

**Validações e Regras de Negócio:**

- **Cupom:** Apenas cupons com `status = 'Ativo'` podem ser aplicados
- **Desconto percentual:** Máximo 100% (não pode deixar total negativo)
- **Desconto fixo:** Não pode ser maior que o subtotal (não pode deixar total negativo)
- **Total:** Nunca deve ser zero ou negativo após aplicar desconto. Se desconto deixar total em zero ou negativo, ajustar desconto automaticamente para máximo possível sem deixar total negativo
- **Cupom aplicado:** Apenas um cupom pode estar aplicado por vez
- **Cupom ao recarregar:** Validar se cupom aplicado ainda está ativo ao recarregar página (AC 1.3.17)
- **Erro ao validar cupom:** Não aplicar cupom se houver erro ao validar (ex: erro de rede), exibir mensagem de erro (AC 1.3.18)
- **Cancelar edição:** Preservar item original se modal de edição for fechado sem salvar (AC 1.3.19)
- **Lista de itens:** Implementar scroll interno na lista se houver muitos itens (>5-7 itens visíveis dependendo do tamanho da tela)

### Project Structure Notes

A estrutura de arquivos do projeto já está parcialmente estabelecida nas Stories anteriores. Seguir padrões existentes:
- Classes de entidades em `src/domain/entities/`
- Componentes em `src/components/menu/`
- Context providers em `src/contexts/`
- Hooks customizados em `src/hooks/`
- Tipos em `src/types/`

### Testing

Dev Note: Story Requires the following tests:

- [ ] Jest Unit Tests: (nextToFile: true), coverage requirement: 80%
- [ ] Jest Integration Tests: location: `src/__tests__/integration/cart-modal.test.ts`
- [ ] **NOTA:** E2E tests devem ser manuais conforme padrão do projeto

Manual Test Steps:
- Verificar botão flutuante do carrinho está visível na página e posicionado corretamente (AC 1.3.20)
- Verificar acessibilidade do botão flutuante (Tab para focar, Enter para ativar, label para screen readers) (AC 1.3.22)
- Verificar badge com contador de itens no botão flutuante (oculto se vazio)
- Clicar no botão flutuante e verificar que modal do carrinho abre
- Verificar lista de itens do carrinho mostra todas as informações corretamente (nome, quantidade, opcionais formatados, observações, preço)
- Verificar formato de exibição de opcionais (ex: "Bacon +R$2,00" ou "Grátis" se zero) (AC 1.3.2)
- Testar remoção de item do carrinho e verificar confirmação visual
- Testar edição de item: clicar em "Editar", verificar modal pré-preenchido, alterar configurações, salvar e verificar atualização no carrinho
- Testar cancelar edição: clicar em "Editar", alterar configurações, fechar modal sem salvar e verificar que item original permanece inalterado (AC 1.3.19)
- Verificar exibição de subtotal correto
- Testar aplicação de cupom válido e verificar:
  - Indicador de carregamento durante validação (AC 1.3.21)
  - Confirmação visual após aplicar
  - Desconto exibido no resumo
  - Total recalculado corretamente
- Testar aplicação de cupom inválido e verificar mensagem de erro
- Testar erro ao validar cupom (simular erro de rede) e verificar mensagem de erro apropriada (AC 1.3.18)
- Testar remoção de cupom aplicado e verificar que desconto é removido
- Testar validação de cupom ao recarregar página:
  - Aplicar cupom válido
  - Recarregar página
  - Verificar que cupom ainda aplicado se ainda ativo
  - Desativar cupom no admin (se Story 2.5 disponível)
  - Recarregar página novamente
  - Verificar que cupom foi removido e mensagem informativa exibida (AC 1.3.17)
- Verificar mensagem quando carrinho está vazio
- Verificar botão "Finalizar Pedido" desabilitado quando carrinho vazio
- Clicar em "Finalizar Pedido" e verificar navegação para Story 1.4
- Testar fechamento do modal (X, ESC, clicar fora)
- Testar persistência do cupom aplicado após recarregar página
- Testar scroll interno na lista de itens quando há muitos itens (>5-7 itens)
- Testar em diferentes tamanhos de tela (mobile, tablet, desktop)
- Testar acessibilidade (navegação por teclado, screen readers)

## Dev Agent Record

### Agent Model Used: {{Agent Model Name/Version}}

### Debug Log References

[[LLM: (Dev Agent) If the debug is logged to during the current story progress, create a table with the debug log and the specific task section in the debug log - do not repeat all the details in the story]]

### Completion Notes List

- Tabela `coupons` criada no Supabase via MCP
- Classe POO `Coupon` implementada com todos os métodos especificados
- CartContext estendido com funcionalidades de cupom (`appliedCoupon`, `applyCoupon`, `removeCoupon`, `getDiscount`, `getTotal`)
- Validação de cupom ao recarregar página implementada com notificação quando cupom removido (AC 1.3.17)
- Componentes criados: `FloatingCartButton`, `CartModal`, `CartItemList`, `CartItemCard`, `CartSummary`, `CouponField`
- `ProductDetailModal` estendido para modo de edição com preservação de item original ao cancelar (AC 1.3.19)
- Componentes integrados na página (`MenuPageClient.tsx`)
- Seed de cupons aplicado (DESCONTO10, R$5OFF, EXPIRADO)
- Todas as tasks concluídas - implementação completa

### Change Log

[[LLM: (Dev Agent) Track document versions and changes during development that deviate from story dev start]]

| Date | Version | Description | Author |
| :--- | :------ | :---------- | :----- |
| 2024 | 1.1 | Story criada inicialmente | SM |
| 2024 | 1.2 | Correções aplicadas após PO Review: ACs 1.3.17-1.3.22 adicionados, AC 1.3.2 e 1.3.4 melhorados, validações expandidas, acessibilidade adicionada | PO/SM |
| 2024 | 1.3 | Implementação concluída: Todas as tasks completadas, componentes criados e integrados, notificação de cupom removido adicionada | Dev |

