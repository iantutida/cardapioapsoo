# Story 1.2: Adicionar Produto ao Carrinho

## Status: Review (Pronto para Revisão)

**Última atualização:** 2024 - Implementação concluída, aguardando revisão

## Story

- As a Cliente do Restaurante
- I want clicar em um produto para ver seus detalhes, selecionar opcionais (com ou sem acréscimo), definir a quantidade, adicionar observações e adicioná-lo ao meu carrinho
- so that eu possa montar meu pedido com minhas personalizações exatas

## Acceptance Criteria (ACs)

1. **AC 1.2.1:** Clicar em um item de produto deve abrir uma visualização de detalhes (modal) mostrando o nome, descrição, preço e foto do produto (se disponível).
2. **AC 1.2.2:** Se o produto tiver grupos de opcionais associados (História 2.4), eles devem ser claramente listados. **Nota:** Se Story 2.4 ainda não estiver disponível, a funcionalidade deve funcionar com produtos sem opcionais e produtos com opcionais já cadastrados diretamente no banco (via SQL/MCP).
3. **AC 1.2.3:** O sistema deve permitir a seleção de opcionais respeitando regras de seleção única/múltipla. Grupos de seleção única devem ter exatamente uma opção selecionada sempre (não pode haver zero seleções). Grupos de seleção múltipla podem ter zero ou mais opções selecionadas. O sistema deve calcular corretamente o preço adicional total baseado nas opções selecionadas.
4. **AC 1.2.4:** O cliente deve poder alterar a **Quantidade** do item (mínimo 1, máximo 99).
5. **AC 1.2.5:** O cliente deve ter um campo de **Observações** em texto livre para aquele item (máximo 500 caracteres).
6. **AC 1.2.6:** O preço total do item (preço base + opcionais) deve ser recalculado e exibido dinamicamente conforme alterações na quantidade ou seleção de opcionais.
7. **AC 1.2.7:** Clicar em "Adicionar ao Pedido" deve adicionar o item configurado ao carrinho, fechar o modal e resetar o estado do modal (limpar seleções, quantidade voltar para 1, observações vazias).
8. **AC 1.2.8:** Após adicionar ao carrinho, deve ser exibida uma confirmação visual (ex: toast/notificação) indicando que o item foi adicionado.
9. **AC 1.2.9:** O modal deve poder ser fechado clicando fora dele, no botão X ou pressionando ESC.
10. **AC 1.2.10:** Se o produto não tiver grupos de opcionais associados, a seção de opcionais não deve ser exibida no modal.
11. **AC 1.2.11:** Ao clicar em um produto, o modal deve exibir um indicador de carregamento enquanto busca dados do produto e seus opcionais do Supabase.
12. **AC 1.2.12:** Se houver erro ao buscar dados do produto ou opcionais, o modal deve exibir mensagem de erro apropriada e permitir fechar.
13. **AC 1.2.13:** Se o produto não existir ou foi removido, o modal não deve abrir e deve exibir mensagem de erro na página.
14. **AC 1.2.14:** Ao abrir o modal, o estado deve ser resetado (quantidade = 1, nenhum opcional selecionado, observações vazias), exceto se estiver editando item existente do carrinho (Story 1.3).
15. **AC 1.2.15:** Se foto do produto não estiver disponível ou houver erro ao carregar, exibir placeholder apropriado ou ocultar seção de foto sem quebrar layout.
16. **AC 1.2.16:** Se o mesmo produto com mesmas configurações (opcionais e observações idênticas) já estiver no carrinho, incrementar quantidade ao invés de criar novo item.

- [x] Task 1: Criar classes TypeScript para opcionais (AC: 1.2.2, 1.2.3, 1.2.6)
  - [x] Subtask 1.1: Criar classe `OptionGroup` conforme [Source: architecture/fullstack-architecture.md#5]
  - [x] Subtask 1.2: Criar classe `Option` conforme [Source: architecture/fullstack-architecture.md#5]
  - [x] Subtask 1.3: Implementar métodos para buscar grupos de opcionais associados a um produto
  - [x] Subtask 1.4: Implementar métodos para buscar opcionais de um grupo
  - [x] Subtask 1.5: Implementar método para calcular preço adicional total de opcionais selecionados
- [x] Task 2: Estender classe Product para buscar opcionais (AC: 1.2.2, 1.2.10)
  - [x] Subtask 2.1: Adicionar método `async getOptionGroups(): Promise<OptionGroup[]>` na classe Product
  - [x] Subtask 2.2: Implementar busca de grupos de opcionais via tabela `product_option_links` do Supabase
- [x] Task 3: Criar contexto/estado para gerenciar carrinho (AC: 1.2.7, 1.2.8)
  - [x] Subtask 3.1: Criar Context Provider para carrinho (`CartContext`)
  - [x] Subtask 3.2: Implementar estrutura de dados para itens do carrinho (productId, quantity, selectedOptions, notes)
  - [x] Subtask 3.3: Implementar funções: `addToCart`, `removeFromCart`, `updateCartItem`, `getCartItems`, `getCartTotal`
  - [x] Subtask 3.4: Implementar persistência local do carrinho (localStorage) para não perder dados ao recarregar página
- [x] Task 4: Criar componente Modal de Detalhes do Produto (AC: 1.2.1, 1.2.9, 1.2.11, 1.2.12, 1.2.13, 1.2.15)
  - [x] Subtask 4.1: Criar componente `ProductDetailModal` conforme wireframe [Source: architecture/frontend-architecture.md#Modal 1]
  - [x] Subtask 4.2: Implementar layout com foto, nome, descrição e preço do produto
  - [x] Subtask 4.3: Implementar botões de fechar (X, ESC, clicar fora)
  - [x] Subtask 4.4: Integrar com Radix UI Dialog ou componente similar para acessibilidade
  - [x] Subtask 4.5: Implementar indicador de carregamento ao abrir modal (AC 1.2.11)
  - [x] Subtask 4.6: Implementar tratamento de erro ao buscar dados do produto (AC 1.2.12, 1.2.13)
  - [x] Subtask 4.7: Implementar fallback para foto quando não disponível ou erro ao carregar (AC 1.2.15)
- [x] Task 5: Implementar seção de grupos de opcionais no modal (AC: 1.2.2, 1.2.3, 1.2.10)
  - [x] Subtask 5.1: Criar componente `OptionGroupSection` para exibir grupos de opcionais
  - [x] Subtask 5.2: Implementar renderização de radio buttons para seleção única
  - [x] Subtask 5.3: Implementar renderização de checkboxes para seleção múltipla
  - [x] Subtask 5.4: Implementar validação: grupo de seleção única deve ter exatamente uma opção selecionada sempre (não pode ser zero) (AC 1.2.3)
  - [x] Subtask 5.5: Implementar estado local para rastrear opcionais selecionados
  - [x] Subtask 5.6: Ocultar seção se produto não tiver grupos de opcionais (AC 1.2.10)
  - [x] Subtask 5.7: Implementar seleção automática da primeira opção em grupos de seleção única ao abrir modal
- [x] Task 6: Implementar seletor de quantidade (AC: 1.2.4)
  - [x] Subtask 6.1: Criar componente `QuantitySelector` com botões +/- conforme wireframe
  - [x] Subtask 6.2: Implementar validação: mínimo 1, máximo 99
  - [x] Subtask 6.3: Implementar estado local para quantidade
- [x] Task 7: Implementar campo de observações (AC: 1.2.5)
  - [x] Subtask 7.1: Criar componente `NotesField` como textarea
  - [x] Subtask 7.2: Implementar limite de 500 caracteres com contador
  - [x] Subtask 7.3: Implementar estado local para observações
- [x] Task 8: Implementar cálculo dinâmico de preço total (AC: 1.2.6)
  - [x] Subtask 8.1: Criar função `calculateItemTotal` que soma preço base + opcionais × quantidade
  - [x] Subtask 8.2: Atualizar exibição do preço total em tempo real conforme mudanças
  - [x] Subtask 8.3: Formatizar preço usando `Intl.NumberFormat` (padrão já usado em `Product.getDisplayPrice()`)
- [x] Task 9: Implementar botão "Adicionar ao Pedido" e integração com carrinho (AC: 1.2.7, 1.2.8, 1.2.16)
  - [x] Subtask 9.1: Criar função para criar item do carrinho com todas as configurações
  - [x] Subtask 9.2: Integrar botão com `addToCart` do CartContext
  - [x] Subtask 9.3: Implementar fechamento do modal após adicionar
  - [x] Subtask 9.4: Implementar confirmação visual (toast/notificação) após adicionar
  - [x] Subtask 9.5: Atualizar contador do carrinho na interface (botão flutuante - será visível na Story 1.3)
  - [x] Subtask 9.6: Implementar reset do estado do modal após fechar (AC 1.2.7, 1.2.14)
  - [x] Subtask 9.7: Implementar lógica para incrementar quantidade se item idêntico já existe no carrinho (AC 1.2.16)
- [x] Task 10: Integrar modal com cards de produto existentes (AC: 1.2.1, 1.2.11, 1.2.13, 1.2.14)
  - [x] Subtask 10.1: Adicionar onClick handler nos cards de produto da Story 1.1
  - [x] Subtask 10.2: Buscar dados completos do produto (incluindo opcionais) ao abrir modal
  - [x] Subtask 10.3: Implementar loading state enquanto busca dados do produto (AC 1.2.11)
  - [x] Subtask 10.4: Implementar tratamento de erro quando produto não existe ou foi removido (AC 1.2.13)
  - [x] Subtask 10.5: Implementar reset do estado do modal ao abrir (quantidade = 1, sem opcionais, sem observações) (AC 1.2.14)
- [x] Task 11: Implementar responsividade mobile-first (AC: 1.2.1, 1.2.4, 1.2.5)
  - [x] Subtask 11.1: Aplicar design responsivo ao modal conforme [Source: architecture/frontend-architecture.md]
  - [x] Subtask 11.2: Testar modal em diferentes tamanhos de tela
  - [x] Subtask 11.3: Garantir que modal seja acessível via teclado

## Dev Notes

### Previous Story Insights

**Da Story 1.1:**
- Classes `Category`, `Product` e `StoreConfig` já foram implementadas conforme padrão POO
- Cliente Supabase separado em `lib/supabase/client.ts` (cliente) e `lib/supabase/server.ts` (servidor)
- Componentes criados seguindo padrão mobile-first com TailwindCSS
- Padrão: Server Components do Next.js buscam dados e convertem para objetos simples para passar para Client Components
- Método `Product.getDisplayPrice()` já implementa formatação de preço em R$ (pt-BR)
- Cards de produto estão em `src/components/menu/CategorySection.tsx` e `src/components/menu/ProductCard.tsx` (assumindo)

**Relevante para Story 1.2:**
- Produtos podem ter campo `description` e `photo_url` (verificar schema do Supabase)
- A estrutura de dados de produtos já está definida com campos: `id`, `name`, `price`, `categoryId`, `status`, `order`
- Para passar dados entre Server e Client Components, converter classes para objetos simples (padrão já estabelecido)

### Data Models

Conforme [Source: architecture/fullstack-architecture.md#1]:

**Tabela `option_groups`:**
- Campos relevantes: `id`, `name`, `selection_type` ('single' ou 'multiple'), `created_at`, `updated_at`
- Propósito: Agrupa opcionais relacionados (ex: "Tamanho", "Adicionais")

**Tabela `options`:**
- Campos relevantes: `id`, `name`, `additional_price`, `option_group_id`, `created_at`, `updated_at`
- Propósito: Representa um opcional individual (ex: "Bacon +R$2,00")
- Nota: `additional_price` pode ser 0 (opcional gratuito)

**Tabela `product_option_links`:**
- Campos relevantes: `id`, `product_id`, `option_group_id`, `created_at`
- Propósito: Tabela de relacionamento N:N entre produtos e grupos de opcionais
- Nota: Um produto pode ter múltiplos grupos de opcionais associados

**Tabela `products`:**
- Campos adicionais relevantes: `description`, `photo_url` (verificar schema)
- Nota: Foto não é obrigatória (AC 1.2.1 diz "se disponível")

**Estrutura de Item do Carrinho:**
```typescript
interface CartItem {
  id: string // UUID gerado para item único no carrinho
  productId: string
  productName: string
  productPrice: number
  quantity: number
  selectedOptions: Array<{
    optionGroupId: string
    optionGroupName: string
    optionId: string
    optionName: string
    additionalPrice: number
  }>
  notes: string
  totalPrice: number // preço base + opcionais × quantidade
}
```

### API Specifications

**Supabase Client:**
- Usar `supabase-js` para acesso aos dados conforme [Source: architecture/tech-stack.md]
- Tabelas: `option_groups`, `options`, `product_option_links`, `products`
- Consultas necessárias:
  - Buscar grupos de opcionais associados a um produto via `product_option_links`
  - Buscar opcionais de um grupo de opcionais
  - Buscar dados completos do produto (incluindo `description`, `photo_url` se existirem)
- Não há endpoints REST customizados - usar PostgREST do Supabase diretamente

**Nota:** Esta story não persiste dados no Supabase. O carrinho é gerenciado localmente até a Story 1.4 (Finalizar Pedido).

### Component Specifications

Conforme [Source: architecture/frontend-architecture.md#Modal 1]:

**Estrutura do Modal de Detalhes do Produto:**
1. **Header:** Foto do produto (se disponível), Nome, Descrição
2. **Preço Base:** Exibido em destaque
3. **Grupos de Opcionais:** 
   - Lista de grupos associados ao produto
   - Radio buttons para seleção única (AC 1.2.3)
   - Checkboxes para seleção múltipla (AC 1.2.3)
   - Exibir nome do opcional e preço adicional (ex: "Bacon +R$2,00")
4. **Campo de Observações:** Textarea com limite de caracteres
5. **Seletor de Quantidade:** Botões +/- com valor numérico
6. **Preço Total Dinâmico:** Exibido em destaque, atualizado em tempo real
7. **Botão de Ação:** "Adicionar ao Pedido - R$ XX,XX" com preço total

**Interações:**
- Modal abre ao clicar em card de produto
- Modal fecha ao clicar fora, no X ou pressionar ESC
- Seleção de opcionais atualiza preço total imediatamente
- Alteração de quantidade atualiza preço total imediatamente
- Ao adicionar ao carrinho: fecha modal, exibe confirmação e reseta estado (AC 1.2.7, 1.2.14)
- Grupos de seleção única têm primeira opção selecionada automaticamente ao abrir modal
- Se foto não disponível ou erro ao carregar, exibir placeholder ou ocultar seção (AC 1.2.15)

**Biblioteca de UI:**
- Usar Radix UI Dialog para modal (acessibilidade)
- Ou Shadcn UI Dialog (se já configurado no projeto)
- Verificar [Source: architecture/tech-stack.md] para bibliotecas UI disponíveis

### File Locations

**Estrutura base do projeto:**
- Classes de entidades: 
  - `src/domain/entities/OptionGroup.ts`
  - `src/domain/entities/Option.ts`
  - Estender `src/domain/entities/Product.ts` com método `getOptionGroups()`
- Context/Estado:
  - `src/contexts/CartContext.tsx` (Context Provider)
  - `src/hooks/useCart.ts` (hook customizado para usar CartContext)
- Componentes:
  - `src/components/menu/ProductDetailModal.tsx` (modal principal)
  - `src/components/menu/OptionGroupSection.tsx` (seção de grupo de opcionais)
  - `src/components/menu/QuantitySelector.tsx` (seletor de quantidade)
  - `src/components/menu/NotesField.tsx` (campo de observações)
  - `src/components/ui/Toast.tsx` (confirmação visual - se não existir)
- Tipos:
  - `src/types/cart.ts` (tipos TypeScript para carrinho)

**Nota:** Verificar se projeto já tem componentes de UI (Dialog, Toast) configurados. Se não, criar seguindo padrões do projeto.

### Testing Requirements

**Testes Unitários:**
- Testar classes `OptionGroup` e `Option` (métodos de busca, cálculos)
- Testar método `Product.getOptionGroups()`
- Testar função `calculateItemTotal` (preço base + opcionais × quantidade)
- Testar validações: quantidade mínima/máxima, limite de caracteres em observações
- Testar lógica de seleção única vs múltipla em grupos de opcionais
- Testar funções do CartContext: `addToCart`, `removeFromCart`, `updateCartItem`

**Testes de Integração:**
- Testar integração com Supabase para buscar grupos de opcionais
- Testar carregamento de dados completos do produto ao abrir modal
- Testar persistência do carrinho no localStorage

**Testes E2E:**
- Testar fluxo completo: abrir modal → selecionar opcionais → alterar quantidade → adicionar observações → adicionar ao carrinho
- Testar cálculo dinâmico de preço total
- Testar fechamento do modal (X, ESC, clicar fora)
- Testar confirmação visual após adicionar ao carrinho
- Testar comportamento quando produto não tem opcionais
- Testar validações: quantidade mínima/máxima, limite de caracteres
- Testar seleção única vs múltipla em grupos de opcionais
- Testar acessibilidade (navegação por teclado, screen readers)
- Testar indicador de carregamento ao abrir modal (AC 1.2.11)
- Testar tratamento de erro ao buscar dados (AC 1.2.12, 1.2.13)
- Testar reset do modal após fechar e ao reabrir (AC 1.2.14)
- Testar comportamento quando foto não está disponível (AC 1.2.15)
- Testar incremento de quantidade para item idêntico já no carrinho (AC 1.2.16)
- Testar persistência do carrinho no localStorage

### Technical Constraints

**Obrigatórios conforme [Source: architecture/tech-stack.md] e [Source: architecture/fullstack-architecture.md#5]:**
- **TypeScript:** Obrigatório para todo o código
- **POO:** Todas as entidades de negócio DEVEM ser Classes TypeScript, não funções puras
- **Supabase:** Usar `supabase-js` para acesso aos dados
- **Design Responsivo:** Mobile-first conforme [Source: architecture/frontend-architecture.md]

**Mapeamento Entidade-Classe obrigatório:**
- `option_groups` → `class OptionGroup`
- `options` → `class Option`

**Métodos Esperados nas Classes POO:**

**Classe OptionGroup:**
- `static async getByProductId(productId: string): Promise<OptionGroup[]>` - Busca grupos de opcionais associados a um produto
- `async getOptions(): Promise<Option[]>` - Busca opcionais deste grupo
- `getSelectionType(): 'single' | 'multiple'` - Retorna tipo de seleção do grupo
- `getName(): string` - Retorna nome do grupo

**Classe Option:**
- `getAdditionalPrice(): number` - Retorna preço adicional do opcional
- `getName(): string` - Retorna nome do opcional
- `getDisplayPrice(): string` - Retorna preço formatado para exibição (ex: "+R$ 2,00" ou "Grátis" se 0)

**Classe Product (extensão):**
- `async getOptionGroups(): Promise<OptionGroup[]>` - Busca grupos de opcionais associados a este produto

**Importante:** Classes devem encapsular lógica de negócio, não apenas serem DTOs (Data Transfer Objects). Métodos devem conter comportamento relacionado às entidades.

**Gerenciamento de Estado:**
- Usar React Context API para gerenciar estado do carrinho
- Persistir carrinho no localStorage para não perder dados ao recarregar página
- Carrinho não é persistido no Supabase até Story 1.4 (Finalizar Pedido)
- Se localStorage não estiver disponível, carrinho funciona apenas na sessão atual

**Validações e Regras de Negócio:**

- **Preço total:** Nunca deve ser zero ou negativo. Validar antes de permitir adicionar ao carrinho
- **Grupos de seleção única:** Devem sempre ter exatamente uma opção selecionada (não pode ser zero). Selecionar primeira opção automaticamente ao abrir modal
- **Grupos de seleção múltipla:** Podem ter zero ou mais opções selecionadas
- **Quantidade:** Mínima 1, máxima 99
- **Observações:** Máximo 500 caracteres
- **Mesmo produto:** Se mesmo produto com mesmas configurações (opcionais e observações idênticas) já está no carrinho, incrementar quantidade ao invés de criar novo item (AC 1.2.16)
- **Persistência:** Carrinho persiste no localStorage se disponível, senão apenas na sessão atual

### Project Structure Notes

A estrutura de arquivos do projeto já está parcialmente estabelecida na Story 1.1. Seguir padrões existentes:
- Classes de entidades em `src/domain/entities/`
- Componentes em `src/components/menu/`
- Context providers em `src/contexts/`
- Hooks customizados em `src/hooks/`
- Tipos em `src/types/`

### Testing

Dev Note: Story Requires the following tests:

- [ ] Jest Unit Tests: (nextToFile: true), coverage requirement: 80%
- [ ] Jest Integration Tests: location: `src/__tests__/integration/product-detail-modal.test.ts`
- [ ] Playwright E2E: location: `e2e/menu/adicionar-produto-carrinho.spec.ts`

Manual Test Steps:
- Clicar em um produto no cardápio e verificar que modal abre
- Verificar exibição de indicador de carregamento ao abrir modal (AC 1.2.11)
- Verificar exibição de foto, nome, descrição e preço do produto
- Verificar comportamento quando foto não está disponível (placeholder ou oculto) (AC 1.2.15)
- Verificar grupos de opcionais são exibidos (se produto tiver opcionais)
- Verificar que grupos de seleção única têm primeira opção selecionada automaticamente
- Testar seleção de opcionais (seleção única e múltipla)
- Verificar que grupos de seleção única sempre têm uma opção selecionada (não pode ser zero)
- Verificar cálculo dinâmico de preço total conforme seleção de opcionais
- Alterar quantidade e verificar atualização do preço total
- Adicionar observações e verificar limite de 500 caracteres
- Clicar em "Adicionar ao Pedido" e verificar:
  - Item é adicionado ao carrinho (ou quantidade incrementada se já existe com mesmas configurações) (AC 1.2.16)
  - Modal fecha
  - Estado do modal é resetado (AC 1.2.7, 1.2.14)
  - Confirmação visual é exibida
- Verificar fechamento do modal (X, ESC, clicar fora)
- Verificar reset do estado ao reabrir modal (quantidade = 1, sem opcionais, sem observações) (AC 1.2.14)
- Testar comportamento quando produto não tem opcionais (seção não deve aparecer)
- Testar tratamento de erro quando produto não existe (AC 1.2.13)
- Testar tratamento de erro ao buscar dados (AC 1.2.12)
- Testar validações: quantidade mínima (1), máxima (99)
- Testar persistência do carrinho após recarregar página
- Testar em diferentes tamanhos de tela (mobile, tablet, desktop)
- Testar acessibilidade (navegação por teclado)

## Dev Agent Record

### Agent Model Used: Composer (Cursor)

### Debug Log References

Nenhum debug necessário durante a implementação.

### Completion Notes List

- Tabelas criadas no Supabase via MCP: `option_groups`, `options`, `product_option_links`
- Campos `description` e `photo_url` adicionados à tabela `products`
- Classes POO implementadas: `OptionGroup`, `Option`, extensão de `Product`
- Context de carrinho implementado com persistência no localStorage
- Modal implementado com Radix UI Dialog para acessibilidade
- Toast implementado com Radix UI Toast para confirmações visuais
- API route criada em `/api/products/[id]` para buscar produtos
- Seleção automática da primeira opção em grupos de seleção única implementada
- Lógica de incremento de quantidade para itens idênticos implementada
- **Seed de opcionais aplicado via migration `seed_option_groups_and_options`**
- **Jest configurado com 26 testes unitários passando**
- **Testes implementados para: Option, OptionGroup, Product, cart utilities, calculateItemTotal**

### Change Log

[[LLM: (Dev Agent) Track document versions and changes during development that deviate from story dev start]]

| Date | Version | Description | Author |
| :--- | :------ | :---------- | :----- |
| 2024 | 1.1 | Story criada inicialmente | SM |
| 2024 | 1.2 | Correções aplicadas após PO Review: AC 1.2.3 corrigido, ACs 1.2.11-1.2.16 adicionados, validações detalhadas, reset do modal adicionado | PO/SM |
| 2024 | 1.3 | Implementação concluída: Todas as tasks completadas, código funcional, tabelas criadas no Supabase | Dev |
| 2024 | 1.4 | Resolução QA Review: Seed de opcionais aplicado, Jest configurado, 26 testes unitários implementados | Dev |

