# Integração Story 2.3 + 2.4: Gestão de Opcionais em Produtos

## Status: ✅ Completo

**Data:** 2024-11-08

## Resumo

Implementada a funcionalidade de vincular grupos de opcionais aos produtos, permitindo que o administrador defina quais opcionais estarão disponíveis para cada produto do cardápio.

## Problema Resolvido

### Erro "Could not parse content as FormData"

**Causa:** A API `/api/admin/products` esperava `FormData` (para upload de fotos), mas o modal `ProductModal` foi simplificado para enviar JSON (após remoção do upload de fotos).

**Solução:** Atualizadas as rotas `POST` e `PATCH` em `/api/admin/products/route.ts` para aceitar JSON em vez de FormData.

### Feature Faltante: Gestão de Opcionais por Produto

**Requisito:** Permitir que o administrador selecione quais grupos de opcionais estão disponíveis para cada produto (Story 2.4).

**Solução:** Implementada interface de seleção de grupos de opcionais no modal de edição de produtos.

## Mudanças Implementadas

### 1. API de Produtos (`app/api/admin/products/route.ts`)

**POST (Criar Produto):**
- ❌ Antes: `await request.formData()`
- ✅ Agora: `await request.json()`
- Removido suporte a upload de foto
- Aceita JSON simples

**PATCH (Atualizar Produto):**
- ❌ Antes: `await request.formData()`
- ✅ Agora: `await request.json()`
- Removido suporte a upload de foto
- Aceita JSON simples

### 2. Modal de Produto (`src/components/admin/ProductModal.tsx`)

**Novas Props:**
```typescript
interface ProductModalProps {
  // ... props existentes
  optionGroups: OptionGroupData[]  // NOVO
}
```

**Novo Estado:**
```typescript
const [selectedOptionGroups, setSelectedOptionGroups] = useState<string[]>([])
const [loadingOptionGroups, setLoadingOptionGroups] = useState(false)
```

**Novas Funções:**
- `loadProductOptionGroups(productId)`: Carrega grupos vinculados ao produto
- `toggleOptionGroup(groupId)`: Adiciona/remove grupo da seleção

**Nova UI (apenas em modo edição):**
- Seção "Grupos de Opcionais" com checkboxes
- Lista scrollável com todos os grupos disponíveis
- Indicador de tipo de seleção (Única/Múltipla)
- Estado de loading
- Mensagem quando não há grupos

**Fluxo de Salvamento:**
1. Salva dados básicos do produto via `POST/PATCH /api/admin/products`
2. Se for edição, salva grupos de opcionais via `PUT /api/admin/products/{id}/option-groups`
3. Exibe toast de sucesso/erro

### 3. Página de Produtos (`app/admin/(protected)/products/page.tsx`)

**Novo Estado:**
```typescript
const [optionGroups, setOptionGroups] = useState<OptionGroupData[]>([])
```

**Carregamento de Dados:**
```typescript
const [categoriesRes, productsRes, optionGroupsRes] = await Promise.all([
  fetch('/api/admin/categories'),
  fetch('/api/admin/products'),
  fetch('/api/admin/option-groups'),  // NOVO
])
```

**Props Passadas:**
```typescript
<ProductModal
  // ... props existentes
  optionGroups={optionGroups}  // NOVO
/>
```

## Como Usar

### 1. Criar Grupos de Opcionais

Antes de vincular opcionais a produtos, crie os grupos:

1. Acesse `/admin/options`
2. Clique em "Novo Grupo"
3. Crie grupos como: "Tamanho", "Adicionais", "Bebidas", etc.
4. Adicione opções a cada grupo

### 2. Vincular Opcionais a um Produto

1. Acesse `/admin/products`
2. Clique em **"Editar"** em um produto existente
3. Role até a seção **"Grupos de Opcionais"**
4. Marque os grupos que deseja vincular ao produto
5. Clique em **"Atualizar"**

**Exemplo:**

```
Produto: Hambúrguer Especial
Grupos Vinculados:
  ✅ Tamanho (Única)
  ✅ Adicionais (Múltipla)
  ✅ Bebidas (Única)
```

### 3. Resultado no Cardápio Público

Quando o cliente clicar no produto em `/menu`:
- Verá apenas os grupos de opcionais vinculados
- Poderá selecionar opções conforme o tipo (única/múltipla)
- O preço será calculado automaticamente

## Validações

### Modal de Produto
- ✅ Campos obrigatórios: nome, preço, categoria
- ✅ Preço deve ser maior que zero
- ✅ Nome: 3-120 caracteres
- ✅ Grupos de opcionais: opcional, apenas em edição

### API
- ✅ Autenticação admin obrigatória
- ✅ Validação de payload JSON
- ✅ Timeout de 30 segundos
- ✅ Revalidação de cache (`/menu`)

## Limitações Conhecidas

### 1. Opcionais Apenas em Edição

**Comportamento Atual:**
- Novos produtos não podem ter opcionais vinculados na criação
- É necessário criar o produto primeiro, depois editá-lo para adicionar opcionais

**Justificativa:**
- Simplifica o fluxo de criação
- Evita complexidade desnecessária no modal
- Padrão comum em sistemas de gestão

**Workaround:**
1. Crie o produto
2. Clique em "Editar"
3. Vincule os opcionais

### 2. Sem Reordenação de Opcionais

**Comportamento Atual:**
- Opcionais aparecem na ordem em que foram criados
- Não há drag-and-drop para reordenar

**Solução Futura:**
- Adicionar campo `order` na tabela `options`
- Implementar API `/api/admin/options/reorder`
- Adicionar UI de drag-and-drop (opcional)

## Testes Manuais

### Cenário 1: Editar Produto e Adicionar Opcionais

```
1. Login como admin
2. Acesse /admin/products
3. Clique em "Editar" em qualquer produto
4. Role até "Grupos de Opcionais"
5. Marque 2-3 grupos
6. Clique em "Atualizar"
7. ✅ Deve exibir toast "Produto atualizado com sucesso"
8. Acesse /menu
9. Clique no produto
10. ✅ Deve exibir os grupos de opcionais selecionados
```

### Cenário 2: Remover Opcionais de um Produto

```
1. Edite um produto que já tem opcionais
2. Desmarque todos os grupos
3. Clique em "Atualizar"
4. ✅ Deve salvar sem erros
5. Acesse /menu
6. Clique no produto
7. ✅ Não deve exibir nenhum opcional
```

### Cenário 3: Produto Sem Grupos Disponíveis

```
1. Certifique-se de que não há grupos criados
2. Edite um produto
3. ✅ Deve exibir: "Nenhum grupo de opcionais disponível. Crie grupos em 'Opcionais' primeiro."
```

## Arquivos Modificados

```
app/api/admin/products/route.ts          (API: FormData → JSON)
src/components/admin/ProductModal.tsx    (UI: Gestão de opcionais)
app/admin/(protected)/products/page.tsx  (Carregamento de option groups)
```

## Arquivos Criados

```
docs/stories/2.3-2.4-integration.md      (Esta documentação)
```

## Próximos Passos (Opcional)

1. **Vincular Opcionais na Criação**
   - Permitir selecionar grupos ao criar novo produto
   - Salvar associações após criação bem-sucedida

2. **Reordenação de Opcionais**
   - Adicionar campo `order` na tabela `options`
   - Implementar drag-and-drop

3. **Testes E2E**
   - Playwright: criar produto → editar → vincular opcionais → verificar em /menu

4. **Validação de Opcionais Órfãos**
   - Detectar produtos com opcionais de grupos excluídos
   - Limpar associações inválidas automaticamente

## Conclusão

✅ **Erro "Could not parse content as FormData" resolvido**  
✅ **Gestão de opcionais por produto implementada**  
✅ **Build passando sem erros**  
✅ **Funcionalidade testável via UI**

O sistema agora permite vincular grupos de opcionais a produtos de forma simples e intuitiva, completando a integração entre as Stories 2.3 e 2.4.

