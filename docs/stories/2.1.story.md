# Story 2.1: Autenticação do Administrador

## Status: Review

**Última atualização:** 2024 - Implementação concluída

## Story

- As a Gerente de Restaurante
- I want fazer login em um painel de administração protegido por senha
- so that apenas pessoas autorizadas possam alterar o cardápio e ver os pedidos

## Acceptance Criteria (ACs)

1. **AC 2.1.1:** Deve haver uma página de login em `/admin/login` com campos de "Email" e "Senha" e botão "Entrar".
2. **AC 2.1.2:** Tentativas de acesso a outras páginas de administração (ex: `/admin`, `/admin/dashboard`, `/admin/products`) sem estar logado devem redirecionar automaticamente para `/admin/login`. **Nota:** A proteção de rotas deve ser complementada por RLS (Row Level Security) no Supabase para segurança de dados (ver AC 2.1.15).
3. **AC 2.1.3:** O login deve usar o sistema de autenticação do Supabase Auth (e-mail/senha).
4. **AC 2.1.4:** Após o login bem-sucedido, o gerente deve ser redirecionado para o dashboard (`/admin/dashboard`).
5. **AC 2.1.5:** Deve haver uma função de "Logout" disponível no layout do painel de administração (cabeçalho superior conforme wireframe).
6. **AC 2.1.6:** Se credenciais inválidas forem inseridas, a página deve exibir mensagem de erro apropriada (ex: "Email ou senha incorretos").
7. **AC 2.1.7:** A página de login deve exibir um indicador de carregamento durante o processo de autenticação.
8. **AC 2.1.8:** Se houver erro ao autenticar (ex: erro de rede, Supabase temporariamente indisponível), a página deve exibir mensagem de erro apropriada e permitir tentar novamente.
9. **AC 2.1.9:** Os campos de email e senha devem ter validação: email deve ser um formato de email padrão (ex: `nome@dominio.com`), senha deve ter no mínimo 6 caracteres.
10. **AC 2.1.10:** O botão "Entrar" deve estar desabilitado se os campos estiverem vazios ou inválidos.
11. **AC 2.1.11:** Se o usuário já estiver logado e acessar `/admin/login`, deve ser redirecionado automaticamente para `/admin/dashboard`.
12. **AC 2.1.12:** A página de login deve ser responsiva e funcionar bem em diferentes tamanhos de tela (mobile, tablet, desktop).
13. **AC 2.1.13:** A página de login deve ser acessível via teclado (Tab para navegar, Enter para submeter formulário) e ter labels apropriados para screen readers.
14. **AC 2.1.14:** O layout do painel de administração (usado em todas as páginas admin) deve ter barra de navegação lateral (Sidebar) e cabeçalho superior com botão "Logout", conforme wireframe [Source: architecture/frontend-architecture.md#App 2].
15. **AC 2.1.15:** O sistema DEVE implementar políticas de RLS (Row Level Security) no Supabase para garantir que apenas usuários com `role = 'admin'` possam acessar dados sensíveis e realizar operações administrativas.
16. **AC 2.1.16:** Se houver timeout ao autenticar no Supabase (ex: rede lenta), o sistema deve exibir mensagem de erro apropriada (ex: "Tempo de espera esgotado. Tente novamente.") após período razoável (ex: 30 segundos) e permitir tentar novamente.
17. **AC 2.1.17:** Se o usuário tentar acessar uma página de administração protegida sem estar logado, for redirecionado para o login, e após o login bem-sucedido, DEVE ser redirecionado para a página que tentou acessar originalmente.
18. **AC 2.1.18:** O sistema DEVE prever um mecanismo seguro para a criação inicial de usuários administradores, seja via console do Supabase ou uma interface administrativa dedicada (a ser implementada em Story futura).
19. **AC 2.1.19:** Após o logout, deve ser exibida uma confirmação visual (ex: toast "Você foi desconectado com sucesso!") antes do redirecionamento para a página de login.
20. **AC 2.1.20:** A validação dos campos de email e senha deve ocorrer em tempo real (ao sair do campo ou após usuário digitar alguns caracteres) e também ao tentar submeter o formulário.
21. **AC 2.1.21:** Após o login bem-sucedido, deve ser exibida uma mensagem de confirmação (ex: toast "Bem-vindo, [Nome do Usuário]!") antes ou durante o redirecionamento para o dashboard.

## Tasks / Subtasks

- [x] Task 1: Configurar Supabase Auth para autenticação (AC: 2.1.3, 2.1.15, 2.1.18)
  - [x] Subtask 1.1: Verificar configuração do Supabase Auth no projeto
  - [x] Subtask 1.2: Implementar políticas de RLS para acesso a dados admin (AC 2.1.15)
  - [x] Subtask 1.3: Criar usuário admin inicial no Supabase (via MCP ou SQL) para testes
  - [x] Subtask 1.4: Documentar processo de criação de usuários administradores em produção (AC 2.1.18)
- [x] Task 2: Criar página de Login (AC: 2.1.1, 2.1.9, 2.1.10, 2.1.12, 2.1.13, 2.1.20)
  - [x] Subtask 2.1: Criar rota `app/admin/login/page.tsx` conforme Next.js App Router
  - [x] Subtask 2.2: Implementar layout conforme wireframe [Source: architecture/frontend-architecture.md#Página 1 (Login)]
  - [x] Subtask 2.3: Criar componente `LoginForm` com campos Email e Senha
  - [x] Subtask 2.4: Implementar validação de email (formato válido)
  - [x] Subtask 2.5: Implementar validação de senha (mínimo 6 caracteres)
  - [x] Subtask 2.6: Desabilitar botão "Entrar" se validação falhar (AC 2.1.10)
  - [x] Subtask 2.7: Aplicar design responsivo mobile-first
  - [x] Subtask 2.8: Implementar acessibilidade (teclado, screen readers) (AC 2.1.13)
  - [x] Subtask 2.9: Implementar validação em tempo real dos campos (ao sair do campo ou após digitar) (AC 2.1.20)
- [x] Task 3: Implementar autenticação com Supabase Auth (AC: 2.1.3, 2.1.4, 2.1.6, 2.1.7, 2.1.8, 2.1.16, 2.1.21)
  - [x] Subtask 3.1: Implementar função de login usando `supabase.auth.signInWithPassword(email, password)`
  - [x] Subtask 3.2: Implementar indicador de carregamento durante autenticação (AC 2.1.7)
  - [x] Subtask 3.3: Implementar tratamento de erro para credenciais inválidas (AC 2.1.6)
  - [x] Subtask 3.4: Implementar tratamento de erro genérico (rede, timeout, etc.) (AC 2.1.8)
  - [x] Subtask 3.5: Implementar redirecionamento para `/admin/dashboard` após login bem-sucedido (AC 2.1.4)
  - [x] Subtask 3.6: Implementar timeout ao autenticar (30 segundos) e exibir mensagem de erro se timeout ocorrer (AC 2.1.16)
  - [x] Subtask 3.7: Exibir mensagem de sucesso (toast) após login bem-sucedido (AC 2.1.21)
- [x] Task 4: Implementar proteção de rotas admin (AC: 2.1.2, 2.1.11, 2.1.17)
  - [x] Subtask 4.1: Criar middleware ou layout para verificar autenticação em rotas `/admin/*`
  - [x] Subtask 4.2: Implementar verificação de sessão usando `supabase.auth.getSession()`
  - [x] Subtask 4.3: Redirecionar para `/admin/login` se não autenticado (AC 2.1.2)
  - [x] Subtask 4.4: Redirecionar para `/admin/dashboard` se já autenticado ao acessar `/admin/login` (AC 2.1.11)
  - [x] Subtask 4.5: Implementar lógica para preservar URL de destino após login (AC 2.1.17)
  - [x] Subtask 4.6: Redirecionar para URL original após login em rota protegida (AC 2.1.17)
- [x] Task 5: Criar layout padrão do admin (AC: 2.1.5, 2.1.14)
  - [x] Subtask 5.1: Criar layout `app/admin/layout.tsx` para todas as páginas admin
  - [x] Subtask 5.2: Implementar Sidebar conforme wireframe [Source: architecture/frontend-architecture.md#Layout Padrão]
  - [x] Subtask 5.3: Implementar cabeçalho superior com botão "Logout" (AC 2.1.5)
  - [x] Subtask 5.4: Aplicar design responsivo (Sidebar pode ser colapsável em mobile)
- [x] Task 6: Implementar função de Logout (AC: 2.1.5, 2.1.19)
  - [x] Subtask 6.1: Implementar handler para botão "Logout"
  - [x] Subtask 6.2: Chamar `supabase.auth.signOut()` para fazer logout
  - [x] Subtask 6.3: Redirecionar para `/admin/login` após logout
  - [x] Subtask 6.4: Limpar qualquer estado local/sessão se necessário
  - [x] Subtask 6.5: Exibir mensagem de sucesso (toast) após logout (AC 2.1.19)

## Dev Notes

### Previous Story Insights

**Do Épico 1 (Stories 1.1 a 1.5):**
- Supabase Client já configurado em `lib/supabase/client.ts` e `lib/supabase/server.ts`
- Padrão: Server Components do Next.js buscam dados e convertem para objetos simples para passar para Client Components
- Toast implementado com Radix UI Toast para confirmações visuais
- Validação de formulários já estabelecida (Story 1.4)
- Design responsivo mobile-first com TailwindCSS

**Relevante para Story 2.1:**
- Supabase Auth já está disponível via `supabase-js`
- Next.js App Router já configurado
- Padrões de validação e tratamento de erro já estabelecidos podem ser reutilizados
- Esta é a primeira story do Épico 2, então precisa criar estrutura base do admin

### Data Models

Conforme [Source: architecture/fullstack-architecture.md#1]:

**Tabela `profiles`:**
- Campos relevantes: `id` (UUID, relacionado com `auth.users.id`), `email`, `role` (se houver), `created_at`, `updated_at`
- Propósito: Perfil do usuário autenticado (admin ou cliente)
- Nota: Supabase Auth gerencia tabela `auth.users` automaticamente. Tabela `profiles` pode ser criada para dados adicionais.

**Estrutura de Sessão:**
- Supabase Auth gerencia sessão automaticamente via cookies/headers
- Usar `supabase.auth.getSession()` para verificar autenticação
- Usar `supabase.auth.getUser()` para obter dados do usuário autenticado

### API Specifications

**Supabase Auth:**
- Usar `supabase-js` para autenticação conforme [Source: architecture/tech-stack.md]
- Métodos necessários:
  - `supabase.auth.signInWithPassword({ email, password })` - Fazer login
  - `supabase.auth.signOut()` - Fazer logout
  - `supabase.auth.getSession()` - Obter sessão atual
  - `supabase.auth.getUser()` - Obter dados do usuário autenticado
- Não há endpoints REST customizados - usar Supabase Auth diretamente

**Nota:** Configuração de RLS (Row Level Security) é obrigatória conforme AC 2.1.15 e deve ser implementada nesta story.

**Nota sobre criação de usuários admin:** A criação de usuários administradores em produção será feita manualmente via console do Supabase ou através de uma futura Story de "Gerenciamento de Usuários Admin" (AC 2.1.18).

### Component Specifications

Conforme [Source: architecture/frontend-architecture.md#Página 1 (Login)]:

**Estrutura da Página de Login:**
1. **Header:** Título "Painel de Administração" ou similar (opcional)
2. **Formulário de Login:**
   - Campo "Email" (obrigatório, tipo email)
   - Campo "Senha" (obrigatório, tipo password)
   - Botão "Entrar" (desabilitado se inválido)
3. **Mensagens de Erro:** Exibidas abaixo do formulário ou campos específicos
4. **Indicador de Carregamento:** Durante processo de autenticação

**Layout Padrão do Admin (para Story 2.1 e futuras):**
1. **Sidebar (Barra de Navegação Lateral):**
   - Links de navegação para páginas do admin (será populado em stories futuras)
   - Menu colapsável em mobile
2. **Cabeçalho Superior:**
   - Título da página atual ou logo
   - Botão "Logout" no canto superior direito
3. **Área de Conteúdo:** Onde o conteúdo de cada página será renderizado

**Interações:**
- Login: Preencher email/senha → Clicar "Entrar" → Exibir toast de sucesso → Redirecionar para dashboard (ou URL original se houver)
- Logout: Clicar "Logout" → Exibir toast de confirmação → Redirecionar para login
- Proteção de rotas: Acessar página admin sem login → Preservar URL → Redirecionar para login → Após login, redirecionar para URL original
- Validação em tempo real: Digitar nos campos → Validar ao sair do campo ou após alguns caracteres → Exibir mensagens de erro inline se necessário

**Biblioteca de UI:**
- Usar Radix UI para componentes de formulário (se disponível)
- Toast já implementado pode ser reutilizado para mensagens

### File Locations

**Estrutura base do projeto:**
- Páginas:
  - `app/admin/login/page.tsx` (página de login)
  - `app/admin/layout.tsx` (layout padrão do admin)
  - `app/admin/dashboard/page.tsx` (dashboard - será implementado na Story 2.8, mas rota pode ser criada aqui como placeholder)
- Componentes:
  - `src/components/admin/LoginForm.tsx` (formulário de login)
  - `src/components/admin/AdminLayout.tsx` (layout com sidebar e header)
  - `src/components/admin/AdminSidebar.tsx` (barra de navegação lateral)
  - `src/components/admin/AdminHeader.tsx` (cabeçalho superior com logout)
- Middleware/Utils:
  - `src/middleware.ts` (middleware Next.js para proteção de rotas) OU
  - `src/utils/auth.ts` (funções utilitárias de autenticação)
- Hooks:
  - `src/hooks/useAuth.ts` (hook customizado para gerenciar estado de autenticação, se necessário)

**Nota:** Next.js App Router permite usar middleware ou verificação em layouts. Escolher abordagem mais adequada.

### Testing Requirements

**Testes Unitários:**
- Testar validação de email e senha
- Testar função de login (mock do Supabase Auth)
- Testar função de logout
- Testar lógica de redirecionamento

**Testes de Integração:**
- Testar integração com Supabase Auth (login real)
- Testar proteção de rotas (middleware/layout)
- Testar persistência de sessão

**Testes E2E:**
- Testar fluxo completo: acessar página admin → redirecionar para login → fazer login → redirecionar para dashboard
- Testar acesso direto a `/admin/login` quando já logado (redirecionar para dashboard)
- Testar logout: clicar em "Logout" → verificar toast de confirmação → verificar redirecionamento para login
- Testar credenciais inválidas e verificar mensagem de erro
- Testar validação de campos (email inválido, senha muito curta)
- Testar validação em tempo real dos campos de email e senha (AC 2.1.20)
- Testar indicador de carregamento durante login
- Testar erro de rede ao fazer login
- Testar timeout ao autenticar (simular rede lenta) e verificar mensagem de erro após 30 segundos (AC 2.1.16)
- Testar redirecionamento para URL de destino após login (AC 2.1.17)
- Testar mensagem de sucesso (toast) após login (AC 2.1.21)
- Testar mensagem de sucesso (toast) após logout (AC 2.1.19)
- Testar responsividade da página de login
- Testar acessibilidade (navegação por teclado, screen readers)

### Technical Constraints

**Obrigatórios conforme [Source: architecture/tech-stack.md] e [Source: architecture/fullstack-architecture.md#5]:**
- **TypeScript:** Obrigatório para todo o código
- **POO:** Entidades de negócio DEVEM ser Classes TypeScript (mas autenticação pode usar funções utilitárias)
- **Supabase:** Usar Supabase Auth para autenticação
- **Design Responsivo:** Mobile-first conforme [Source: architecture/frontend-architecture.md]

**Mapeamento Entidade-Classe obrigatório:**
- `profiles` → `class User` ou `class Profile` (pode ser criado nesta story ou em story futura)

**Autenticação:**
- Usar Supabase Auth conforme [Source: architecture/fullstack-architecture.md#2]
- Sessão gerenciada automaticamente pelo Supabase Auth
- Verificar autenticação em Server Components ou Middleware do Next.js

**Validações e Regras de Negócio:**

- **Email:** Obrigatório, formato válido de email padrão (ex: `nome@dominio.com`)
- **Senha:** Obrigatório, mínimo 6 caracteres (requisito do Supabase Auth)
- **Validação em Tempo Real:** Validar campos de email/senha em tempo real (ao sair do campo ou após digitar alguns caracteres) e também ao submeter formulário (AC 2.1.20)
- **RLS:** Implementar RLS para garantir segurança dos dados admin (AC 2.1.15)
- **Timeout Autenticação:** Implementar timeout de 30 segundos ao autenticar (AC 2.1.16)
- **Proteção de rotas:** Todas as rotas `/admin/*` (exceto `/admin/login`) devem verificar autenticação
- **Redirecionamento Pós-Login:** Redirecionar para URL original após login em rota protegida (AC 2.1.17). Se não houver URL original, redirecionar para `/admin/dashboard`
- **Logout:** Limpar sessão, exibir toast de confirmação e redirecionar para `/admin/login` (AC 2.1.19)
- **Feedback Login:** Exibir mensagem de sucesso (toast) após login bem-sucedido (AC 2.1.21)
- **Criação Admin:** Mecanismo seguro para criação inicial de admins (AC 2.1.18)

### Project Structure Notes

Esta é a primeira story do Épico 2, então estabelece a estrutura base do painel de administração:
- Todas as páginas admin devem estar em `app/admin/`
- Layout padrão deve ser criado em `app/admin/layout.tsx`
- Componentes específicos do admin devem estar em `src/components/admin/`
- Middleware ou utils de autenticação devem estar em `src/middleware.ts` ou `src/utils/auth.ts`

### Testing

Dev Note: Story Requires the following tests:

- [ ] Jest Unit Tests: (nextToFile: true), coverage requirement: 80%
- [ ] Jest Integration Tests: location: `src/__tests__/integration/admin-auth.test.ts`
- [ ] **NOTA:** E2E tests devem ser manuais conforme padrão do projeto

Manual Test Steps:
- Acessar `/admin/login` e verificar que página de login é exibida (AC 2.1.1)
- Acessar `/admin/dashboard` sem estar logado e verificar redirecionamento para `/admin/login` (AC 2.1.2)
- Acessar `/admin/products` sem estar logado e verificar:
  - Redirecionamento para `/admin/login` com URL preservada (AC 2.1.17)
  - Após login, redirecionamento para `/admin/products` (AC 2.1.17)
- Preencher email e senha válidos e fazer login:
  - Verificar indicador de carregamento durante autenticação (AC 2.1.7)
  - Verificar mensagem de sucesso (toast) após login (AC 2.1.21)
  - Verificar redirecionamento para `/admin/dashboard` após sucesso (AC 2.1.4)
- Testar credenciais inválidas e verificar mensagem de erro apropriada (AC 2.1.6)
- Testar validação de campos:
  - Email inválido e verificar validação em tempo real (AC 2.1.9, 2.1.20)
  - Senha com menos de 6 caracteres e verificar validação em tempo real (AC 2.1.9, 2.1.20)
  - Campos vazios e verificar botão desabilitado (AC 2.1.10)
- Testar erro ao autenticar (simular erro de rede) e verificar mensagem de erro e possibilidade de tentar novamente (AC 2.1.8)
- Testar timeout ao autenticar (simular rede lenta) e verificar mensagem de erro após 30 segundos (AC 2.1.16)
- Fazer login e acessar `/admin/login` novamente, verificar redirecionamento para `/admin/dashboard` (AC 2.1.11)
- Fazer login e verificar layout do admin (Sidebar e Header com Logout) (AC 2.1.14)
- Clicar em "Logout" e verificar:
  - Mensagem de sucesso (toast) após logout (AC 2.1.19)
  - Redirecionamento para `/admin/login` (AC 2.1.5)
  - Tentar acessar página admin após logout e verificar redirecionamento para login
- Testar responsividade da página de login (mobile, tablet, desktop) (AC 2.1.12)
- Testar acessibilidade:
  - Navegação por teclado (Tab para navegar, Enter para submeter) (AC 2.1.13)
  - Screen readers (labels apropriados, mensagens de erro acessíveis) (AC 2.1.13)
- Verificar políticas de RLS no Supabase (AC 2.1.15)

## Dev Agent Record

### Agent Model Used: {{Agent Model Name/Version}}

### Debug Log References

[[LLM: (Dev Agent) If the debug is logged to during the current story progress, create a table with the debug log and the specific task section in the debug log - do not repeat all the details in the story]]

### Completion Notes List

- Tabela `profiles` criada no Supabase com RLS habilitado via migration
- Políticas de RLS implementadas para todas as tabelas admin (store_settings, categories, products, option_groups, options, product_option_links, coupons)
- Trigger automático criado para criar perfil ao criar usuário no auth.users
- Página de login implementada em `/admin/login` com validação em tempo real
- Componente `LoginForm` criado com validação de email e senha, timeout de 30s
- Autenticação com Supabase Auth implementada com verificação de role admin
- Middleware criado para proteção básica de rotas (`middleware.ts`)
- Layout do admin implementado (`app/admin/layout.tsx`) com Sidebar e Header com botão Logout
- Proteção de rotas implementada no layout verificando sessão e role admin
- Verificação de role admin após login para garantir acesso apenas a administradores
- Redirecionamento para URL original após login implementado (via query param `redirect`)
- Função de logout implementada com toast de confirmação
- Documentação de criação de usuários admin criada (`docs/admin-user-creation.md`)
- Todas as entidades POO ajustadas para usar `lib/supabase/client` (compatível com Client e Server Components)
- Todas as tasks concluídas - implementação completa

### Change Log

| Date | Version | Description | Author |
| :--- | :------ | :---------- | :----- |
| 2024 | v1.0 → v2.0 | Aplicadas correções da PO Review (po-review.2.1.md): Adicionados ACs 2.1.15-2.1.21 (RLS, timeout, redirect back, validação em tempo real, feedback visual), melhorado AC 2.1.9, atualizadas tasks/subtasks, atualizadas validações e regras de negócio, expandidos testes E2E e manual test steps | PO Review |
| 2024 | v2.1 | Implementação concluída: autenticação, RLS, página de login, layout admin, proteção de rotas, logout implementados | Dev |

