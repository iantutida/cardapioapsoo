# Story 2.3: Gerenciar Categorias e Produtos (CRUD)

## Status: ‚úÖ 100% Completo - Backend + UI Completa com CRUD Funcional

**√öltima atualiza√ß√£o:** 2024-11-08  
**Atualiza√ß√£o Final:** 2024-11-08 - Modais CRUD implementados

## Story

- As a Gerente de Restaurante
- I want criar, visualizar, editar, excluir e reordenar categorias e produtos no painel de administra√ß√£o
- so that eu possa manter meu card√°pio digital sempre atualizado e organizado

## Acceptance Criteria (ACs)

### Backend & APIs

1. **AC 2.3.1:** Deve existir classe `Category` com m√©todos `static create()`, `static update()`, `static delete()` e `static reorder()` que interagem com a tabela `categories` do Supabase.
2. **AC 2.3.2:** Deve existir classe `Product` com m√©todos `static create()`, `static update()`, `static delete()` e `static reorderWithinCategory()` que interagem com a tabela `products`.
3. **AC 2.3.3:** O m√©todo `Product.create()` deve aceitar upload de foto (PNG/JPG/WebP, m√°ximo 2MB) e salvar no bucket `product-media` com path √∫nico (`products/{productId}/{timestamp}.ext`).
4. **AC 2.3.4:** O m√©todo `Product.update()` deve permitir substituir ou remover foto existente, deletando arquivo antigo do storage.
5. **AC 2.3.5:** Todas opera√ß√µes CRUD devem ter timeout de 30 segundos e registrar logs estruturados com prefixo `admin-products`.
6. **AC 2.3.6:** Devem existir rotas protegidas (role admin) em `/api/admin/categories` (GET, POST, PATCH, DELETE) e `/api/admin/products` (GET, POST, PATCH, DELETE).
7. **AC 2.3.7:** Devem existir rotas `/api/admin/categories/reorder` e `/api/admin/products/reorder` que aceitam array de IDs na ordem desejada.
8. **AC 2.3.8:** Todas rotas de modifica√ß√£o (POST/PATCH/DELETE) devem chamar `revalidatePath('/menu')` ap√≥s sucesso para atualizar p√°gina p√∫blica.
9. **AC 2.3.9:** Valida√ß√µes devem rejeitar: nome vazio, nome > 60 caracteres (categoria), nome > 120 caracteres (produto), pre√ßo negativo ou zero, foto > 2MB ou formato inv√°lido.
10. **AC 2.3.10:** Em caso de erro durante upload, deve haver rollback (deletar arquivo se cria√ß√£o de produto falhar; restaurar arquivo antigo se update falhar).
11. **AC 2.3.11:** Bucket `product-media` deve existir com pol√≠ticas: leitura p√∫blica (anon), upload/update/delete apenas para admins autenticados.

### Frontend

12. **AC 2.3.12:** Deve existir p√°gina `/admin/products` acess√≠vel via link "Produtos & Categorias" na sidebar, protegida por auth admin.
13. **AC 2.3.13:** A p√°gina deve listar todas categorias com contagem de produtos e permitir filtrar produtos por categoria selecionada.
14. **AC 2.3.14:** Cada produto na listagem deve exibir: nome, pre√ßo formatado (R$), status (Ativo/Inativo), preview da foto (ou placeholder "Sem foto").
15. **AC 2.3.15:** A p√°gina deve ter estados de loading (skeleton) e estado vazio (quando n√£o h√° categorias) com CTA para criar primeira categoria.
16. **AC 2.3.16:** Deve exibir toast de feedback em caso de erro ao carregar dados (integra√ß√£o com `Toast` component).

### Infraestrutura

17. **AC 2.3.17:** Deve existir migration SQL criando bucket `product-media` com pol√≠ticas de storage descritas no AC 2.3.11.
18. **AC 2.3.18:** Arquivo `next.config.js` deve permitir imagens de `**.supabase.co/storage/v1/object/public/**` no Next.js `Image` component.

## Tasks / Subtasks

- [x] **Task 1: Atualizar entidades & camada de dados**
  - [x] Subtask 1.1: Estender `Category` com m√©todos `create`, `update`, `delete`, `reorder`
  - [x] Subtask 1.2: Estender `Product` com m√©todos `create`, `update`, `delete`, `reorderWithinCategory`, suporte a upload foto
  - [x] Subtask 1.3: Criar tipos `CreateCategoryPayload`, `UpdateCategoryPayload`, `CreateProductPayload`, `UpdateProductPayload`
  - [x] Subtask 1.4: Adicionar valida√ß√µes com `CategoryValidationError` e `ProductValidationError`
  - [x] Subtask 1.5: Implementar timeout (30s), logs estruturados (`admin-products`), rollback de uploads

- [x] **Task 2: Criar API Routes protegidas**
  - [x] Subtask 2.1: `/api/admin/categories` (GET/POST/PATCH/DELETE) com verifica√ß√£o de role admin
  - [x] Subtask 2.2: `/api/admin/products` (GET/POST/PATCH/DELETE) com suporte a FormData para upload
  - [x] Subtask 2.3: `/api/admin/products/reorder` para ordena√ß√£o por array de IDs
  - [x] Subtask 2.4: `/api/admin/categories/reorder` para ordena√ß√£o de categorias
  - [x] Subtask 2.5: Adicionar `revalidatePath('/menu')` em rotas de modifica√ß√£o
  - [x] Subtask 2.6: Tratamento de erros (RLS, network, storage, timeout)
  - [x] Subtask 2.7: Logs estruturados de sucesso/falha

- [x] **Task 3: UI de Gerenciamento (`/admin/products`)**
  - [x] Subtask 3.1: Atualizar `AdminSidebar` com item "Produtos & Categorias"
  - [x] Subtask 3.2: Criar p√°gina `app/admin/(protected)/products/page.tsx`
  - [x] Subtask 3.3: Implementar listagem de categorias com contagem de produtos
  - [x] Subtask 3.4: Implementar filtro por categoria (bot√µes)
  - [x] Subtask 3.5: Implementar cards de produtos com preview de foto, nome, pre√ßo, status
  - [x] Subtask 3.6: Estados de loading (skeleton) e vazio com CTA
  - [x] Subtask 3.7: Integra√ß√£o com `Toast` para feedback de erros
  - [x] Subtask 3.8: Bot√µes CRUD (stubs com toast "Em desenvolvimento")

- [x] **Task 4: Upload & Storage**
  - [x] Subtask 4.1: Criar migration SQL para bucket `product-media` com pol√≠ticas
  - [x] Subtask 4.2: Implementar upload com nomes √∫nicos (`products/{productId}/{timestamp}.ext`)
  - [x] Subtask 4.3: Implementar remo√ß√£o de imagens antigas ap√≥s upload novo
  - [x] Subtask 4.4: Rollback de uploads em caso de erro (delete de arquivo √≥rf√£o)
  - [x] Subtask 4.5: Atualizar `next.config.js` para permitir imagens Supabase

- [x] **Task 5: Integra√ß√£o com p√°gina p√∫blica**
  - [x] Subtask 5.1: Verificar que `MenuPageContent` j√° consome `Category.getAllActive()` e `Product` corretamente
  - [x] Subtask 5.2: Confirmar que mudan√ßas em categorias/produtos refletem em `/menu` ap√≥s revalida√ß√£o

- [x] **Task 6: Testes**
  - [x] Subtask 6.1: Unit tests para `Category` (m√©todos CRUD, valida√ß√£o)
  - [x] Subtask 6.2: Unit tests para `Product` (m√©todos CRUD, valida√ß√£o, upload)
  - [x] Subtask 6.3: Build passa sem erros TypeScript
  - [x] Subtask 6.4: Documenta√ß√£o atualizada

## Implementa√ß√£o Verificada

### ‚úÖ Backend (100% Completo)

**Entidades POO:**
- `src/domain/entities/Category.ts` - CRUD completo com `create()`, `update()`, `delete()`, `reorder()`, `getAll()`, `getAllActive()`
- `src/domain/entities/Product.ts` - CRUD completo com suporte a upload de fotos, rollback, valida√ß√µes

**APIs REST:**
- `app/api/admin/categories/route.ts` - GET, POST, PATCH, DELETE com auth admin
- `app/api/admin/categories/reorder/route.ts` - Reordena√ß√£o de categorias
- `app/api/admin/products/route.ts` - GET, POST, PATCH, DELETE com FormData para upload
- `app/api/admin/products/reorder/route.ts` - Reordena√ß√£o de produtos

**Valida√ß√µes:**
- `CategoryValidationError` com fieldErrors
- `ProductValidationError` com fieldErrors
- Timeout de 30s em todas opera√ß√µes
- Logs estruturados com prefixo `admin-products`

**Storage:**
- Migration criando bucket `product-media`
- Pol√≠ticas: leitura p√∫blica, escrita admin
- Upload com nomes √∫nicos
- Remo√ß√£o de arquivos antigos
- Rollback em caso de erro

### ‚úÖ Frontend (Funcional)

**UI Implementada:**
- `app/admin/(protected)/products/page.tsx` - P√°gina de gerenciamento
- Link na sidebar "Produtos & Categorias"
- Listagem de categorias com contagem
- Filtro por categoria
- Cards de produtos com preview de foto, nome, pre√ßo formatado, status
- Estados de loading (skeleton) e vazio
- Integra√ß√£o com Toast

**UI Completa (100% Funcional):**
- ‚úÖ Modal de cria√ß√£o/edi√ß√£o de categorias com valida√ß√£o em tempo real
- ‚úÖ Modal de cria√ß√£o/edi√ß√£o de produtos com upload de foto e valida√ß√£o
- ‚úÖ Modal de confirma√ß√£o de exclus√£o
- ‚úÖ Bot√µes "Editar" e "Excluir" totalmente funcionais
- ‚úÖ Preview de fotos com op√ß√£o de remover
- ‚úÖ Integra√ß√£o completa com APIs
- ‚úÖ Feedback visual (loading, erros, sucesso)

**Componentes Criados:**
- `src/components/admin/CategoryModal.tsx` (155 linhas)
- `src/components/admin/ProductModal.tsx` (355 linhas)
- `src/components/admin/DeleteConfirmModal.tsx` (45 linhas - reutilizado da Story 2.4)

### ‚úÖ Testes

**Unit Tests:**
- `src/domain/entities/__tests__/Category.test.ts` - M√©todos da classe Category
- `src/domain/entities/__tests__/Product.test.ts` - M√©todos da classe Product

**Testabilidade:**
- Todas APIs test√°veis via curl/Postman
- CRUD via SQL temporariamente vi√°vel
- Backend desacoplado permite testes independentes

## Dev Notes

### Decis√£o Arquitetural ‚úÖ

**Separar Backend Completo de UI Avan√ßada:**
- ‚úÖ Backend robusto e reutiliz√°vel
- ‚úÖ APIs prontas para consumo por outras features
- ‚úÖ UI de listagem permite visualiza√ß√£o
- ‚úÖ Modais implement√°veis incrementalmente
- ‚úÖ N√£o bloqueia pr√≥ximas stories

### Pr√≥ximas Stories Desbloqueadas

Esta implementa√ß√£o permite:
- ‚úÖ Consumo de categorias/produtos por outras features
- ‚úÖ Relat√≥rios e dashboards podem usar APIs
- ‚úÖ Gest√£o de pedidos pode listar produtos
- ‚úÖ Dados test√°veis via API

### Implementa√ß√£o Futura (Opcional)

Quando necess√°rio:
- E2E tests com Playwright (4-6 horas)
- Drag-and-drop para reordena√ß√£o visual (opcional, APIs prontas)

## Testing

### Manual Test Steps (Via API)

```bash
# Criar categoria
curl -X POST http://localhost:3000/api/admin/categories \
  -H "Cookie: sb-auth-token=..." \
  -H "Content-Type: application/json" \
  -d '{"name": "Bebidas"}'

# Criar produto com foto
curl -X POST http://localhost:3000/api/admin/products \
  -H "Cookie: sb-auth-token=..." \
  -F "name=Coca-Cola 350ml" \
  -F "description=Refrigerante gelado" \
  -F "price=5.5" \
  -F "categoryId=<category-id>" \
  -F "status=Ativo" \
  -F "photo=@/path/to/image.jpg"

# Listar produtos
curl http://localhost:3000/api/admin/products \
  -H "Cookie: sb-auth-token=..."

# Verificar em /menu
curl http://localhost:3000/menu
```

### UI Test Steps

1. Login como admin
2. Acessar `/admin/products`
3. Verificar:
   - ‚úÖ Lista de categorias aparece
   - ‚úÖ Contagem de produtos por categoria correta
   - ‚úÖ Filtro por categoria funciona
   - ‚úÖ Cards de produtos exibem foto (ou placeholder)
   - ‚úÖ Pre√ßo formatado como R$
   - ‚úÖ Badge de status vis√≠vel
   - ‚úÖ Estado vazio aparece quando sem dados
4. Criar dados via API (curl acima)
5. Recarregar p√°gina ‚Üí dados aparecem
6. Acessar `/menu` ‚Üí produtos aparecem na p√°gina p√∫blica

## QA Review

üìÑ **Documento completo:** `docs/stories/qa-review.2.3.md`

**Status QA:** ‚úÖ Aprovado para continuidade

**Justificativa:**
- Backend 100% funcional e test√°vel
- APIs prontas para outras features
- UI permite visualiza√ß√£o
- Stubs n√£o bloqueiam desenvolvimento

**Pr√≥ximo Review:** Ap√≥s implementa√ß√£o dos modais (se necess√°rio)

## Change Log

| Date | Version | Description | Author |
| :--- | :------ | :---------- | :----- |
| 2024 | v1.0 | Story inicial | PO |
| 2024 | v2.0 | Corre√ß√µes da PO Review | PO Review |
| 2024 | v2.1 | Backend completo: entidades POO, APIs CRUD, reordena√ß√£o, upload, migrations | Dev |
| 2024 | v2.2 | UI simplificada: listagem, filtros, estados, integra√ß√£o com backend | Dev |
| 2024-11-08 | v2.3 | QA Review completo: documenta√ß√£o precisa, valida√ß√£o de implementa√ß√£o, aprova√ß√£o para continuidade | QA |
| 2024-11-08 | v3.0 | UI completa implementada: modais CRUD funcionais para categorias e produtos, upload de fotos, valida√ß√µes em tempo real, confirma√ß√£o de exclus√£o | Dev |
